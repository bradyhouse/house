import{u as g,d as R,c as E,k,b as M,a as B,f as et,e as Oe,p as V,r as L,m as tt,a6 as it,l as U,a2 as De,V as nt,t as Ee,M as at,h as rt,Z as st,o as K,w as ot,H as ut,i as lt,aa as dt}from"./vega-util-7f144c9d.js";import{g as ft,i as S,T as c,f as b,s as T,O as q,h as J,r as mt}from"./vega-dataflow-7e3fa937.js";import{n as ct,a as ht,b as pt,F as ke,j as vt,p as qe,m as gt,r as yt,u as xt,v as bt,t as Ot,w as Dt}from"./vega-statistics-100b599b.js";import{T as Et,l as kt,g as qt,f as St,k as Nt,u as Rt,t as Mt}from"./vega-time-a8429f91.js";import{r as Se,e as _t,k as Ct,l as wt,n as Ut,h as At}from"./d3-array-ee3dc224.js";function It(e){return t=>{const i=e.length;let n=1,r=String(e[0](t));for(;n<i;++n)r+="|"+e[n](t);return r}}function W(e){return!e||!e.length?function(){return""}:e.length===1?e[0]:It(e)}function Ne(e,t,i){return i||e+(t?"_"+t:"")}const $=()=>{},Ft={init:$,add:$,rem:$,idx:0},A={values:{init:e=>e.cell.store=!0,value:e=>e.cell.data.values(),idx:-1},count:{value:e=>e.cell.num},__count__:{value:e=>e.missing+e.valid},missing:{value:e=>e.missing},valid:{value:e=>e.valid},sum:{init:e=>e.sum=0,value:e=>e.sum,add:(e,t)=>e.sum+=+t,rem:(e,t)=>e.sum-=t},product:{init:e=>e.product=1,value:e=>e.valid?e.product:void 0,add:(e,t)=>e.product*=t,rem:(e,t)=>e.product/=t},mean:{init:e=>e.mean=0,value:e=>e.valid?e.mean:void 0,add:(e,t)=>(e.mean_d=t-e.mean,e.mean+=e.mean_d/e.valid),rem:(e,t)=>(e.mean_d=t-e.mean,e.mean-=e.valid?e.mean_d/e.valid:e.mean)},average:{value:e=>e.valid?e.mean:void 0,req:["mean"],idx:1},variance:{init:e=>e.dev=0,value:e=>e.valid>1?e.dev/(e.valid-1):void 0,add:(e,t)=>e.dev+=e.mean_d*(t-e.mean),rem:(e,t)=>e.dev-=e.mean_d*(t-e.mean),req:["mean"],idx:1},variancep:{value:e=>e.valid>1?e.dev/e.valid:void 0,req:["variance"],idx:2},stdev:{value:e=>e.valid>1?Math.sqrt(e.dev/(e.valid-1)):void 0,req:["variance"],idx:2},stdevp:{value:e=>e.valid>1?Math.sqrt(e.dev/e.valid):void 0,req:["variance"],idx:2},stderr:{value:e=>e.valid>1?Math.sqrt(e.dev/(e.valid*(e.valid-1))):void 0,req:["variance"],idx:2},distinct:{value:e=>e.cell.data.distinct(e.get),req:["values"],idx:3},ci0:{value:e=>e.cell.data.ci0(e.get),req:["values"],idx:3},ci1:{value:e=>e.cell.data.ci1(e.get),req:["values"],idx:3},median:{value:e=>e.cell.data.q2(e.get),req:["values"],idx:3},q1:{value:e=>e.cell.data.q1(e.get),req:["values"],idx:3},q3:{value:e=>e.cell.data.q3(e.get),req:["values"],idx:3},min:{init:e=>e.min=void 0,value:e=>e.min=Number.isNaN(e.min)?e.cell.data.min(e.get):e.min,add:(e,t)=>{(t<e.min||e.min===void 0)&&(e.min=t)},rem:(e,t)=>{t<=e.min&&(e.min=NaN)},req:["values"],idx:4},max:{init:e=>e.max=void 0,value:e=>e.max=Number.isNaN(e.max)?e.cell.data.max(e.get):e.max,add:(e,t)=>{(t>e.max||e.max===void 0)&&(e.max=t)},rem:(e,t)=>{t>=e.max&&(e.max=NaN)},req:["values"],idx:4},argmin:{init:e=>e.argmin=void 0,value:e=>e.argmin||e.cell.data.argmin(e.get),add:(e,t,i)=>{t<e.min&&(e.argmin=i)},rem:(e,t)=>{t<=e.min&&(e.argmin=void 0)},req:["min","values"],idx:3},argmax:{init:e=>e.argmax=void 0,value:e=>e.argmax||e.cell.data.argmax(e.get),add:(e,t,i)=>{t>e.max&&(e.argmax=i)},rem:(e,t)=>{t>=e.max&&(e.argmax=void 0)},req:["max","values"],idx:3}},F=Object.keys(A).filter(e=>e!=="__count__");function zt(e,t){return i=>Oe({name:e,out:i||e},Ft,t)}[...F,"__count__"].forEach(e=>{A[e]=zt(e,A[e])});function Re(e,t){return A[e](t)}function Me(e,t){return e.idx-t.idx}function Lt(e){const t={};e.forEach(n=>t[n.name]=n);const i=n=>{n.req&&n.req.forEach(r=>{t[r]||i(t[r]=A[r]())})};return e.forEach(i),Object.values(t).sort(Me)}function Tt(){this.valid=0,this.missing=0,this._ops.forEach(e=>e.init(this))}function Pt(e,t){if(e==null||e===""){++this.missing;return}e===e&&(++this.valid,this._ops.forEach(i=>i.add(this,e,t)))}function $t(e,t){if(e==null||e===""){--this.missing;return}e===e&&(--this.valid,this._ops.forEach(i=>i.rem(this,e,t)))}function jt(e){return this._out.forEach(t=>e[t.out]=t.value(this)),e}function _e(e,t){const i=t||Ee,n=Lt(e),r=e.slice().sort(Me);function a(s){this._ops=n,this._out=r,this.cell=s,this.init()}return a.prototype.init=Tt,a.prototype.add=Pt,a.prototype.rem=$t,a.prototype.set=jt,a.prototype.get=i,a.fields=e.map(s=>s.out),a}function Q(e){this._key=e?V(e):b,this.reset()}const D=Q.prototype;D.reset=function(){this._add=[],this._rem=[],this._ext=null,this._get=null,this._q=null};D.add=function(e){this._add.push(e)};D.rem=function(e){this._rem.push(e)};D.values=function(){if(this._get=null,this._rem.length===0)return this._add;const e=this._add,t=this._rem,i=this._key,n=e.length,r=t.length,a=Array(n-r),s={};let o,u,d;for(o=0;o<r;++o)s[i(t[o])]=1;for(o=0,u=0;o<n;++o)s[i(d=e[o])]?s[i(d)]=0:a[u++]=d;return this._rem=[],this._add=a};D.distinct=function(e){const t=this.values(),i={};let n=t.length,r=0,a;for(;--n>=0;)a=e(t[n])+"",L(i,a)||(i[a]=1,++r);return r};D.extent=function(e){if(this._get!==e||!this._ext){const t=this.values(),i=tt(t,e);this._ext=[t[i[0]],t[i[1]]],this._get=e}return this._ext};D.argmin=function(e){return this.extent(e)[0]||{}};D.argmax=function(e){return this.extent(e)[1]||{}};D.min=function(e){const t=this.extent(e)[0];return t!=null?e(t):void 0};D.max=function(e){const t=this.extent(e)[1];return t!=null?e(t):void 0};D.quartile=function(e){return(this._get!==e||!this._q)&&(this._q=ct(this.values(),e),this._get=e),this._q};D.q1=function(e){return this.quartile(e)[0]};D.q2=function(e){return this.quartile(e)[1]};D.q3=function(e){return this.quartile(e)[2]};D.ci=function(e){return(this._get!==e||!this._ci)&&(this._ci=ht(this.values(),1e3,.05,e),this._get=e),this._ci};D.ci0=function(e){return this.ci(e)[0]};D.ci1=function(e){return this.ci(e)[1]};function _(e){c.call(this,null,e),this._adds=[],this._mods=[],this._alen=0,this._mlen=0,this._drop=!0,this._cross=!1,this._dims=[],this._dnames=[],this._measures=[],this._countOnly=!1,this._counts=null,this._prev=null,this._inputs=null,this._outputs=null}_.Definition={type:"Aggregate",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:F},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"drop",type:"boolean",default:!0},{name:"cross",type:"boolean",default:!1},{name:"key",type:"field"}]};g(_,c,{transform(e,t){const i=this,n=t.fork(t.NO_SOURCE|t.NO_FIELDS),r=e.modified();return i.stamp=n.stamp,i.value&&(r||t.modified(i._inputs,!0))?(i._prev=i.value,i.value=r?i.init(e):Object.create(null),t.visit(t.SOURCE,a=>i.add(a))):(i.value=i.value||i.init(e),t.visit(t.REM,a=>i.rem(a)),t.visit(t.ADD,a=>i.add(a))),n.modifies(i._outputs),i._drop=e.drop!==!1,e.cross&&i._dims.length>1&&(i._drop=!1,i.cross()),t.clean()&&i._drop&&n.clean(!0).runAfter(()=>this.clean()),i.changes(n)},cross(){const e=this,t=e.value,i=e._dnames,n=i.map(()=>({})),r=i.length;function a(o){let u,d,l,f;for(u in o)for(l=o[u].tuple,d=0;d<r;++d)n[d][f=l[i[d]]]=f}a(e._prev),a(t);function s(o,u,d){const l=i[d],f=n[d++];for(const m in f){const p=o?o+"|"+m:m;u[l]=f[m],d<r?s(p,u,d):t[p]||e.cell(p,u)}}s("",{},0)},init(e){const t=this._inputs=[],i=this._outputs=[],n={};function r(y){const x=R(M(y)),O=x.length;let N=0,C;for(;N<O;++N)n[C=x[N]]||(n[C]=1,t.push(C))}this._dims=R(e.groupby),this._dnames=this._dims.map(y=>{const x=E(y);return r(y),i.push(x),x}),this.cellkey=e.key?e.key:W(this._dims),this._countOnly=!0,this._counts=[],this._measures=[];const a=e.fields||[null],s=e.ops||["count"],o=e.as||[],u=a.length,d={};let l,f,m,p,h,v;for(u!==s.length&&k("Unmatched number of fields and aggregate ops."),v=0;v<u;++v){if(l=a[v],f=s[v],l==null&&f!=="count"&&k("Null aggregate field specified."),p=E(l),h=Ne(f,p,o[v]),i.push(h),f==="count"){this._counts.push(h);continue}m=d[p],m||(r(l),m=d[p]=[],m.field=l,this._measures.push(m)),f!=="count"&&(this._countOnly=!1),m.push(Re(f,h))}return this._measures=this._measures.map(y=>_e(y,y.field)),Object.create(null)},cellkey:W(),cell(e,t){let i=this.value[e];return i?i.num===0&&this._drop&&i.stamp<this.stamp?(i.stamp=this.stamp,this._adds[this._alen++]=i):i.stamp<this.stamp&&(i.stamp=this.stamp,this._mods[this._mlen++]=i):(i=this.value[e]=this.newcell(e,t),this._adds[this._alen++]=i),i},newcell(e,t){const i={key:e,num:0,agg:null,tuple:this.newtuple(t,this._prev&&this._prev[e]),stamp:this.stamp,store:!1};if(!this._countOnly){const n=this._measures,r=n.length;i.agg=Array(r);for(let a=0;a<r;++a)i.agg[a]=new n[a](i)}return i.store&&(i.data=new Q),i},newtuple(e,t){const i=this._dnames,n=this._dims,r=n.length,a={};for(let s=0;s<r;++s)a[i[s]]=n[s](e);return t?ft(t.tuple,a):S(a)},clean(){const e=this.value;for(const t in e)e[t].num===0&&delete e[t]},add(e){const t=this.cellkey(e),i=this.cell(t,e);if(i.num+=1,this._countOnly)return;i.store&&i.data.add(e);const n=i.agg;for(let r=0,a=n.length;r<a;++r)n[r].add(n[r].get(e),e)},rem(e){const t=this.cellkey(e),i=this.cell(t,e);if(i.num-=1,this._countOnly)return;i.store&&i.data.rem(e);const n=i.agg;for(let r=0,a=n.length;r<a;++r)n[r].rem(n[r].get(e),e)},celltuple(e){const t=e.tuple,i=this._counts;e.store&&e.data.values();for(let n=0,r=i.length;n<r;++n)t[i[n]]=e.num;if(!this._countOnly){const n=e.agg;for(let r=0,a=n.length;r<a;++r)n[r].set(t)}return t},changes(e){const t=this._adds,i=this._mods,n=this._prev,r=this._drop,a=e.add,s=e.rem,o=e.mod;let u,d,l,f;if(n)for(d in n)u=n[d],(!r||u.num)&&s.push(u.tuple);for(l=0,f=this._alen;l<f;++l)a.push(this.celltuple(t[l])),t[l]=null;for(l=0,f=this._mlen;l<f;++l)u=i[l],(u.num===0&&r?s:o).push(this.celltuple(u)),i[l]=null;return this._alen=this._mlen=0,this._prev=null,e}});const Vt=1e-14;function G(e){c.call(this,null,e)}G.Definition={type:"Bin",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"interval",type:"boolean",default:!0},{name:"anchor",type:"number"},{name:"maxbins",type:"number",default:20},{name:"base",type:"number",default:10},{name:"divide",type:"number",array:!0,default:[5,2]},{name:"extent",type:"number",array:!0,length:2,required:!0},{name:"span",type:"number"},{name:"step",type:"number"},{name:"steps",type:"number",array:!0},{name:"minstep",type:"number",default:0},{name:"nice",type:"boolean",default:!0},{name:"name",type:"string"},{name:"as",type:"string",array:!0,length:2,default:["bin0","bin1"]}]};g(G,c,{transform(e,t){const i=e.interval!==!1,n=this._bins(e),r=n.start,a=n.step,s=e.as||["bin0","bin1"],o=s[0],u=s[1];let d;return e.modified()?(t=t.reflow(!0),d=t.SOURCE):d=t.modified(M(e.field))?t.ADD_MOD:t.ADD,t.visit(d,i?l=>{const f=n(l);l[o]=f,l[u]=f==null?null:r+a*(1+(f-r)/a)}:l=>l[o]=n(l)),t.modifies(i?s:o)},_bins(e){if(this.value&&!e.modified())return this.value;const t=e.field,i=pt(e),n=i.step;let r=i.start,a=r+Math.ceil((i.stop-r)/n)*n,s,o;(s=e.anchor)!=null&&(o=s-(r+n*Math.floor((s-r)/n)),r+=o,a+=o);const u=function(d){let l=De(t(d));return l==null?null:l<r?-1/0:l>a?1/0:(l=Math.max(r,Math.min(l,a-n)),r+n*Math.floor(Vt+(l-r)/n))};return u.start=r,u.stop=i.stop,u.step=n,this.value=B(u,M(t),e.name||"bin_"+E(t))}});function Ce(e,t,i){const n=e;let r=t||[],a=i||[],s={},o=0;return{add:u=>a.push(u),remove:u=>s[n(u)]=++o,size:()=>r.length,data:(u,d)=>(o&&(r=r.filter(l=>!s[n(l)]),s={},o=0),d&&u&&r.sort(u),a.length&&(r=u?at(u,r,a.sort(u)):r.concat(a),a=[]),r)}}function H(e){c.call(this,[],e)}H.Definition={type:"Collect",metadata:{source:!0},params:[{name:"sort",type:"compare"}]};g(H,c,{transform(e,t){const i=t.fork(t.ALL),n=Ce(b,this.value,i.materialize(i.ADD).add),r=e.sort,a=t.changed()||r&&(e.modified("sort")||t.modified(r.fields));return i.visit(i.REM,n.remove),this.modified(a),this.value=i.source=n.data(T(r),a),t.source&&t.source.root&&(this.value.root=t.source.root),i}});function we(e){q.call(this,null,Wt,e)}g(we,q);function Wt(e){return this.value&&!e.modified()?this.value:rt(e.fields,e.orders)}function Z(e){c.call(this,null,e)}Z.Definition={type:"CountPattern",metadata:{generates:!0,changes:!0},params:[{name:"field",type:"field",required:!0},{name:"case",type:"enum",values:["upper","lower","mixed"],default:"mixed"},{name:"pattern",type:"string",default:'[\\w"]+'},{name:"stopwords",type:"string",default:""},{name:"as",type:"string",array:!0,length:2,default:["text","count"]}]};function Bt(e,t,i){switch(t){case"upper":e=e.toUpperCase();break;case"lower":e=e.toLowerCase();break}return e.match(i)}g(Z,c,{transform(e,t){const i=f=>m=>{for(var p=Bt(o(m),e.case,a)||[],h,v=0,y=p.length;v<y;++v)s.test(h=p[v])||f(h)},n=this._parameterCheck(e,t),r=this._counts,a=this._match,s=this._stop,o=e.field,u=e.as||["text","count"],d=i(f=>r[f]=1+(r[f]||0)),l=i(f=>r[f]-=1);return n?t.visit(t.SOURCE,d):(t.visit(t.ADD,d),t.visit(t.REM,l)),this._finish(t,u)},_parameterCheck(e,t){let i=!1;return(e.modified("stopwords")||!this._stop)&&(this._stop=new RegExp("^"+(e.stopwords||"")+"$","i"),i=!0),(e.modified("pattern")||!this._match)&&(this._match=new RegExp(e.pattern||"[\\w']+","g"),i=!0),(e.modified("field")||t.modified(e.field.fields))&&(i=!0),i&&(this._counts={}),i},_finish(e,t){const i=this._counts,n=this._tuples||(this._tuples={}),r=t[0],a=t[1],s=e.fork(e.NO_SOURCE|e.NO_FIELDS);let o,u,d;for(o in i)u=n[o],d=i[o]||0,!u&&d?(n[o]=u=S({}),u[r]=o,u[a]=d,s.add.push(u)):d===0?(u&&s.rem.push(u),i[o]=null,n[o]=null):u[a]!==d&&(u[a]=d,s.mod.push(u));return s.modifies(t)}});function X(e){c.call(this,null,e)}X.Definition={type:"Cross",metadata:{generates:!0},params:[{name:"filter",type:"expr"},{name:"as",type:"string",array:!0,length:2,default:["a","b"]}]};g(X,c,{transform(e,t){const i=t.fork(t.NO_SOURCE),n=e.as||["a","b"],r=n[0],a=n[1],s=!this.value||t.changed(t.ADD_REM)||e.modified("as")||e.modified("filter");let o=this.value;return s?(o&&(i.rem=o),o=t.materialize(t.SOURCE).source,i.add=this.value=Kt(o,r,a,e.filter||it)):i.mod=o,i.source=this.value,i.modifies(n)}});function Kt(e,t,i,n){for(var r=[],a={},s=e.length,o=0,u,d;o<s;++o)for(a[t]=d=e[o],u=0;u<s;++u)a[i]=e[u],n(a)&&(r.push(S(a)),a={},a[t]=d);return r}const xe={kde:qe,mixture:xt,normal:bt,lognormal:Ot,uniform:Dt},Jt="distributions",be="function",Qt="field";function Ue(e,t){const i=e[be];L(xe,i)||k("Unknown distribution function: "+i);const n=xe[i]();for(const r in e)r===Qt?n.data((e.from||t()).map(e[r])):r===Jt?n[r](e[r].map(a=>Ue(a,t))):typeof n[r]===be&&n[r](e[r]);return n}function Y(e){c.call(this,null,e)}const Ae=[{key:{function:"normal"},params:[{name:"mean",type:"number",default:0},{name:"stdev",type:"number",default:1}]},{key:{function:"lognormal"},params:[{name:"mean",type:"number",default:0},{name:"stdev",type:"number",default:1}]},{key:{function:"uniform"},params:[{name:"min",type:"number",default:0},{name:"max",type:"number",default:1}]},{key:{function:"kde"},params:[{name:"field",type:"field",required:!0},{name:"from",type:"data"},{name:"bandwidth",type:"number",default:0}]}],Gt={key:{function:"mixture"},params:[{name:"distributions",type:"param",array:!0,params:Ae},{name:"weights",type:"number",array:!0}]};Y.Definition={type:"Density",metadata:{generates:!0},params:[{name:"extent",type:"number",array:!0,length:2},{name:"steps",type:"number"},{name:"minsteps",type:"number",default:25},{name:"maxsteps",type:"number",default:200},{name:"method",type:"string",default:"pdf",values:["pdf","cdf"]},{name:"distribution",type:"param",params:Ae.concat(Gt)},{name:"as",type:"string",array:!0,default:["value","density"]}]};g(Y,c,{transform(e,t){const i=t.fork(t.NO_SOURCE|t.NO_FIELDS);if(!this.value||t.changed()||e.modified()){const n=Ue(e.distribution,Ht(t)),r=e.steps||e.minsteps||25,a=e.steps||e.maxsteps||200;let s=e.method||"pdf";s!=="pdf"&&s!=="cdf"&&k("Invalid density method: "+s),!e.extent&&!n.data&&k("Missing density extent parameter."),s=n[s];const o=e.as||["value","density"],u=e.extent||U(n.data()),d=ke(s,u,r,a).map(l=>{const f={};return f[o[0]]=l[0],f[o[1]]=l[1],S(f)});this.value&&(i.rem=this.value),this.value=i.add=i.source=d}return i}});function Ht(e){return()=>e.materialize(e.SOURCE).source}function Ie(e,t){return e?e.map((i,n)=>t[n]||E(i)):null}function ee(e,t,i){const n=[],r=f=>f(u);let a,s,o,u,d,l;if(t==null)n.push(e.map(i));else for(a={},s=0,o=e.length;s<o;++s)u=e[s],d=t.map(r),l=a[d],l||(a[d]=l=[],l.dims=d,n.push(l)),l.push(i(u));return n}const Fe="bin";function te(e){c.call(this,null,e)}te.Definition={type:"DotBin",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"groupby",type:"field",array:!0},{name:"step",type:"number"},{name:"smooth",type:"boolean",default:!1},{name:"as",type:"string",default:Fe}]};const Zt=(e,t)=>st(U(e,t))/30;g(te,c,{transform(e,t){if(this.value&&!(e.modified()||t.changed()))return t;const i=t.materialize(t.SOURCE).source,n=ee(t.source,e.groupby,Ee),r=e.smooth||!1,a=e.field,s=e.step||Zt(i,a),o=T((h,v)=>a(h)-a(v)),u=e.as||Fe,d=n.length;let l=1/0,f=-1/0,m=0,p;for(;m<d;++m){const h=n[m].sort(o);p=-1;for(const v of vt(h,s,r,a))v<l&&(l=v),v>f&&(f=v),h[++p][u]=v}return this.value={start:l,stop:f,step:s},t.reflow(!0).modifies(u)}});function ze(e){q.call(this,null,Xt,e),this.modified(!0)}g(ze,q);function Xt(e){const t=e.expr;return this.value&&!e.modified("expr")?this.value:B(i=>t(i,e),M(t),E(t))}function ie(e){c.call(this,[void 0,void 0],e)}ie.Definition={type:"Extent",metadata:{},params:[{name:"field",type:"field",required:!0}]};g(ie,c,{transform(e,t){const i=this.value,n=e.field,r=t.changed()||t.modified(n.fields)||e.modified("field");let a=i[0],s=i[1];if((r||a==null)&&(a=1/0,s=-1/0),t.visit(r?t.SOURCE:t.ADD,o=>{const u=De(n(o));u!=null&&(u<a&&(a=u),u>s&&(s=u))}),!Number.isFinite(a)||!Number.isFinite(s)){let o=E(n);o&&(o=` for field "${o}"`),t.dataflow.warn(`Infinite extent${o}: [${a}, ${s}]`),a=s=void 0}this.value=[a,s]}});function ne(e,t){q.call(this,e),this.parent=t,this.count=0}g(ne,q,{connect(e){return this.detachSubflow=e.detachSubflow,this.targets().add(e),e.source=this},add(e){this.count+=1,this.value.add.push(e)},rem(e){this.count-=1,this.value.rem.push(e)},mod(e){this.value.mod.push(e)},init(e){this.value.init(e,e.NO_SOURCE)},evaluate(){return this.value}});function P(e){c.call(this,{},e),this._keys=K();const t=this._targets=[];t.active=0,t.forEach=i=>{for(let n=0,r=t.active;n<r;++n)i(t[n],n,t)}}g(P,c,{activate(e){this._targets[this._targets.active++]=e},subflow(e,t,i,n){const r=this.value;let a=L(r,e)&&r[e],s,o;return a?a.value.stamp<i.stamp&&(a.init(i),this.activate(a)):(o=n||(o=this._group[e])&&o.tuple,s=i.dataflow,a=new ne(i.fork(i.NO_SOURCE),this),s.add(a).connect(t(s,e,o)),r[e]=a,this.activate(a)),a},clean(){const e=this.value;let t=0;for(const i in e)if(e[i].count===0){const n=e[i].detachSubflow;n&&n(),delete e[i],++t}if(t){const i=this._targets.filter(n=>n&&n.count>0);this.initTargets(i)}},initTargets(e){const t=this._targets,i=t.length,n=e?e.length:0;let r=0;for(;r<n;++r)t[r]=e[r];for(;r<i&&t[r]!=null;++r)t[r]=null;t.active=n},transform(e,t){const i=t.dataflow,n=e.key,r=e.subflow,a=this._keys,s=e.modified("key"),o=u=>this.subflow(u,r,t);return this._group=e.group||{},this.initTargets(),t.visit(t.REM,u=>{const d=b(u),l=a.get(d);l!==void 0&&(a.delete(d),o(l).rem(u))}),t.visit(t.ADD,u=>{const d=n(u);a.set(b(u),d),o(d).add(u)}),s||t.modified(n.fields)?t.visit(t.MOD,u=>{const d=b(u),l=a.get(d),f=n(u);l===f?o(f).mod(u):(a.set(d,f),o(l).rem(u),o(f).add(u))}):t.changed(t.MOD)&&t.visit(t.MOD,u=>{o(a.get(b(u))).mod(u)}),s&&t.visit(t.REFLOW,u=>{const d=b(u),l=a.get(d),f=n(u);l!==f&&(a.set(d,f),o(l).rem(u),o(f).add(u))}),t.clean()?i.runAfter(()=>{this.clean(),a.clean()}):a.empty>i.cleanThreshold&&i.runAfter(a.clean),t}});function Le(e){q.call(this,null,Yt,e)}g(Le,q);function Yt(e){return this.value&&!e.modified()?this.value:ot(e.name)?R(e.name).map(t=>V(t)):V(e.name,e.as)}function ae(e){c.call(this,K(),e)}ae.Definition={type:"Filter",metadata:{changes:!0},params:[{name:"expr",type:"expr",required:!0}]};g(ae,c,{transform(e,t){const i=t.dataflow,n=this.value,r=t.fork(),a=r.add,s=r.rem,o=r.mod,u=e.expr;let d=!0;t.visit(t.REM,f=>{const m=b(f);n.has(m)?n.delete(m):s.push(f)}),t.visit(t.ADD,f=>{u(f,e)?a.push(f):n.set(b(f),1)});function l(f){const m=b(f),p=u(f,e),h=n.get(m);p&&h?(n.delete(m),a.push(f)):!p&&!h?(n.set(m,1),s.push(f)):d&&p&&!h&&o.push(f)}return t.visit(t.MOD,l),e.modified()&&(d=!1,t.visit(t.REFLOW,l)),n.empty>i.cleanThreshold&&i.runAfter(n.clean),r}});function re(e){c.call(this,[],e)}re.Definition={type:"Flatten",metadata:{generates:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"index",type:"string"},{name:"as",type:"string",array:!0}]};g(re,c,{transform(e,t){const i=t.fork(t.NO_SOURCE),n=e.fields,r=Ie(n,e.as||[]),a=e.index||null,s=r.length;return i.rem=this.value,t.visit(t.SOURCE,o=>{const u=n.map(h=>h(o)),d=u.reduce((h,v)=>Math.max(h,v.length),0);let l=0,f,m,p;for(;l<d;++l){for(m=J(o),f=0;f<s;++f)m[r[f]]=(p=u[f][l])==null?null:p;a&&(m[a]=l),i.add.push(m)}}),this.value=i.source=i.add,a&&i.modifies(a),i.modifies(r)}});function se(e){c.call(this,[],e)}se.Definition={type:"Fold",metadata:{generates:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0,length:2,default:["key","value"]}]};g(se,c,{transform(e,t){const i=t.fork(t.NO_SOURCE),n=e.fields,r=n.map(E),a=e.as||["key","value"],s=a[0],o=a[1],u=n.length;return i.rem=this.value,t.visit(t.SOURCE,d=>{for(let l=0,f;l<u;++l)f=J(d),f[s]=r[l],f[o]=n[l](d),i.add.push(f)}),this.value=i.source=i.add,i.modifies(a)}});function oe(e){c.call(this,null,e)}oe.Definition={type:"Formula",metadata:{modifies:!0},params:[{name:"expr",type:"expr",required:!0},{name:"as",type:"string",required:!0},{name:"initonly",type:"boolean"}]};g(oe,c,{transform(e,t){const i=e.expr,n=e.as,r=e.modified(),a=e.initonly?t.ADD:r?t.SOURCE:t.modified(i.fields)||t.modified(n)?t.ADD_MOD:t.ADD;return r&&(t=t.materialize().reflow(!0)),e.initonly||t.modifies(n),t.visit(a,s=>s[n]=i(s,e))}});function Te(e){c.call(this,[],e)}g(Te,c,{transform(e,t){const i=t.fork(t.ALL),n=e.generator;let r=this.value,a=e.size-r.length,s,o,u;if(a>0){for(s=[];--a>=0;)s.push(u=S(n(e))),r.push(u);i.add=i.add.length?i.materialize(i.ADD).add.concat(s):s}else o=r.slice(0,-a),i.rem=i.rem.length?i.materialize(i.REM).rem.concat(o):o,r=r.slice(-a);return i.source=this.value=r,i}});const z={value:"value",median:Ct,mean:wt,min:Ut,max:At},ei=[];function ue(e){c.call(this,[],e)}ue.Definition={type:"Impute",metadata:{changes:!0},params:[{name:"field",type:"field",required:!0},{name:"key",type:"field",required:!0},{name:"keyvals",array:!0},{name:"groupby",type:"field",array:!0},{name:"method",type:"enum",default:"value",values:["value","mean","median","max","min"]},{name:"value",default:0}]};function ti(e){var t=e.method||z.value,i;if(z[t]==null)k("Unrecognized imputation method: "+t);else return t===z.value?(i=e.value!==void 0?e.value:0,()=>i):z[t]}function ii(e){const t=e.field;return i=>i?t(i):NaN}g(ue,c,{transform(e,t){var i=t.fork(t.ALL),n=ti(e),r=ii(e),a=E(e.field),s=E(e.key),o=(e.groupby||[]).map(E),u=ni(t.source,e.groupby,e.key,e.keyvals),d=[],l=this.value,f=u.domain.length,m,p,h,v,y,x,O,N,C,w;for(y=0,N=u.length;y<N;++y)for(m=u[y],h=m.values,p=NaN,O=0;O<f;++O)if(m[O]==null){for(v=u.domain[O],w={_impute:!0},x=0,C=h.length;x<C;++x)w[o[x]]=h[x];w[s]=v,w[a]=Number.isNaN(p)?p=n(m,r):p,d.push(S(w))}return d.length&&(i.add=i.materialize(i.ADD).add.concat(d)),l.length&&(i.rem=i.materialize(i.REM).rem.concat(l)),this.value=d,i}});function ni(e,t,i,n){var r=x=>x(y),a=[],s=n?n.slice():[],o={},u={},d,l,f,m,p,h,v,y;for(s.forEach((x,O)=>o[x]=O+1),m=0,v=e.length;m<v;++m)y=e[m],h=i(y),p=o[h]||(o[h]=s.push(h)),l=(d=t?t.map(r):ei)+"",(f=u[l])||(f=u[l]=[],a.push(f),f.values=d),f[p-1]=y;return a.domain=s,a}function le(e){_.call(this,e)}le.Definition={type:"JoinAggregate",metadata:{modifies:!0},params:[{name:"groupby",type:"field",array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"ops",type:"enum",array:!0,values:F},{name:"as",type:"string",null:!0,array:!0},{name:"key",type:"field"}]};g(le,_,{transform(e,t){const i=this,n=e.modified();let r;return i.value&&(n||t.modified(i._inputs,!0))?(r=i.value=n?i.init(e):{},t.visit(t.SOURCE,a=>i.add(a))):(r=i.value=i.value||this.init(e),t.visit(t.REM,a=>i.rem(a)),t.visit(t.ADD,a=>i.add(a))),i.changes(),t.visit(t.SOURCE,a=>{Oe(a,r[i.cellkey(a)].tuple)}),t.reflow(n).modifies(this._outputs)},changes(){const e=this._adds,t=this._mods;let i,n;for(i=0,n=this._alen;i<n;++i)this.celltuple(e[i]),e[i]=null;for(i=0,n=this._mlen;i<n;++i)this.celltuple(t[i]),t[i]=null;this._alen=this._mlen=0}});function de(e){c.call(this,null,e)}de.Definition={type:"KDE",metadata:{generates:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"cumulative",type:"boolean",default:!1},{name:"counts",type:"boolean",default:!1},{name:"bandwidth",type:"number",default:0},{name:"extent",type:"number",array:!0,length:2},{name:"resolve",type:"enum",values:["shared","independent"],default:"independent"},{name:"steps",type:"number"},{name:"minsteps",type:"number",default:25},{name:"maxsteps",type:"number",default:200},{name:"as",type:"string",array:!0,default:["value","density"]}]};g(de,c,{transform(e,t){const i=t.fork(t.NO_SOURCE|t.NO_FIELDS);if(!this.value||t.changed()||e.modified()){const n=t.materialize(t.SOURCE).source,r=ee(n,e.groupby,e.field),a=(e.groupby||[]).map(E),s=e.bandwidth,o=e.cumulative?"cdf":"pdf",u=e.as||["value","density"],d=[];let l=e.extent,f=e.steps||e.minsteps||25,m=e.steps||e.maxsteps||200;o!=="pdf"&&o!=="cdf"&&k("Invalid density method: "+o),e.resolve==="shared"&&(l||(l=U(n,e.field)),f=m=e.steps||m),r.forEach(p=>{const h=qe(p,s)[o],v=e.counts?p.length:1,y=l||U(p);ke(h,y,f,m).forEach(x=>{const O={};for(let N=0;N<a.length;++N)O[a[N]]=p.dims[N];O[u[0]]=x[0],O[u[1]]=x[1]*v,d.push(S(O))})}),this.value&&(i.rem=this.value),this.value=i.add=i.source=d}return i}});function Pe(e){q.call(this,null,ai,e)}g(Pe,q);function ai(e){return this.value&&!e.modified()?this.value:ut(e.fields,e.flat)}function $e(e){c.call(this,[],e),this._pending=null}g($e,c,{transform(e,t){const i=t.dataflow;return this._pending?j(this,t,this._pending):ri(e)?t.StopPropagation:e.values?j(this,t,i.parse(e.values,e.format)):e.async?{async:i.request(e.url,e.format).then(r=>(this._pending=R(r.data),a=>a.touch(this)))}:i.request(e.url,e.format).then(n=>j(this,t,R(n.data)))}});function ri(e){return e.modified("async")&&!(e.modified("values")||e.modified("url")||e.modified("format"))}function j(e,t,i){i.forEach(S);const n=t.fork(t.NO_FIELDS&t.NO_SOURCE);return n.rem=e.value,e.value=n.source=n.add=i,e._pending=null,n.rem.length&&n.clean(!0),n}function fe(e){c.call(this,{},e)}fe.Definition={type:"Lookup",metadata:{modifies:!0},params:[{name:"index",type:"index",params:[{name:"from",type:"data",required:!0},{name:"key",type:"field",required:!0}]},{name:"values",type:"field",array:!0},{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0},{name:"default",default:null}]};g(fe,c,{transform(e,t){const i=e.fields,n=e.index,r=e.values,a=e.default==null?null:e.default,s=e.modified(),o=i.length;let u=s?t.SOURCE:t.ADD,d=t,l=e.as,f,m,p;return r?(m=r.length,o>1&&!l&&k('Multi-field lookup requires explicit "as" parameter.'),l&&l.length!==o*m&&k('The "as" parameter has too few output field names.'),l=l||r.map(E),f=function(h){for(var v=0,y=0,x,O;v<o;++v)if(O=n.get(i[v](h)),O==null)for(x=0;x<m;++x,++y)h[l[y]]=a;else for(x=0;x<m;++x,++y)h[l[y]]=r[x](O)}):(l||k("Missing output field names."),f=function(h){for(var v=0,y;v<o;++v)y=n.get(i[v](h)),h[l[v]]=y??a}),s?d=t.reflow(!0):(p=i.some(h=>t.modified(h.fields)),u|=p?t.MOD:0),t.visit(u,f),d.modifies(l)}});function je(e){q.call(this,null,si,e)}g(je,q);function si(e){if(this.value&&!e.modified())return this.value;const t=e.extents,i=t.length;let n=1/0,r=-1/0,a,s;for(a=0;a<i;++a)s=t[a],s[0]<n&&(n=s[0]),s[1]>r&&(r=s[1]);return[n,r]}function Ve(e){q.call(this,null,oi,e)}g(Ve,q);function oi(e){return this.value&&!e.modified()?this.value:e.values.reduce((t,i)=>t.concat(i),[])}function We(e){c.call(this,null,e)}g(We,c,{transform(e,t){return this.modified(e.modified()),this.value=e,t.fork(t.NO_SOURCE|t.NO_FIELDS)}});function me(e){_.call(this,e)}me.Definition={type:"Pivot",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"value",type:"field",required:!0},{name:"op",type:"enum",values:F,default:"sum"},{name:"limit",type:"number",default:0},{name:"key",type:"field"}]};g(me,_,{_transform:_.prototype.transform,transform(e,t){return this._transform(ui(e,t),t)}});function ui(e,t){const i=e.field,n=e.value,r=(e.op==="count"?"__count__":e.op)||"sum",a=M(i).concat(M(n)),s=di(i,e.limit||0,t);return t.changed()&&e.set("__pivot__",null,null,!0),{key:e.key,groupby:e.groupby,ops:s.map(()=>r),fields:s.map(o=>li(o,i,n,a)),as:s.map(o=>o+""),modified:e.modified.bind(e)}}function li(e,t,i,n){return B(r=>t(r)===e?i(r):NaN,n,e+"")}function di(e,t,i){const n={},r=[];return i.visit(i.SOURCE,a=>{const s=e(a);n[s]||(n[s]=1,r.push(s))}),r.sort(et),t?r.slice(0,t):r}function Be(e){P.call(this,e)}g(Be,P,{transform(e,t){const i=e.subflow,n=e.field,r=a=>this.subflow(b(a),i,t,a);return(e.modified("field")||n&&t.modified(M(n)))&&k("PreFacet does not support field modification."),this.initTargets(),n?(t.visit(t.MOD,a=>{const s=r(a);n(a).forEach(o=>s.mod(o))}),t.visit(t.ADD,a=>{const s=r(a);n(a).forEach(o=>s.add(S(o)))}),t.visit(t.REM,a=>{const s=r(a);n(a).forEach(o=>s.rem(o))})):(t.visit(t.MOD,a=>r(a).mod(a)),t.visit(t.ADD,a=>r(a).add(a)),t.visit(t.REM,a=>r(a).rem(a))),t.clean()&&t.runAfter(()=>this.clean()),t}});function ce(e){c.call(this,null,e)}ce.Definition={type:"Project",metadata:{generates:!0,changes:!0},params:[{name:"fields",type:"field",array:!0},{name:"as",type:"string",null:!0,array:!0}]};g(ce,c,{transform(e,t){const i=t.fork(t.NO_SOURCE),n=e.fields,r=Ie(e.fields,e.as||[]),a=n?(o,u)=>fi(o,u,n,r):mt;let s;return this.value?s=this.value:(t=t.addAll(),s=this.value={}),t.visit(t.REM,o=>{const u=b(o);i.rem.push(s[u]),s[u]=null}),t.visit(t.ADD,o=>{const u=a(o,S({}));s[b(o)]=u,i.add.push(u)}),t.visit(t.MOD,o=>{i.mod.push(a(o,s[b(o)]))}),i}});function fi(e,t,i,n){for(let r=0,a=i.length;r<a;++r)t[n[r]]=i[r](e);return t}function Ke(e){c.call(this,null,e)}g(Ke,c,{transform(e,t){return this.value=e.value,e.modified("value")?t.fork(t.NO_SOURCE|t.NO_FIELDS):t.StopPropagation}});function he(e){c.call(this,null,e)}he.Definition={type:"Quantile",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"probs",type:"number",array:!0},{name:"step",type:"number",default:.01},{name:"as",type:"string",array:!0,default:["prob","value"]}]};const mi=1e-14;g(he,c,{transform(e,t){const i=t.fork(t.NO_SOURCE|t.NO_FIELDS),n=e.as||["prob","value"];if(this.value&&!e.modified()&&!t.changed())return i.source=this.value,i;const r=t.materialize(t.SOURCE).source,a=ee(r,e.groupby,e.field),s=(e.groupby||[]).map(E),o=[],u=e.step||.01,d=e.probs||Se(u/2,1-mi,u),l=d.length;return a.forEach(f=>{const m=gt(f,d);for(let p=0;p<l;++p){const h={};for(let v=0;v<s.length;++v)h[s[v]]=f.dims[v];h[n[0]]=d[p],h[n[1]]=m[p],o.push(S(h))}}),this.value&&(i.rem=this.value),this.value=i.add=i.source=o,i}});function Je(e){c.call(this,null,e)}g(Je,c,{transform(e,t){let i,n;return this.value?n=this.value:(i=t=t.addAll(),n=this.value={}),e.derive&&(i=t.fork(t.NO_SOURCE),t.visit(t.REM,r=>{const a=b(r);i.rem.push(n[a]),n[a]=null}),t.visit(t.ADD,r=>{const a=J(r);n[b(r)]=a,i.add.push(a)}),t.visit(t.MOD,r=>{const a=n[b(r)];for(const s in r)a[s]=r[s],i.modifies(s);i.mod.push(a)})),i}});function pe(e){c.call(this,[],e),this.count=0}pe.Definition={type:"Sample",metadata:{},params:[{name:"size",type:"number",default:1e3}]};g(pe,c,{transform(e,t){const i=t.fork(t.NO_SOURCE),n=e.modified("size"),r=e.size,a=this.value.reduce((l,f)=>(l[b(f)]=1,l),{});let s=this.value,o=this.count,u=0;function d(l){let f,m;s.length<r?s.push(l):(m=~~((o+1)*yt()),m<s.length&&m>=u&&(f=s[m],a[b(f)]&&i.rem.push(f),s[m]=l)),++o}if(t.rem.length&&(t.visit(t.REM,l=>{const f=b(l);a[f]&&(a[f]=-1,i.rem.push(l)),--o}),s=s.filter(l=>a[b(l)]!==-1)),(t.rem.length||n)&&s.length<r&&t.source&&(u=o=s.length,t.visit(t.SOURCE,l=>{a[b(l)]||d(l)}),u=-1),n&&s.length>r){const l=s.length-r;for(let f=0;f<l;++f)a[b(s[f])]=-1,i.rem.push(s[f]);s=s.slice(l)}return t.mod.length&&t.visit(t.MOD,l=>{a[b(l)]&&i.mod.push(l)}),t.add.length&&t.visit(t.ADD,d),(t.add.length||u<0)&&(i.add=s.filter(l=>!a[b(l)])),this.count=o,this.value=i.source=s,i}});function ve(e){c.call(this,null,e)}ve.Definition={type:"Sequence",metadata:{generates:!0,changes:!0},params:[{name:"start",type:"number",required:!0},{name:"stop",type:"number",required:!0},{name:"step",type:"number",default:1},{name:"as",type:"string",default:"data"}]};g(ve,c,{transform(e,t){if(this.value&&!e.modified())return;const i=t.materialize().fork(t.MOD),n=e.as||"data";return i.rem=this.value?t.rem.concat(this.value):t.rem,this.value=Se(e.start,e.stop,e.step||1).map(r=>{const a={};return a[n]=r,S(a)}),i.add=t.add.concat(this.value),i}});function Qe(e){c.call(this,null,e),this.modified(!0)}g(Qe,c,{transform(e,t){return this.value=t.source,t.changed()?t.fork(t.NO_SOURCE|t.NO_FIELDS):t.StopPropagation}});function ge(e){c.call(this,null,e)}const Ge=["unit0","unit1"];ge.Definition={type:"TimeUnit",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"interval",type:"boolean",default:!0},{name:"units",type:"enum",values:Et,array:!0},{name:"step",type:"number",default:1},{name:"maxbins",type:"number",default:40},{name:"extent",type:"date",array:!0},{name:"timezone",type:"enum",default:"local",values:["local","utc"]},{name:"as",type:"string",array:!0,length:2,default:Ge}]};g(ge,c,{transform(e,t){const i=e.field,n=e.interval!==!1,r=e.timezone==="utc",a=this._floor(e,t),s=(r?kt:qt)(a.unit).offset,o=e.as||Ge,u=o[0],d=o[1],l=a.step;let f=a.start||1/0,m=a.stop||-1/0,p=t.ADD;return(e.modified()||t.changed(t.REM)||t.modified(M(i)))&&(t=t.reflow(!0),p=t.SOURCE,f=1/0,m=-1/0),t.visit(p,h=>{const v=i(h);let y,x;v==null?(h[u]=null,n&&(h[d]=null)):(h[u]=y=x=a(v),n&&(h[d]=x=s(y,l)),y<f&&(f=y),x>m&&(m=x))}),a.start=f,a.stop=m,t.modifies(n?o:u)},_floor(e,t){const i=e.timezone==="utc",{units:n,step:r}=e.units?{units:e.units,step:e.step||1}:St({extent:e.extent||U(t.materialize(t.SOURCE).source,e.field),maxbins:e.maxbins}),a=Nt(n),s=this.value||{},o=(i?Rt:Mt)(a,r);return o.unit=nt(a),o.units=a,o.step=r,o.start=s.start,o.stop=s.stop,this.value=o}});function He(e){c.call(this,K(),e)}g(He,c,{transform(e,t){const i=t.dataflow,n=e.field,r=this.value,a=o=>r.set(n(o),o);let s=!0;return e.modified("field")||t.modified(n.fields)?(r.clear(),t.visit(t.SOURCE,a)):t.changed()?(t.visit(t.REM,o=>r.delete(n(o))),t.visit(t.ADD,a)):s=!1,this.modified(s),r.empty>i.cleanThreshold&&i.runAfter(r.clean),t.fork()}});function Ze(e){c.call(this,null,e)}g(Ze,c,{transform(e,t){(!this.value||e.modified("field")||e.modified("sort")||t.changed()||e.sort&&t.modified(e.sort.fields))&&(this.value=(e.sort?t.source.slice().sort(T(e.sort)):t.source).map(e.field))}});function ci(e,t,i,n){const r=I[e](t,i);return{init:r.init||dt,update:function(a,s){s[n]=r.next(a)}}}const I={row_number:function(){return{next:e=>e.index+1}},rank:function(){let e;return{init:()=>e=1,next:t=>{const i=t.index,n=t.data;return i&&t.compare(n[i-1],n[i])?e=i+1:e}}},dense_rank:function(){let e;return{init:()=>e=1,next:t=>{const i=t.index,n=t.data;return i&&t.compare(n[i-1],n[i])?++e:e}}},percent_rank:function(){const e=I.rank(),t=e.next;return{init:e.init,next:i=>(t(i)-1)/(i.data.length-1)}},cume_dist:function(){let e;return{init:()=>e=0,next:t=>{const i=t.data,n=t.compare;let r=t.index;if(e<r){for(;r+1<i.length&&!n(i[r],i[r+1]);)++r;e=r}return(1+e)/i.length}}},ntile:function(e,t){t=+t,t>0||k("ntile num must be greater than zero.");const i=I.cume_dist(),n=i.next;return{init:i.init,next:r=>Math.ceil(t*n(r))}},lag:function(e,t){return t=+t||1,{next:i=>{const n=i.index-t;return n>=0?e(i.data[n]):null}}},lead:function(e,t){return t=+t||1,{next:i=>{const n=i.index+t,r=i.data;return n<r.length?e(r[n]):null}}},first_value:function(e){return{next:t=>e(t.data[t.i0])}},last_value:function(e){return{next:t=>e(t.data[t.i1-1])}},nth_value:function(e,t){return t=+t,t>0||k("nth_value nth must be greater than zero."),{next:i=>{const n=i.i0+(t-1);return n<i.i1?e(i.data[n]):null}}},prev_value:function(e){let t;return{init:()=>t=null,next:i=>{const n=e(i.data[i.index]);return n!=null?t=n:t}}},next_value:function(e){let t,i;return{init:()=>(t=null,i=-1),next:n=>{const r=n.data;return n.index<=i?t:(i=hi(e,r,n.index))<0?(i=r.length,t=null):t=e(r[i])}}}};function hi(e,t,i){for(let n=t.length;i<n;++i)if(e(t[i])!=null)return i;return-1}const pi=Object.keys(I);function Xe(e){const t=R(e.ops),i=R(e.fields),n=R(e.params),r=R(e.as),a=this.outputs=[],s=this.windows=[],o={},u={},d=[],l=[];let f=!0;function m(p){R(M(p)).forEach(h=>o[h]=1)}m(e.sort),t.forEach((p,h)=>{const v=i[h],y=E(v),x=Ne(p,y,r[h]);if(m(v),a.push(x),L(I,p))s.push(ci(p,i[h],n[h],x));else{if(v==null&&p!=="count"&&k("Null aggregate field specified."),p==="count"){d.push(x);return}f=!1;let O=u[y];O||(O=u[y]=[],O.field=v,l.push(O)),O.push(Re(p,x))}}),(d.length||l.length)&&(this.cell=vi(l,d,f)),this.inputs=Object.keys(o)}const Ye=Xe.prototype;Ye.init=function(){this.windows.forEach(e=>e.init()),this.cell&&this.cell.init()};Ye.update=function(e,t){const i=this.cell,n=this.windows,r=e.data,a=n&&n.length;let s;if(i){for(s=e.p0;s<e.i0;++s)i.rem(r[s]);for(s=e.p1;s<e.i1;++s)i.add(r[s]);i.set(t)}for(s=0;s<a;++s)n[s].update(e,t)};function vi(e,t,i){e=e.map(u=>_e(u,u.field));const n={num:0,agg:null,store:!1,count:t};if(!i)for(var r=e.length,a=n.agg=Array(r),s=0;s<r;++s)a[s]=new e[s](n);if(n.store)var o=n.data=new Q;return n.add=function(u){if(n.num+=1,!i){o&&o.add(u);for(let d=0;d<r;++d)a[d].add(a[d].get(u),u)}},n.rem=function(u){if(n.num-=1,!i){o&&o.rem(u);for(let d=0;d<r;++d)a[d].rem(a[d].get(u),u)}},n.set=function(u){let d,l;for(o&&o.values(),d=0,l=t.length;d<l;++d)u[t[d]]=n.num;if(!i)for(d=0,l=a.length;d<l;++d)a[d].set(u)},n.init=function(){n.num=0,o&&o.reset();for(let u=0;u<r;++u)a[u].init()},n}function ye(e){c.call(this,{},e),this._mlen=0,this._mods=[]}ye.Definition={type:"Window",metadata:{modifies:!0},params:[{name:"sort",type:"compare"},{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:pi.concat(F)},{name:"params",type:"number",null:!0,array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"frame",type:"number",null:!0,array:!0,length:2,default:[null,0]},{name:"ignorePeers",type:"boolean",default:!1}]};g(ye,c,{transform(e,t){this.stamp=t.stamp;const i=e.modified(),n=T(e.sort),r=W(e.groupby),a=o=>this.group(r(o));let s=this.state;(!s||i)&&(s=this.state=new Xe(e)),i||t.modified(s.inputs)?(this.value={},t.visit(t.SOURCE,o=>a(o).add(o))):(t.visit(t.REM,o=>a(o).remove(o)),t.visit(t.ADD,o=>a(o).add(o)));for(let o=0,u=this._mlen;o<u;++o)gi(this._mods[o],s,n,e);return this._mlen=0,this._mods=[],t.reflow(i).modifies(s.outputs)},group(e){let t=this.value[e];return t||(t=this.value[e]=Ce(b),t.stamp=-1),t.stamp<this.stamp&&(t.stamp=this.stamp,this._mods[this._mlen++]=t),t}});function gi(e,t,i,n){const r=n.sort,a=r&&!n.ignorePeers,s=n.frame||[null,0],o=e.data(i),u=o.length,d=a?_t(r):null,l={i0:0,i1:0,p0:0,p1:0,index:0,data:o,compare:r||lt(-1)};t.init();for(let f=0;f<u;++f)yi(l,s,f,u),a&&xi(l,d),t.update(l,o[f])}function yi(e,t,i,n){e.p0=e.i0,e.p1=e.i1,e.i0=t[0]==null?0:Math.max(0,i-Math.abs(t[0])),e.i1=t[1]==null?n:Math.min(n,i+Math.abs(t[1])+1),e.index=i}function xi(e,t){const i=e.i0,n=e.i1-1,r=e.compare,a=e.data,s=a.length-1;i>0&&!r(a[i],a[i-1])&&(e.i0=t.left(a,a[i])),n<s&&!r(a[n],a[n+1])&&(e.i1=t.right(a,a[n]))}const qi=Object.freeze(Object.defineProperty({__proto__:null,aggregate:_,bin:G,collect:H,compare:we,countpattern:Z,cross:X,density:Y,dotbin:te,expression:ze,extent:ie,facet:P,field:Le,filter:ae,flatten:re,fold:se,formula:oe,generate:Te,impute:ue,joinaggregate:le,kde:de,key:Pe,load:$e,lookup:fe,multiextent:je,multivalues:Ve,params:We,pivot:me,prefacet:Be,project:ce,proxy:Ke,quantile:he,relay:Je,sample:pe,sequence:ve,sieve:Qe,subflow:ne,timeunit:ge,tupleindex:He,values:Ze,window:ye},Symbol.toStringTag,{value:"Module"}));export{qi as t};
