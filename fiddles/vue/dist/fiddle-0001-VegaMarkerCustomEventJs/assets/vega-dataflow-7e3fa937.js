import{u as et,d as R,k as C,w as A,a8 as P,z as E,a6 as N,t as nt,K as ht,E as ft,r as ct,s as T,j as dt,e as pt,i as j}from"./vega-util-7f144c9d.js";import{r as mt,c as gt,l as _t}from"./vega-loader-c11e76ba.js";import{d as wt}from"./vega-format-43826777.js";function z(t){const e=t||nt,n=[],s={};return n.add=i=>{const r=e(i);return s[r]||(s[r]=1,n.push(i)),n},n.remove=i=>{const r=e(i);if(s[r]){s[r]=0;const u=n.indexOf(i);u>=0&&n.splice(u,1)}return n},n}async function U(t,e){try{await e(t)}catch(n){t.error(n)}}const st=Symbol("vega_id");let kt=1;function ue(t){return!!(t&&d(t))}function d(t){return t[st]}function it(t,e){return t[st]=e,t}function rt(t){const e=t===Object(t)?t:{data:t};return d(e)?e:it(e,kt++)}function ae(t){return vt(t,rt({}))}function vt(t,e){for(const n in t)e[n]=t[n];return e}function he(t,e){return it(e,d(t))}function fe(t,e){return t?e?(n,s)=>t(n,s)||d(e(n))-d(e(s)):(n,s)=>t(n,s)||d(n)-d(s):null}function Ft(t){return t&&t.constructor===K}function K(){const t=[],e=[],n=[],s=[],i=[];let r=null,u=!1;return{constructor:K,insert(o){const h=R(o),a=h.length;for(let f=0;f<a;++f)t.push(h[f]);return this},remove(o){const h=E(o)?s:e,a=R(o),f=a.length;for(let l=0;l<f;++l)h.push(a[l]);return this},modify(o,h,a){const f={field:h,value:j(a)};return E(o)?(f.filter=o,i.push(f)):(f.tuple=o,n.push(f)),this},encode(o,h){return E(o)?i.push({filter:o,field:h}):n.push({tuple:o,field:h}),this},clean(o){return r=o,this},reflow(){return u=!0,this},pulse(o,h){const a={},f={};let l,c,p,y,_,D;for(l=0,c=h.length;l<c;++l)a[d(h[l])]=1;for(l=0,c=e.length;l<c;++l)_=e[l],a[d(_)]=-1;for(l=0,c=s.length;l<c;++l)y=s[l],h.forEach(m=>{y(m)&&(a[d(m)]=-1)});for(l=0,c=t.length;l<c;++l)_=t[l],D=d(_),a[D]?a[D]=1:o.add.push(rt(t[l]));for(l=0,c=h.length;l<c;++l)_=h[l],a[d(_)]<0&&o.rem.push(_);function Y(m,B,G){G?m[B]=G(m):o.encode=B,u||(f[d(m)]=m)}for(l=0,c=n.length;l<c;++l)p=n[l],_=p.tuple,y=p.field,D=a[d(_)],D>0&&(Y(_,y,p.value),o.modifies(y));for(l=0,c=i.length;l<c;++l)p=i[l],y=p.filter,h.forEach(m=>{y(m)&&a[d(m)]>0&&Y(m,p.field,p.value)}),o.modifies(p.field);if(u)o.mod=e.length||s.length?h.filter(m=>a[d(m)]>0):h.slice();else for(D in f)o.mod.push(f[D]);return(r||r==null&&(e.length||s.length))&&o.clean(!0),o}}}const b="_:mod:_";function H(){Object.defineProperty(this,b,{writable:!0,value:{}})}H.prototype={set(t,e,n,s){const i=this,r=i[t],u=i[b];return e!=null&&e>=0?(r[e]!==n||s)&&(r[e]=n,u[e+":"+t]=-1,u[t]=-1):(r!==n||s)&&(i[t]=n,u[t]=A(n)?1+n.length:-1),i},modified(t,e){const n=this[b];if(arguments.length){if(A(t)){for(let s=0;s<t.length;++s)if(n[t[s]])return!0;return!1}}else{for(const s in n)if(n[s])return!0;return!1}return e!=null&&e>=0?e+1<n[t]||!!n[e+":"+t]:!!n[t]},clear(){return this[b]={},this}};let yt=0;const Dt="pulse",Pt=new H,Et=1,Ot=2;function g(t,e,n,s){this.id=++yt,this.value=t,this.stamp=-1,this.rank=-1,this.qrank=-1,this.flags=0,e&&(this._update=e),n&&this.parameters(n,s)}function J(t){return function(e){const n=this.flags;return arguments.length===0?!!(n&t):(this.flags=e?n|t:n&~t,this)}}g.prototype={targets(){return this._targets||(this._targets=z(T))},set(t){return this.value!==t?(this.value=t,1):0},skip:J(Et),modified:J(Ot),parameters(t,e,n){e=e!==!1;const s=this._argval=this._argval||new H,i=this._argops=this._argops||[],r=[];let u,o,h,a;const f=(l,c,p)=>{p instanceof g?(p!==this&&(e&&p.targets().add(this),r.push(p)),i.push({op:p,name:l,index:c})):s.set(l,c,p)};for(u in t)if(o=t[u],u===Dt)R(o).forEach(l=>{l instanceof g?l!==this&&(l.targets().add(this),r.push(l)):C("Pulse parameters must be operator instances.")}),this.source=o;else if(A(o))for(s.set(u,-1,Array(h=o.length)),a=0;a<h;++a)f(u,a,o[a]);else f(u,-1,o);return this.marshall().clear(),n&&(i.initonly=!0),r},marshall(t){const e=this._argval||Pt,n=this._argops;let s,i,r,u;if(n){const o=n.length;for(i=0;i<o;++i)s=n[i],r=s.op,u=r.modified()&&r.stamp===t,e.set(s.name,s.index,r.value,u);if(n.initonly){for(i=0;i<o;++i)s=n[i],s.op.targets().remove(this);this._argops=null,this._update=null}}return e},detach(){const t=this._argops;let e,n,s,i;if(t)for(e=0,n=t.length;e<n;++e)s=t[e],i=s.op,i._targets&&i._targets.remove(this);this.pulse=null,this.source=null},evaluate(t){const e=this._update;if(e){const n=this.marshall(t.stamp),s=e.call(this,n,t);if(n.clear(),s!==this.value)this.value=s;else if(!this.modified())return t.StopPropagation}},run(t){if(t.stamp<this.stamp)return t.StopPropagation;let e;return this.skip()?(this.skip(!1),e=0):e=this.evaluate(t),this.pulse=e||t}};function At(t,e,n,s){let i=1,r;return t instanceof g?r=t:t&&t.prototype instanceof g?r=new t:E(t)?r=new g(null,t):(i=0,r=new g(t,e)),this.rank(r),i&&(s=n,n=e),n&&this.connect(r,r.parameters(n,s)),this.touch(r),r}function Mt(t,e){const n=t.rank,s=e.length;for(let i=0;i<s;++i)if(n<e[i].rank){this.rerank(t);return}}let qt=0;function ot(t,e,n){this.id=++qt,this.value=null,n&&(this.receive=n),t&&(this._filter=t),e&&(this._apply=e)}function v(t,e,n){return new ot(t,e,n)}ot.prototype={_filter:N,_apply:nt,targets(){return this._targets||(this._targets=z(T))},consume(t){return arguments.length?(this._consume=!!t,this):!!this._consume},receive(t){if(this._filter(t)){const e=this.value=this._apply(t),n=this._targets,s=n?n.length:0;for(let i=0;i<s;++i)n[i].receive(e);this._consume&&(t.preventDefault(),t.stopPropagation())}},filter(t){const e=v(t);return this.targets().add(e),e},apply(t){const e=v(null,t);return this.targets().add(e),e},merge(){const t=v();this.targets().add(t);for(let e=0,n=arguments.length;e<n;++e)arguments[e].targets().add(t);return t},throttle(t){let e=-1;return this.filter(()=>{const n=Date.now();return n-e>t?(e=n,1):0})},debounce(t){const e=v();return this.targets().add(v(null,null,dt(t,n=>{const s=n.dataflow;e.receive(n),s&&s.run&&s.run()}))),e},between(t,e){let n=!1;return t.targets().add(v(null,null,()=>n=!0)),e.targets().add(v(null,null,()=>n=!1)),this.filter(()=>n)},detach(){this._filter=N,this._targets=null}};function St(t,e,n,s){const i=this,r=v(n,s),u=function(a){a.dataflow=i;try{r.receive(a)}catch(f){i.error(f)}finally{i.run()}};let o;typeof t=="string"&&typeof document<"u"?o=document.querySelectorAll(t):o=R(t);const h=o.length;for(let a=0;a<h;++a)o[a].addEventListener(e,u);return r}function Lt(t,e){const n=this.locale();return mt(t,e,n.timeParse,n.utcParse)}function bt(t,e,n){return e=this.parse(e,n),this.pulse(t,this.changeset().insert(e))}async function Rt(t,e){const n=this;let s=0,i;try{i=await n.loader().load(t,{context:"dataflow",response:gt(e&&e.type)});try{i=n.parse(i,e)}catch(r){s=-2,n.warn("Data ingestion failed",t,r)}}catch(r){s=-1,n.warn("Loading failed",t,r)}return{data:i,status:s}}async function Ct(t,e,n){const s=this,i=s._pending||It(s);i.requests+=1;const r=await s.request(e,n);return s.pulse(t,s.changeset().remove(N).insert(r.data||[])),i.done(),r}function It(t){let e;const n=new Promise(s=>e=s);return n.requests=0,n.done=()=>{--n.requests===0&&(t._pending=null,e(t))},t._pending=n}const Tt={skip:!0};function zt(t,e,n,s,i){return(t instanceof g?$t:Ut)(this,t,e,n,s,i),this}function Ut(t,e,n,s,i,r){const u=pt({},r,Tt);let o,h;E(n)||(n=j(n)),s===void 0?o=a=>t.touch(n(a)):E(s)?(h=new g(null,s,i,!1),o=a=>{h.evaluate(a);const f=n(a),l=h.value;Ft(l)?t.pulse(f,l,r):t.update(f,l,u)}):o=a=>t.update(n(a),s,u),e.apply(o)}function $t(t,e,n,s,i,r){if(s===void 0)e.targets().add(n);else{const u=r||{},o=new g(null,Nt(n,s),i,!1);o.modified(u.force),o.rank=e.rank,e.targets().add(o),n&&(o.skip(!0),o.value=n.value,o.targets().add(n),t.connect(n,[o]))}}function Nt(t,e){return e=E(e)?e:j(e),t?function(n,s){const i=e(n,s);return t.skip()||(t.skip(i!==this.value).value=i),i}:e}function jt(t){t.rank=++this._rank}function Kt(t){const e=[t];let n,s,i;for(;e.length;)if(this.rank(n=e.pop()),s=n._targets)for(i=s.length;--i>=0;)e.push(n=s[i]),n===t&&C("Cycle detected in dataflow graph.")}const I={},w=1,F=2,k=4,Ht=w|F,Q=w|k,M=w|F|k,V=8,q=16,X=32,Z=64;function O(t,e,n){this.dataflow=t,this.stamp=e??-1,this.add=[],this.rem=[],this.mod=[],this.fields=null,this.encode=n||null}function $(t,e){const n=[];return P(t,e,s=>n.push(s)),n}function x(t,e){const n={};return t.visit(e,s=>{n[d(s)]=1}),s=>n[d(s)]?null:s}function L(t,e){return t?(n,s)=>t(n,s)&&e(n,s):e}O.prototype={StopPropagation:I,ADD:w,REM:F,MOD:k,ADD_REM:Ht,ADD_MOD:Q,ALL:M,REFLOW:V,SOURCE:q,NO_SOURCE:X,NO_FIELDS:Z,fork(t){return new O(this.dataflow).init(this,t)},clone(){const t=this.fork(M);return t.add=t.add.slice(),t.rem=t.rem.slice(),t.mod=t.mod.slice(),t.source&&(t.source=t.source.slice()),t.materialize(M|q)},addAll(){let t=this;return!t.source||t.add===t.rem||!t.rem.length&&t.source.length===t.add.length||(t=new O(this.dataflow).init(this),t.add=t.source,t.rem=[]),t},init(t,e){const n=this;return n.stamp=t.stamp,n.encode=t.encode,t.fields&&!(e&Z)&&(n.fields=t.fields),e&w?(n.addF=t.addF,n.add=t.add):(n.addF=null,n.add=[]),e&F?(n.remF=t.remF,n.rem=t.rem):(n.remF=null,n.rem=[]),e&k?(n.modF=t.modF,n.mod=t.mod):(n.modF=null,n.mod=[]),e&X?(n.srcF=null,n.source=null):(n.srcF=t.srcF,n.source=t.source,t.cleans&&(n.cleans=t.cleans)),n},runAfter(t){this.dataflow.runAfter(t)},changed(t){const e=t||M;return e&w&&this.add.length||e&F&&this.rem.length||e&k&&this.mod.length},reflow(t){if(t)return this.fork(M).reflow();const e=this.add.length,n=this.source&&this.source.length;return n&&n!==e&&(this.mod=this.source,e&&this.filter(k,x(this,w))),this},clean(t){return arguments.length?(this.cleans=!!t,this):this.cleans},modifies(t){const e=this.fields||(this.fields={});return A(t)?t.forEach(n=>e[n]=!0):e[t]=!0,this},modified(t,e){const n=this.fields;return(e||this.mod.length)&&n?arguments.length?A(t)?t.some(s=>n[s]):n[t]:!!n:!1},filter(t,e){const n=this;return t&w&&(n.addF=L(n.addF,e)),t&F&&(n.remF=L(n.remF,e)),t&k&&(n.modF=L(n.modF,e)),t&q&&(n.srcF=L(n.srcF,e)),n},materialize(t){t=t||M;const e=this;return t&w&&e.addF&&(e.add=$(e.add,e.addF),e.addF=null),t&F&&e.remF&&(e.rem=$(e.rem,e.remF),e.remF=null),t&k&&e.modF&&(e.mod=$(e.mod,e.modF),e.modF=null),t&q&&e.srcF&&(e.source=e.source.filter(e.srcF),e.srcF=null),e},visit(t,e){const n=this,s=e;if(t&q)return P(n.source,n.srcF,s),n;t&w&&P(n.add,n.addF,s),t&F&&P(n.rem,n.remF,s),t&k&&P(n.mod,n.modF,s);const i=n.source;if(t&V&&i){const r=n.add.length+n.mod.length;r===i.length||(r?P(i,x(n,Q),s):P(i,n.srcF,s))}return n}};function lt(t,e,n,s){const i=this;let r=0;this.dataflow=t,this.stamp=e,this.fields=null,this.encode=s||null,this.pulses=n;for(const u of n)if(u.stamp===e){if(u.fields){const o=i.fields||(i.fields={});for(const h in u.fields)o[h]=1}u.changed(i.ADD)&&(r|=i.ADD),u.changed(i.REM)&&(r|=i.REM),u.changed(i.MOD)&&(r|=i.MOD)}this.changes=r}et(lt,O,{fork(t){const e=new O(this.dataflow).init(this,t&this.NO_FIELDS);return t!==void 0&&(t&e.ADD&&this.visit(e.ADD,n=>e.add.push(n)),t&e.REM&&this.visit(e.REM,n=>e.rem.push(n)),t&e.MOD&&this.visit(e.MOD,n=>e.mod.push(n))),e},changed(t){return this.changes&t},modified(t){const e=this,n=e.fields;return n&&e.changes&e.MOD?A(t)?t.some(s=>n[s]):n[t]:0},filter(){C("MultiPulse does not support filtering.")},materialize(){C("MultiPulse does not support materialization.")},visit(t,e){const n=this,s=n.pulses,i=s.length;let r=0;if(t&n.SOURCE)for(;r<i;++r)s[r].visit(t,e);else for(;r<i;++r)s[r].stamp===n.stamp&&s[r].visit(t,e);return n}});async function Wt(t,e,n){const s=this,i=[];if(s._pulse)return ut(s);if(s._pending&&await s._pending,e&&await U(s,e),!s._touched.length)return s.debug("Dataflow invoked, but nothing to do."),s;const r=++s._clock;s._pulse=new O(s,r,t),s._touched.forEach(f=>s._enqueue(f,!0)),s._touched=z(T);let u=0,o,h,a;try{for(;s._heap.size()>0;){if(o=s._heap.pop(),o.rank!==o.qrank){s._enqueue(o,!0);continue}h=o.run(s._getPulse(o,t)),h.then?h=await h:h.async&&(i.push(h.async),h=I),h!==I&&o._targets&&o._targets.forEach(f=>s._enqueue(f)),++u}}catch(f){s._heap.clear(),a=f}if(s._input={},s._pulse=null,s.debug(`Pulse ${r}: ${u} operators`),a&&(s._postrun=[],s.error(a)),s._postrun.length){const f=s._postrun.sort((l,c)=>c.priority-l.priority);s._postrun=[];for(let l=0;l<f.length;++l)await U(s,f[l].callback)}return n&&await U(s,n),i.length&&Promise.all(i).then(f=>s.runAsync(null,()=>{f.forEach(l=>{try{l(s)}catch(c){s.error(c)}})})),s}async function Yt(t,e,n){for(;this._running;)await this._running;const s=()=>this._running=null;return(this._running=this.evaluate(t,e,n)).then(s,s),this._running}function Bt(t,e,n){return this._pulse?ut(this):(this.evaluate(t,e,n),this)}function Gt(t,e,n){if(this._pulse||e)this._postrun.push({priority:n||0,callback:t});else try{t(this)}catch(s){this.error(s)}}function ut(t){return t.error("Dataflow already running. Use runAsync() to chain invocations."),t}function Jt(t,e){const n=t.stamp<this._clock;n&&(t.stamp=this._clock),(n||e)&&(t.qrank=t.rank,this._heap.push(t))}function Qt(t,e){const n=t.source,s=this._clock;return n&&A(n)?new lt(this,s,n.map(i=>i.pulse),e):this._input[t.id]||Vt(this._pulse,n&&n.pulse)}function Vt(t,e){return e&&e.stamp===t.stamp?e:(t=t.fork(),e&&e!==I&&(t.source=e.source),t)}const W={skip:!1,force:!1};function Xt(t,e){const n=e||W;return this._pulse?this._enqueue(t):this._touched.add(t),n.skip&&t.skip(!0),this}function Zt(t,e,n){const s=n||W;return(t.set(e)||s.force)&&this.touch(t,s),this}function xt(t,e,n){this.touch(t,n||W);const s=new O(this,this._clock+(this._pulse?0:1)),i=t.pulse&&t.pulse.source||[];return s.target=t,this._input[t.id]=e.pulse(s,i),this}function te(t){let e=[];return{clear:()=>e=[],size:()=>e.length,peek:()=>e[0],push:n=>(e.push(n),at(e,0,e.length-1,t)),pop:()=>{const n=e.pop();let s;return e.length?(s=e[0],e[0]=n,ee(e,0,t)):s=n,s}}}function at(t,e,n,s){let i,r;const u=t[n];for(;n>e;){if(r=n-1>>1,i=t[r],s(u,i)<0){t[n]=i,n=r;continue}break}return t[n]=u}function ee(t,e,n){const s=e,i=t.length,r=t[e];let u=(e<<1)+1,o;for(;u<i;)o=u+1,o<i&&n(t[u],t[o])>=0&&(u=o),t[e]=t[u],e=u,u=(e<<1)+1;return t[e]=r,at(t,s,e,n)}function ne(){this.logger(ht()),this.logLevel(ft),this._clock=0,this._rank=0,this._locale=wt();try{this._loader=_t()}catch{}this._touched=z(T),this._input={},this._pulse=null,this._heap=te((t,e)=>t.qrank-e.qrank),this._postrun=[]}function S(t){return function(){return this._log[t].apply(this,arguments)}}ne.prototype={stamp(){return this._clock},loader(t){return arguments.length?(this._loader=t,this):this._loader},locale(t){return arguments.length?(this._locale=t,this):this._locale},logger(t){return arguments.length?(this._log=t,this):this._log},error:S("error"),warn:S("warn"),info:S("info"),debug:S("debug"),logLevel:S("level"),cleanThreshold:1e4,add:At,connect:Mt,rank:jt,rerank:Kt,pulse:xt,touch:Xt,update:Zt,changeset:K,ingest:bt,parse:Lt,preload:Ct,request:Rt,events:St,on:zt,evaluate:Wt,run:Bt,runAsync:Yt,runAfter:Gt,_enqueue:Jt,_getPulse:Qt};function se(t,e){g.call(this,t,null,e)}et(se,g,{run(t){if(t.stamp<this.stamp)return t.StopPropagation;let e;return this.skip()?this.skip(!1):e=this.evaluate(t),e=e||t,e.then?e=e.then(n=>this.pulse=n):e!==t.StopPropagation&&(this.pulse=e),e},evaluate(t){const e=this.marshall(t.stamp),n=this.transform(e,t);return e.clear(),n},transform(){}});const tt={};function ce(t){const e=ie(t);return e&&e.Definition||null}function ie(t){return t=t&&t.toLowerCase(),ct(tt,t)?tt[t]:null}export{ne as D,ot as E,lt as M,g as O,H as P,se as T,O as a,ue as b,K as c,ce as d,ie as e,d as f,he as g,ae as h,rt as i,U as j,Ft as k,vt as r,fe as s,tt as t};
