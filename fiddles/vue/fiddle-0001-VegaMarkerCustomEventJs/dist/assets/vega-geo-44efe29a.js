import{r as me,i as L,T as x,g as de}from"./vega-dataflow-7e3fa937.js";import{u as w,t as N,w as re,z as M,B as Z,c as he,b as F,p as ye,e as pe,i as U,a3 as ge,k as $,d as q,l as ve,aa as xe,P as Ee}from"./vega-util-7f144c9d.js";import{e as be}from"./vega-statistics-100b599b.js";import{g as ae,a as _,p as ze}from"./vega-projection-280117a9.js";import{d as Se}from"./vega-canvas-6169e3a3.js";import{h as G,t as we,r as De,s as Oe}from"./d3-array-ee3dc224.js";import{r as ee}from"./d3-color-26a9142b.js";import{c as Re}from"./d3-geo-55025d8a.js";function Me(){}const R=[[],[[[1,1.5],[.5,1]]],[[[1.5,1],[1,1.5]]],[[[1.5,1],[.5,1]]],[[[1,.5],[1.5,1]]],[[[1,1.5],[.5,1]],[[1,.5],[1.5,1]]],[[[1,.5],[1,1.5]]],[[[1,.5],[.5,1]]],[[[.5,1],[1,.5]]],[[[1,1.5],[1,.5]]],[[[.5,1],[1,.5]],[[1.5,1],[1,1.5]]],[[[1.5,1],[1,.5]]],[[[.5,1],[1.5,1]]],[[[1,1.5],[1.5,1]]],[[[.5,1],[1,1.5]]],[]];function ie(){var e=1,t=1,n=o;function a(r,c){return c.map(f=>i(r,f))}function i(r,c){var f=[],l=[];return s(r,c,m=>{n(m,r,c),Ce(m)>0?f.push([m]):l.push(m)}),l.forEach(m=>{for(var g=0,h=f.length,p;g<h;++g)if(Pe((p=f[g])[0],m)!==-1){p.push(m);return}}),{type:"MultiPolygon",value:c,coordinates:f}}function s(r,c,f){var l=new Array,m=new Array,g,h,p,d,y,b;for(g=h=-1,d=r[0]>=c,R[d<<1].forEach(z);++g<e-1;)p=d,d=r[g+1]>=c,R[p|d<<1].forEach(z);for(R[d<<0].forEach(z);++h<t-1;){for(g=-1,d=r[h*e+e]>=c,y=r[h*e]>=c,R[d<<1|y<<2].forEach(z);++g<e-1;)p=d,d=r[h*e+e+g+1]>=c,b=y,y=r[h*e+g+1]>=c,R[p|d<<1|y<<2|b<<3].forEach(z);R[d|y<<3].forEach(z)}for(g=-1,y=r[h*e]>=c,R[y<<2].forEach(z);++g<e-1;)b=y,y=r[h*e+g+1]>=c,R[y<<2|b<<3].forEach(z);R[y<<3].forEach(z);function z(E){var D=[E[0][0]+g,E[0][1]+h],O=[E[1][0]+g,E[1][1]+h],j=u(D),A=u(O),v,S;(v=m[j])?(S=l[A])?(delete m[v.end],delete l[S.start],v===S?(v.ring.push(O),f(v.ring)):l[v.start]=m[S.end]={start:v.start,end:S.end,ring:v.ring.concat(S.ring)}):(delete m[v.end],v.ring.push(O),m[v.end=A]=v):(v=l[A])?(S=m[j])?(delete l[v.start],delete m[S.end],v===S?(v.ring.push(O),f(v.ring)):l[S.start]=m[v.end]={start:S.start,end:v.end,ring:S.ring.concat(v.ring)}):(delete l[v.start],v.ring.unshift(D),l[v.start=j]=v):l[j]=m[A]={start:j,end:A,ring:[D,O]}}}function u(r){return r[0]*2+r[1]*(e+1)*4}function o(r,c,f){r.forEach(l=>{var m=l[0],g=l[1],h=m|0,p=g|0,d,y=c[p*e+h];m>0&&m<e&&h===m&&(d=c[p*e+h-1],l[0]=m+(f-d)/(y-d)-.5),g>0&&g<t&&p===g&&(d=c[(p-1)*e+h],l[1]=g+(f-d)/(y-d)-.5)})}return a.contour=i,a.size=function(r){if(!arguments.length)return[e,t];var c=Math.floor(r[0]),f=Math.floor(r[1]);return c>=0&&f>=0||$("invalid size"),e=c,t=f,a},a.smooth=function(r){return arguments.length?(n=r?o:Me,a):n===o},a}function Ce(e){for(var t=0,n=e.length,a=e[n-1][1]*e[0][0]-e[n-1][0]*e[0][1];++t<n;)a+=e[t-1][1]*e[t][0]-e[t-1][0]*e[t][1];return a}function Pe(e,t){for(var n=-1,a=t.length,i;++n<a;)if(i=je(e,t[n]))return i;return 0}function je(e,t){for(var n=t[0],a=t[1],i=-1,s=0,u=e.length,o=u-1;s<u;o=s++){var r=e[s],c=r[0],f=r[1],l=e[o],m=l[0],g=l[1];if(Ae(r,l,t))return 0;f>a!=g>a&&n<(m-c)*(a-f)/(g-f)+c&&(i=-i)}return i}function Ae(e,t,n){var a;return $e(e,t,n)&&Ne(e[a=+(e[0]===t[0])],n[a],t[a])}function $e(e,t,n){return(t[0]-e[0])*(n[1]-e[1])===(n[0]-e[0])*(t[1]-e[1])}function Ne(e,t,n){return e<=t&&t<=n||n<=t&&t<=e}function oe(e,t,n){return function(a){var i=ve(a),s=n?Math.min(i[0],0):i[0],u=i[1],o=u-s,r=t?we(s,u,e):o/(e+1);return De(s+r,u,r)}}function B(e){x.call(this,null,e)}B.Definition={type:"Isocontour",metadata:{generates:!0},params:[{name:"field",type:"field"},{name:"thresholds",type:"number",array:!0},{name:"levels",type:"number"},{name:"nice",type:"boolean",default:!1},{name:"resolve",type:"enum",values:["shared","independent"],default:"independent"},{name:"zero",type:"boolean",default:!0},{name:"smooth",type:"boolean",default:!0},{name:"scale",type:"number",expr:!0},{name:"translate",type:"number",array:!0,expr:!0},{name:"as",type:"string",null:!0,default:"contour"}]};w(B,x,{transform(e,t){if(this.value&&!t.changed()&&!e.modified())return t.StopPropagation;var n=t.fork(t.NO_SOURCE|t.NO_FIELDS),a=t.materialize(t.SOURCE).source,i=e.field||N,s=ie().smooth(e.smooth!==!1),u=e.thresholds||Ue(a,i,e),o=e.as===null?null:e.as||"contour",r=[];return a.forEach(c=>{const f=i(c),l=s.size([f.width,f.height])(f.values,re(u)?u:u(f.values));Fe(l,f,c,e),l.forEach(m=>{r.push(me(c,L(o!=null?{[o]:m}:m)))})}),this.value&&(n.rem=this.value),this.value=n.source=n.add=r,n}});function Ue(e,t,n){const a=oe(n.levels||10,n.nice,n.zero!==!1);return n.resolve!=="shared"?a:a(e.map(i=>G(t(i).values)))}function Fe(e,t,n,a){let i=a.scale||t.scale,s=a.translate||t.translate;if(M(i)&&(i=i(n,a)),M(s)&&(s=s(n,a)),(i===1||i==null)&&!s)return;const u=(Z(i)?i:i[0])||1,o=(Z(i)?i:i[1])||1,r=s&&s[0]||0,c=s&&s[1]||0;e.forEach(se(t,u,o,r,c))}function se(e,t,n,a,i){const s=e.x1||0,u=e.y1||0,o=t*n<0;function r(l){l.forEach(c)}function c(l){o&&l.reverse(),l.forEach(f)}function f(l){l[0]=(l[0]-s)*t+a,l[1]=(l[1]-u)*n+i}return function(l){return l.coordinates.forEach(r),l}}function te(e,t,n){const a=e>=0?e:be(t,n);return Math.round((Math.sqrt(4*a*a+1)-1)/2)}function k(e){return M(e)?e:U(+e)}function ue(){var e=r=>r[0],t=r=>r[1],n=Ee,a=[-1,-1],i=960,s=500,u=2;function o(r,c){const f=te(a[0],r,e)>>u,l=te(a[1],r,t)>>u,m=f?f+2:0,g=l?l+2:0,h=2*m+(i>>u),p=2*g+(s>>u),d=new Float32Array(h*p),y=new Float32Array(h*p);let b=d;r.forEach(E=>{const D=m+(+e(E)>>u),O=g+(+t(E)>>u);D>=0&&D<h&&O>=0&&O<p&&(d[D+O*h]+=+n(E))}),f>0&&l>0?(C(h,p,d,y,f),P(h,p,y,d,l),C(h,p,d,y,f),P(h,p,y,d,l),C(h,p,d,y,f),P(h,p,y,d,l)):f>0?(C(h,p,d,y,f),C(h,p,y,d,f),C(h,p,d,y,f),b=y):l>0&&(P(h,p,d,y,l),P(h,p,y,d,l),P(h,p,d,y,l),b=y);const z=c?Math.pow(2,-2*u):1/Oe(b);for(let E=0,D=h*p;E<D;++E)b[E]*=z;return{values:b,scale:1<<u,width:h,height:p,x1:m,y1:g,x2:m+(i>>u),y2:g+(s>>u)}}return o.x=function(r){return arguments.length?(e=k(r),o):e},o.y=function(r){return arguments.length?(t=k(r),o):t},o.weight=function(r){return arguments.length?(n=k(r),o):n},o.size=function(r){if(!arguments.length)return[i,s];var c=+r[0],f=+r[1];return c>=0&&f>=0||$("invalid size"),i=c,s=f,o},o.cellSize=function(r){return arguments.length?((r=+r)>=1||$("invalid cell size"),u=Math.floor(Math.log(r)/Math.LN2),o):1<<u},o.bandwidth=function(r){return arguments.length?(r=q(r),r.length===1&&(r=[+r[0],+r[0]]),r.length!==2&&$("invalid bandwidth"),a=r,o):a},o}function C(e,t,n,a,i){const s=(i<<1)+1;for(let u=0;u<t;++u)for(let o=0,r=0;o<e+i;++o)o<e&&(r+=n[o+u*e]),o>=i&&(o>=s&&(r-=n[o-s+u*e]),a[o-i+u*e]=r/Math.min(o+1,e-1+s-o,s))}function P(e,t,n,a,i){const s=(i<<1)+1;for(let u=0;u<e;++u)for(let o=0,r=0;o<t+i;++o)o<t&&(r+=n[u+o*e]),o>=i&&(o>=s&&(r-=n[u+(o-s)*e]),a[u+(o-i)*e]=r/Math.min(o+1,t-1+s-o,s))}function J(e){x.call(this,null,e)}J.Definition={type:"KDE2D",metadata:{generates:!0},params:[{name:"size",type:"number",array:!0,length:2,required:!0},{name:"x",type:"field",required:!0},{name:"y",type:"field",required:!0},{name:"weight",type:"field"},{name:"groupby",type:"field",array:!0},{name:"cellSize",type:"number"},{name:"bandwidth",type:"number",array:!0,length:2},{name:"counts",type:"boolean",default:!1},{name:"as",type:"string",default:"grid"}]};const Ge=["x","y","weight","size","cellSize","bandwidth"];function fe(e,t){return Ge.forEach(n=>t[n]!=null?e[n](t[n]):0),e}w(J,x,{transform(e,t){if(this.value&&!t.changed()&&!e.modified())return t.StopPropagation;var n=t.fork(t.NO_SOURCE|t.NO_FIELDS),a=t.materialize(t.SOURCE).source,i=Le(a,e.groupby),s=(e.groupby||[]).map(he),u=fe(ue(),e),o=e.as||"grid",r=[];function c(f,l){for(let m=0;m<s.length;++m)f[s[m]]=l[m];return f}return r=i.map(f=>L(c({[o]:u(f,e.counts)},f.dims))),this.value&&(n.rem=this.value),this.value=n.source=n.add=r,n}});function Le(e,t){var n=[],a=f=>f(o),i,s,u,o,r,c;if(t==null)n.push(e);else for(i={},s=0,u=e.length;s<u;++s)o=e[s],r=t.map(a),c=i[r],c||(i[r]=c=[],c.dims=r,n.push(c)),c.push(o);return n}function T(e){x.call(this,null,e)}T.Definition={type:"Contour",metadata:{generates:!0},params:[{name:"size",type:"number",array:!0,length:2,required:!0},{name:"values",type:"number",array:!0},{name:"x",type:"field"},{name:"y",type:"field"},{name:"weight",type:"field"},{name:"cellSize",type:"number"},{name:"bandwidth",type:"number"},{name:"count",type:"number"},{name:"nice",type:"boolean",default:!1},{name:"thresholds",type:"number",array:!0},{name:"smooth",type:"boolean",default:!0}]};w(T,x,{transform(e,t){if(this.value&&!t.changed()&&!e.modified())return t.StopPropagation;var n=t.fork(t.NO_SOURCE|t.NO_FIELDS),a=ie().smooth(e.smooth!==!1),i=e.values,s=e.thresholds||oe(e.count||10,e.nice,!!i),u=e.size,o,r;return i||(i=t.materialize(t.SOURCE).source,o=fe(ue(),e)(i,!0),r=se(o,o.scale||1,o.scale||1,0,0),u=[o.width,o.height],i=o.values),s=re(s)?s:s(i),i=a.size(u)(i,s),r&&i.forEach(r),this.value&&(n.rem=this.value),this.value=n.source=n.add=(i||[]).map(L),n}});const I="Feature",K="FeatureCollection",ke="MultiPoint";function H(e){x.call(this,null,e)}H.Definition={type:"GeoJSON",metadata:{},params:[{name:"fields",type:"field",array:!0,length:2},{name:"geojson",type:"field"}]};w(H,x,{transform(e,t){var n=this._features,a=this._points,i=e.fields,s=i&&i[0],u=i&&i[1],o=e.geojson||!i&&N,r=t.ADD,c;c=e.modified()||t.changed(t.REM)||t.modified(F(o))||s&&t.modified(F(s))||u&&t.modified(F(u)),(!this.value||c)&&(r=t.SOURCE,this._features=n=[],this._points=a=[]),o&&t.visit(r,f=>n.push(o(f))),s&&u&&(t.visit(r,f=>{var l=s(f),m=u(f);l!=null&&m!=null&&(l=+l)===l&&(m=+m)===m&&a.push([l,m])}),n=n.concat({type:I,geometry:{type:ke,coordinates:a}})),this.value={type:K,features:n}}});function X(e){x.call(this,null,e)}X.Definition={type:"GeoPath",metadata:{modifies:!0},params:[{name:"projection",type:"projection"},{name:"field",type:"field"},{name:"pointRadius",type:"number",expr:!0},{name:"as",type:"string",default:"path"}]};w(X,x,{transform(e,t){var n=t.fork(t.ALL),a=this.value,i=e.field||N,s=e.as||"path",u=n.SOURCE;!a||e.modified()?(this.value=a=ae(e.projection),n.materialize().reflow()):u=i===N||t.modified(i.fields)?n.ADD_MOD:n.ADD;const o=Ie(a,e.pointRadius);return n.visit(u,r=>r[s]=a(i(r))),a.pointRadius(o),n.modifies(s)}});function Ie(e,t){const n=e.pointRadius();return e.context(null),t!=null&&e.pointRadius(t),n}function Y(e){x.call(this,null,e)}Y.Definition={type:"GeoPoint",metadata:{modifies:!0},params:[{name:"projection",type:"projection",required:!0},{name:"fields",type:"field",array:!0,required:!0,length:2},{name:"as",type:"string",array:!0,length:2,default:["x","y"]}]};w(Y,x,{transform(e,t){var n=e.projection,a=e.fields[0],i=e.fields[1],s=e.as||["x","y"],u=s[0],o=s[1],r;function c(f){const l=n([a(f),i(f)]);l?(f[u]=l[0],f[o]=l[1]):(f[u]=void 0,f[o]=void 0)}return e.modified()?t=t.materialize().reflow(!0).visit(t.SOURCE,c):(r=t.modified(a.fields)||t.modified(i.fields),t.visit(r?t.ADD_MOD:t.ADD,c)),t.modifies(s)}});function Q(e){x.call(this,null,e)}Q.Definition={type:"GeoShape",metadata:{modifies:!0,nomod:!0},params:[{name:"projection",type:"projection"},{name:"field",type:"field",default:"datum"},{name:"pointRadius",type:"number",expr:!0},{name:"as",type:"string",default:"shape"}]};w(Q,x,{transform(e,t){var n=t.fork(t.ALL),a=this.value,i=e.as||"shape",s=n.ADD;return(!a||e.modified())&&(this.value=a=qe(ae(e.projection),e.field||ye("datum"),e.pointRadius),n.materialize().reflow(),s=n.SOURCE),n.visit(s,u=>u[i]=a),n.modifies(i)}});function qe(e,t,n){const a=n==null?i=>e(t(i)):i=>{var s=e.pointRadius(),u=e.pointRadius(n)(t(i));return e.pointRadius(s),u};return a.context=i=>(e.context(i),a),a}function V(e){x.call(this,[],e),this.generator=Re()}V.Definition={type:"Graticule",metadata:{changes:!0,generates:!0},params:[{name:"extent",type:"array",array:!0,length:2,content:{type:"number",array:!0,length:2}},{name:"extentMajor",type:"array",array:!0,length:2,content:{type:"number",array:!0,length:2}},{name:"extentMinor",type:"array",array:!0,length:2,content:{type:"number",array:!0,length:2}},{name:"step",type:"number",array:!0,length:2},{name:"stepMajor",type:"number",array:!0,length:2,default:[90,360]},{name:"stepMinor",type:"number",array:!0,length:2,default:[10,10]},{name:"precision",type:"number",default:2.5}]};w(V,x,{transform(e,t){var n=this.value,a=this.generator,i;if(!n.length||e.modified())for(const s in e)M(a[s])&&a[s](e[s]);return i=a(),n.length?t.mod.push(de(n[0],i)):t.add.push(L(i)),n[0]=i,t}});function W(e){x.call(this,null,e)}W.Definition={type:"heatmap",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"color",type:"string",expr:!0},{name:"opacity",type:"number",expr:!0},{name:"resolve",type:"enum",values:["shared","independent"],default:"independent"},{name:"as",type:"string",default:"image"}]};w(W,x,{transform(e,t){if(!t.changed()&&!e.modified())return t.StopPropagation;var n=t.materialize(t.SOURCE).source,a=e.resolve==="shared",i=e.field||N,s=Je(e.opacity,e),u=Be(e.color,e),o=e.as||"image",r={$x:0,$y:0,$value:0,$max:a?G(n.map(c=>G(i(c).values))):0};return n.forEach(c=>{const f=i(c),l=pe({},c,r);a||(l.$max=G(f.values||[])),c[o]=Te(f,l,u.dep?u:U(u(l)),s.dep?s:U(s(l)))}),t.reflow(!0).modifies(o)}});function Be(e,t){let n;return M(e)?(n=a=>ee(e(a,t)),n.dep=le(e)):n=U(ee(e||"#888")),n}function Je(e,t){let n;return M(e)?(n=a=>e(a,t),n.dep=le(e)):e?n=U(e):(n=a=>a.$value/a.$max||0,n.dep=!0),n}function le(e){if(!M(e))return!1;const t=ge(F(e));return t.$x||t.$y||t.$value||t.$max}function Te(e,t,n,a){const i=e.width,s=e.height,u=e.x1||0,o=e.y1||0,r=e.x2||i,c=e.y2||s,f=e.values,l=f?d=>f[d]:xe,m=Se(r-u,c-o),g=m.getContext("2d"),h=g.getImageData(0,0,r-u,c-o),p=h.data;for(let d=o,y=0;d<c;++d){t.$y=d-o;for(let b=u,z=d*i;b<r;++b,y+=4){t.$x=b-u,t.$value=l(b+z);const E=n(t);p[y+0]=E.r,p[y+1]=E.g,p[y+2]=E.b,p[y+3]=~~(255*a(t))}}return g.putImageData(h,0,0),m}function ce(e){x.call(this,null,e),this.modified(!0)}w(ce,x,{transform(e,t){let n=this.value;return!n||e.modified("type")?(this.value=n=He(e.type),_.forEach(a=>{e[a]!=null&&ne(n,a,e[a])})):_.forEach(a=>{e.modified(a)&&ne(n,a,e[a])}),e.pointRadius!=null&&n.path.pointRadius(e.pointRadius),e.fit&&Ke(n,e),t.fork(t.NO_SOURCE|t.NO_FIELDS)}});function Ke(e,t){const n=Xe(t.fit);t.extent?e.fitExtent(t.extent,n):t.size&&e.fitSize(t.size,n)}function He(e){const t=ze((e||"mercator").toLowerCase());return t||$("Unrecognized projection type: "+e),t()}function ne(e,t,n){M(e[t])&&e[t](n)}function Xe(e){return e=q(e),e.length===1?e[0]:{type:K,features:e.reduce((t,n)=>t.concat(Ye(n)),[])}}function Ye(e){return e.type===K?e.features:q(e).filter(t=>t!=null).map(t=>t.type===I?t:{type:I,geometry:t})}const rt=Object.freeze(Object.defineProperty({__proto__:null,contour:T,geojson:H,geopath:X,geopoint:Y,geoshape:Q,graticule:V,heatmap:W,isocontour:B,kde2d:J,projection:ce},Symbol.toStringTag,{value:"Module"}));export{rt as g};
