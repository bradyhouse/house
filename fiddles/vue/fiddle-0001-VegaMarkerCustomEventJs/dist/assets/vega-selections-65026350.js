import{p as P,e as F,d as z,a2 as N,k as M,V as q,r as G,y as A,w as B,v as I}from"./vega-util-7f144c9d.js";import{L as H}from"./vega-expression-6ae7ab31.js";import{a as x}from"./internmap-f6506551.js";function k(e,t){return e==null||t==null?NaN:e<t?-1:e>t?1:e>=t?0:NaN}function J(e,t){return e==null||t==null?NaN:t<e?-1:t>e?1:t>=e?0:NaN}function K(e){let t,i,n;e.length!==2?(t=k,i=(r,u)=>k(e(r),u),n=(r,u)=>e(r)-u):(t=e===k||e===J?e:Q,i=e,n=e);function a(r,u,o=0,l=r.length){if(o<l){if(t(u,u)!==0)return l;do{const c=o+l>>>1;i(r[c],u)<0?o=c+1:l=c}while(o<l)}return o}function f(r,u,o=0,l=r.length){if(o<l){if(t(u,u)!==0)return l;do{const c=o+l>>>1;i(r[c],u)<=0?o=c+1:l=c}while(o<l)}return o}function s(r,u,o=0,l=r.length){const c=a(r,u,o,l-1);return c>o&&n(r[c-1],u)>-n(r[c],u)?c-1:c}return{left:a,center:s,right:f}}function Q(){return 0}function W(e,...t){e=new x(e),t=t.map(Z);e:for(const i of e)for(const n of t)if(!n.has(i)){e.delete(i);continue e}return e}function Z(e){return e instanceof x?e:new x(e)}function b(...e){const t=new x;for(const i of e)for(const n of i)t.add(n);return t}const D="intersect",U="union",ee="vlMulti",te="vlPoint",V="or",ne="and",m="_vgsid_",R=P(m),ie="E",re="R",fe="R-E",se="R-LE",ue="R-RE",T="index:unit";function C(e,t){for(var i=t.fields,n=t.values,a=i.length,f=0,s,r;f<a;++f)if(r=i[f],r.getter=P.getter||P(r.field),s=r.getter(e),A(s)&&(s=N(s)),A(n[f])&&(n[f]=N(n[f])),A(n[f][0])&&(n[f]=n[f].map(N)),r.type===ie){if(B(n[f])?n[f].indexOf(s)<0:s!==n[f])return!1}else if(r.type===re){if(!I(s,n[f]))return!1}else if(r.type===ue){if(!I(s,n[f],!0,!1))return!1}else if(r.type===fe){if(!I(s,n[f],!1,!1))return!1}else if(r.type===se&&!I(s,n[f],!1,!0))return!1;return!0}function me(e,t,i){for(var n=this.context.data[e],a=n?n.values.value:[],f=n?n[T]&&n[T].value:void 0,s=i===D,r=a.length,u=0,o,l,c,g,d;u<r;++u)if(o=a[u],f&&s){if(l=l||{},c=l[g=o.unit]||0,c===-1)continue;if(d=C(t,o),l[g]=d?-1:++c,d&&f.size===1)return!0;if(!d&&c===f.get(g).count)return!1}else if(d=C(t,o),s^d)return d;return r&&s}const S=K(R),oe=S.left,le=S.right;function pe(e,t,i){const n=this.context.data[e],a=n?n.values.value:[],f=n?n[T]&&n[T].value:void 0,s=i===D,r=R(t),u=oe(a,r);if(u===a.length||R(a[u])!==r)return!1;if(f&&s){if(f.size===1)return!0;if(le(a,r)-u<f.size)return!1}return!0}function Ee(e,t){return e.map(i=>F(t.fields?{values:t.fields.map(n=>(n.getter||(n.getter=P(n.field)))(i.datum))}:{[m]:R(i.datum)},t))}function _e(e,t,i,n){for(var a=this.context.data[e],f=a?a.values.value:[],s={},r={},u={},o,l,c,g,d,O,_,E,L,Y,X=f.length,$=0,y,j;$<X;++$)if(o=f[$],g=o.unit,l=o.fields,c=o.values,l&&c){for(y=0,j=l.length;y<j;++y)d=l[y],_=s[d.field]||(s[d.field]={}),E=_[g]||(_[g]=[]),u[d.field]=L=d.type.charAt(0),Y=w[`${L}_union`],_[g]=Y(E,z(c[y]));i&&(E=r[g]||(r[g]=[]),E.push(z(c).reduce((p,h,v)=>(p[l[v].field]=h,p),{})))}else d=m,O=R(o),_=s[d]||(s[d]={}),E=_[g]||(_[g]=[]),E.push(O),i&&(E=r[g]||(r[g]=[]),E.push({[m]:O}));if(t=t||U,s[m]?s[m]=w[`${m}_${t}`](...Object.values(s[m])):Object.keys(s).forEach(p=>{s[p]=Object.keys(s[p]).map(h=>s[p][h]).reduce((h,v)=>h===void 0?v:w[`${u[p]}_${t}`](h,v))}),f=Object.keys(r),i&&f.length){const p=n?te:ee;s[p]=t===U?{[V]:f.reduce((h,v)=>(h.push(...r[v]),h),[])}:{[ne]:f.map(h=>({[V]:r[h]}))}}return s}var w={[`${m}_union`]:b,[`${m}_intersect`]:W,E_union:function(e,t){if(!e.length)return t;for(var i=0,n=t.length;i<n;++i)e.indexOf(t[i])<0&&e.push(t[i]);return e},E_intersect:function(e,t){return e.length?e.filter(i=>t.indexOf(i)>=0):t},R_union:function(e,t){var i=N(t[0]),n=N(t[1]);return i>n&&(i=t[1],n=t[0]),e.length?(e[0]>i&&(e[0]=i),e[1]<n&&(e[1]=n),e):[i,n]},R_intersect:function(e,t){var i=N(t[0]),n=N(t[1]);return i>n&&(i=t[1],n=t[0]),e.length?n<e[0]||e[1]<i?[]:(e[0]<i&&(e[0]=i),e[1]>n&&(e[1]=n),e):[i,n]}};const ce=":",ae="@";function Ne(e,t,i,n){t[0].type!==H&&M("First argument to selection functions must be a string literal.");const a=t[0].value,f=t.length>=2&&q(t).value,s="unit",r=ae+s,u=ce+a;f===D&&!G(n,r)&&(n[r]=i.getData(a).indataRef(i,s)),G(n,u)||(n[u]=i.getData(a).tuplesRef())}export{me as a,pe as b,_e as c,Ee as d,Ne as s};
