"use strict";
var core_1 = require("@angular/core");
var Observable_1 = require("rxjs/Observable");
var board_model_1 = require("./board.model");
var utils_common_1 = require("../../common/utils.common");
require("rxjs/add/operator/map");
require("rxjs/add/operator/share");
var BoardService = (function () {
    function BoardService() {
        var _this = this;
        this.database = null;
        this._board = new board_model_1.Board();
        this.boardChange$ = new Observable_1.Observable(function (observer) { return _this._boardObserver = observer; }).share();
    }
    Object.defineProperty(BoardService.prototype, "board", {
        get: function () {
            return this._board;
        },
        set: function (board) {
            if (this._board.toString() !== board.toString()) {
                this._board = board;
                if (this._boardObserver) {
                    this._boardObserver.next(board);
                }
            }
        },
        enumerable: true,
        configurable: true
    });
    BoardService.prototype.init = function (stateService, model) {
        if (model === void 0) { model = null; }
        var board = new board_model_1.Board(model.rowCount, model.colCount, model.isSolved, model.sequence, model.expectedSequence);
        if (stateService && stateService.databaseService) {
            this.database = stateService.databaseService;
        }
        if (model) {
            board.squares = this.transform(model);
            this.board = board;
        }
    };
    BoardService.prototype.sequence = function (model, expect) {
        if (expect === void 0) { expect = false; }
        var min = 1, rows = model ? model.rowCount : null, cols = model ? model.colCount : null, max = rows && cols ? rows * cols : 0, seq = [];
        if (max > 0) {
            if (!expect) {
                seq = utils_common_1.Utils.generateSequence(min, max, max);
            }
            else {
                seq = utils_common_1.Utils.generateSequentialSequence(min, max);
            }
        }
        return seq;
    };
    BoardService.prototype.transform = function (model) {
        var row = 1, i = 1, pos = 0, rows = model.rowCount, cols = model.colCount, isSolved = model.isSolved, seq = model.sequence, expectedSeq = model.expectedSequence, subSeq = [], expectedSubSeq = [], store = [];
        for (; row <= rows; row++) {
            if (isSolved) {
                subSeq = utils_common_1.Utils.parseSubSequence(expectedSeq, pos, cols);
            }
            else {
                subSeq = utils_common_1.Utils.parseSubSequence(seq, pos, cols);
            }
            expectedSubSeq = utils_common_1.Utils.parseSubSequence(expectedSeq, pos, cols);
            store.push({
                index: i - 1,
                isLast: row === rows ? true : false,
                seq: subSeq,
                expectedSeq: expectedSubSeq
            });
            i++;
            pos += cols;
        }
        return this.transformStore(store);
    };
    BoardService.prototype.transformStore = function (store) {
        var _this = this;
        var squares = [];
        store.forEach(function (row) {
            if (row.seq && row.expectedSeq && row.seq.length === row.expectedSeq.length) {
                row.seq.map(function (num, i) {
                    var colClass = utils_common_1.Utils.mapColClass(num), squareValue = i < (row.seq.length - 1) || (i < row.seq.length && !row.isLast) ? num : null, squareIsEmpty = squareValue ? false : true, squareClass = squareValue ? 'btn ' + colClass : 'btn empty', squareExpectedValue = row.expectedSeq[i], squareId = 'row-' + row.index + '-square-' + squareExpectedValue, squareRow = row.index, squareCol = i, squareOptions = _this.isSquarePersisted(squareId) ?
                        _this.restoreSquareOptions(squareId) :
                        {
                            id: squareId,
                            isEmpty: squareIsEmpty,
                            row: squareRow,
                            col: squareCol,
                            value: String(squareValue),
                            expectedValue: String(squareExpectedValue),
                            cssClass: squareClass
                        };
                    _this.persist(squareOptions);
                    squares.push(squareOptions);
                });
            }
        });
        return squares;
    };
    BoardService.prototype.isSquarePersisted = function (id) {
        var databaseService = this.database;
        if (databaseService) {
            return databaseService.exists(id);
        }
        return false;
    };
    BoardService.prototype.restoreSquareOptions = function (id) {
        var databaseService = this.database, squareState = null;
        if (databaseService) {
            squareState = databaseService.pull(id);
        }
        return squareState;
    };
    BoardService.prototype.unPersist = function () {
        var databaseService = this.database;
        if (databaseService) {
            databaseService.zero('row');
        }
    };
    BoardService.prototype.persist = function (options) {
        var databaseService = this.database;
        if (databaseService) {
            databaseService.push(options.id, options);
        }
    };
    return BoardService;
}());
BoardService = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [])
], BoardService);
exports.BoardService = BoardService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm9hcmQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJvYXJkLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHNDQUEyQztBQUMzQyw4Q0FBNkM7QUFHN0MsNkNBQXNDO0FBR3RDLDBEQUFrRDtBQUlsRCxpQ0FBK0I7QUFDL0IsbUNBQWlDO0FBSWpDLElBQWEsWUFBWTtJQXNCdkI7UUFBQSxpQkFNQztRQUxDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxtQkFBSyxFQUFFLENBQUM7UUFDMUIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLHVCQUFVLENBQ2hDLFVBQUMsUUFBYSxJQUFLLE9BQUEsS0FBSSxDQUFDLGNBQWMsR0FBRyxRQUFRLEVBQTlCLENBQThCLENBQ2xELENBQUMsS0FBSyxFQUFFLENBQUM7SUFDWixDQUFDO0lBbkJELHNCQUFJLCtCQUFLO2FBU1Q7WUFDRSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztRQUNyQixDQUFDO2FBWEQsVUFBVSxLQUFZO1lBQ3BCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLEtBQUssS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDaEQsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUM7Z0JBQ3BCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO29CQUN4QixJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDbEMsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDOzs7T0FBQTtJQWNELDJCQUFJLEdBQUosVUFBSyxZQUFtQyxFQUFFLEtBQW1CO1FBQW5CLHNCQUFBLEVBQUEsWUFBbUI7UUFDM0QsSUFBSSxLQUFLLEdBQVUsSUFBSSxtQkFBSyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFFckgsRUFBRSxDQUFDLENBQUMsWUFBWSxJQUFJLFlBQVksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO1lBQ2pELElBQUksQ0FBQyxRQUFRLEdBQUcsWUFBWSxDQUFDLGVBQWUsQ0FBQztRQUMvQyxDQUFDO1FBQ0QsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNWLEtBQUssQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN0QyxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNyQixDQUFDO0lBQ0gsQ0FBQztJQUVELCtCQUFRLEdBQVIsVUFBUyxLQUFZLEVBQUUsTUFBdUI7UUFBdkIsdUJBQUEsRUFBQSxjQUF1QjtRQUM1QyxJQUFJLEdBQUcsR0FBVyxDQUFDLEVBQ2pCLElBQUksR0FBVyxLQUFLLEdBQUcsS0FBSyxDQUFDLFFBQVEsR0FBRyxJQUFJLEVBQzVDLElBQUksR0FBVyxLQUFLLEdBQUcsS0FBSyxDQUFDLFFBQVEsR0FBRyxJQUFJLEVBQzVDLEdBQUcsR0FBVyxJQUFJLElBQUksSUFBSSxHQUFHLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxFQUM1QyxHQUFHLEdBQWEsRUFBRSxDQUFDO1FBRXJCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ1osRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUNaLEdBQUcsR0FBRyxvQkFBSyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDOUMsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLEdBQUcsR0FBRyxvQkFBSyxDQUFDLDBCQUEwQixDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUNuRCxDQUFDO1FBQ0gsQ0FBQztRQUVELE1BQU0sQ0FBQyxHQUFHLENBQUM7SUFFYixDQUFDO0lBRUQsZ0NBQVMsR0FBVCxVQUFVLEtBQVk7UUFDcEIsSUFBSSxHQUFHLEdBQVcsQ0FBQyxFQUNqQixDQUFDLEdBQVcsQ0FBQyxFQUNiLEdBQUcsR0FBVyxDQUFDLEVBQ2YsSUFBSSxHQUFXLEtBQUssQ0FBQyxRQUFRLEVBQzdCLElBQUksR0FBVyxLQUFLLENBQUMsUUFBUSxFQUM3QixRQUFRLEdBQVksS0FBSyxDQUFDLFFBQVEsRUFDbEMsR0FBRyxHQUFhLEtBQUssQ0FBQyxRQUFRLEVBQzlCLFdBQVcsR0FBYSxLQUFLLENBQUMsZ0JBQWdCLEVBQzlDLE1BQU0sR0FBYSxFQUFFLEVBQ3JCLGNBQWMsR0FBYSxFQUFFLEVBQzdCLEtBQUssR0FBVSxFQUFFLENBQUM7UUFFcEIsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLElBQUksSUFBSSxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUM7WUFDMUIsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztnQkFDYixNQUFNLEdBQUcsb0JBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzFELENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixNQUFNLEdBQUcsb0JBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQ2xELENBQUM7WUFDRCxjQUFjLEdBQUcsb0JBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBRWhFLEtBQUssQ0FBQyxJQUFJLENBQU07Z0JBQ2QsS0FBSyxFQUFFLENBQUMsR0FBRyxDQUFDO2dCQUNaLE1BQU0sRUFBRSxHQUFHLEtBQUssSUFBSSxHQUFHLElBQUksR0FBRyxLQUFLO2dCQUNuQyxHQUFHLEVBQUUsTUFBTTtnQkFDWCxXQUFXLEVBQUUsY0FBYzthQUM1QixDQUFDLENBQUM7WUFDSCxDQUFDLEVBQUUsQ0FBQztZQUNKLEdBQUcsSUFBSSxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELHFDQUFjLEdBQWQsVUFBZSxLQUFZO1FBQTNCLGlCQStCQztRQTlCQyxJQUFJLE9BQU8sR0FBYSxFQUFFLENBQUM7UUFDM0IsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFDLEdBQVE7WUFDckIsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsV0FBVyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxLQUFLLEdBQUcsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDNUUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBQyxHQUFHLEVBQUUsQ0FBQztvQkFDakIsSUFBSSxRQUFRLEdBQVcsb0JBQUssQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQzNDLFdBQVcsR0FBVyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxHQUFHLEdBQUcsSUFBSSxFQUNsRyxhQUFhLEdBQVksV0FBVyxHQUFHLEtBQUssR0FBRyxJQUFJLEVBQ25ELFdBQVcsR0FBVyxXQUFXLEdBQUcsTUFBTSxHQUFHLFFBQVEsR0FBRyxXQUFXLEVBQ25FLG1CQUFtQixHQUFXLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQ2hELFFBQVEsR0FBVyxNQUFNLEdBQUcsR0FBRyxDQUFDLEtBQUssR0FBRyxVQUFVLEdBQUcsbUJBQW1CLEVBQ3hFLFNBQVMsR0FBVyxHQUFHLENBQUMsS0FBSyxFQUM3QixTQUFTLEdBQVcsQ0FBQyxFQUNyQixhQUFhLEdBQVcsS0FBSSxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQzt3QkFDdEQsS0FBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsQ0FBQzt3QkFDM0I7NEJBQ04sRUFBRSxFQUFFLFFBQVE7NEJBQ1osT0FBTyxFQUFFLGFBQWE7NEJBQ3RCLEdBQUcsRUFBRSxTQUFTOzRCQUNkLEdBQUcsRUFBRSxTQUFTOzRCQUNkLEtBQUssRUFBRSxNQUFNLENBQUMsV0FBVyxDQUFDOzRCQUMxQixhQUFhLEVBQUUsTUFBTSxDQUFDLG1CQUFtQixDQUFDOzRCQUMxQyxRQUFRLEVBQUUsV0FBVzt5QkFDdEIsQ0FBQztvQkFFTixLQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO29CQUM1QixPQUFPLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO2dCQUM5QixDQUFDLENBQUMsQ0FBQztZQUNMLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE1BQU0sQ0FBQyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVELHdDQUFpQixHQUFqQixVQUFrQixFQUFVO1FBQzFCLElBQUksZUFBZSxHQUE2QixJQUFJLENBQUMsUUFBUSxDQUFDO1FBQzlELEVBQUUsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7WUFDcEIsTUFBTSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDcEMsQ0FBQztRQUNELE1BQU0sQ0FBQyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQsMkNBQW9CLEdBQXBCLFVBQXFCLEVBQVU7UUFDN0IsSUFBSSxlQUFlLEdBQTZCLElBQUksQ0FBQyxRQUFRLEVBQzNELFdBQVcsR0FBVyxJQUFJLENBQUM7UUFDN0IsRUFBRSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztZQUNwQixXQUFXLEdBQUcsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN6QyxDQUFDO1FBQ0QsTUFBTSxDQUFDLFdBQVcsQ0FBQztJQUNyQixDQUFDO0lBRUQsZ0NBQVMsR0FBVDtRQUNFLElBQUksZUFBZSxHQUE2QixJQUFJLENBQUMsUUFBUSxDQUFDO1FBRTlELEVBQUUsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7WUFDcEIsZUFBZSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM5QixDQUFDO0lBQ0gsQ0FBQztJQUVELDhCQUFPLEdBQVAsVUFBUSxPQUFlO1FBQ3JCLElBQUksZUFBZSxHQUE2QixJQUFJLENBQUMsUUFBUSxDQUFDO1FBRTlELEVBQUUsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7WUFDcEIsZUFBZSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzVDLENBQUM7SUFDSCxDQUFDO0lBR0gsbUJBQUM7QUFBRCxDQUFDLEFBbEtELElBa0tDO0FBbEtZLFlBQVk7SUFEeEIsaUJBQVUsRUFBRTs7R0FDQSxZQUFZLENBa0t4QjtBQWxLWSxvQ0FBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzL09ic2VydmFibGUnO1xuaW1wb3J0IHsgT2JzZXJ2ZXIgfSBmcm9tICdyeGpzL09ic2VydmVyJztcblxuaW1wb3J0IHsgQm9hcmQgfSBmcm9tICcuL2JvYXJkLm1vZGVsJztcbmltcG9ydCB7IFJvdyB9IGZyb20gJy4vcm93Lm1vZGVsJztcbmltcG9ydCB7IFNxdWFyZSB9IGZyb20gJy4vc3F1YXJlLm1vZGVsJztcbmltcG9ydCB7IFV0aWxzIH0gZnJvbSAnLi4vLi4vY29tbW9uL3V0aWxzLmNvbW1vbic7XG5pbXBvcnQgeyBTdGF0ZVNlcnZpY2VJbnRlcmZhY2UgfSBmcm9tICcuLi9zdGF0ZS9zdGF0ZS1zZXJ2aWNlLmludGVyZmFjZSc7XG5pbXBvcnQgeyBEYXRhYmFzZVNlcnZpY2VJbnRlcmZhY2UgfSBmcm9tICcuLi9kYXRhYmFzZS9kYXRhYmFzZS1zZXJ2aWNlLmludGVyZmFjZSc7XG5cbmltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvbWFwJztcbmltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3Ivc2hhcmUnO1xuXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBCb2FyZFNlcnZpY2Uge1xuXG4gIGJvYXJkQ2hhbmdlJDogT2JzZXJ2YWJsZTxCb2FyZD47XG5cbiAgcHJpdmF0ZSBfYm9hcmQ6IEJvYXJkO1xuICBwcml2YXRlIF9ib2FyZE9ic2VydmVyOiBPYnNlcnZlcjxCb2FyZD47XG5cbiAgZGF0YWJhc2U6IERhdGFiYXNlU2VydmljZUludGVyZmFjZTtcblxuICBzZXQgYm9hcmQoYm9hcmQ6IEJvYXJkKSB7XG4gICAgaWYgKHRoaXMuX2JvYXJkLnRvU3RyaW5nKCkgIT09IGJvYXJkLnRvU3RyaW5nKCkpIHtcbiAgICAgIHRoaXMuX2JvYXJkID0gYm9hcmQ7XG4gICAgICBpZiAodGhpcy5fYm9hcmRPYnNlcnZlcikge1xuICAgICAgICB0aGlzLl9ib2FyZE9ic2VydmVyLm5leHQoYm9hcmQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGdldCBib2FyZCgpOiBCb2FyZCB7XG4gICAgcmV0dXJuIHRoaXMuX2JvYXJkO1xuICB9XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5kYXRhYmFzZSA9IG51bGw7XG4gICAgdGhpcy5fYm9hcmQgPSBuZXcgQm9hcmQoKTtcbiAgICB0aGlzLmJvYXJkQ2hhbmdlJCA9IG5ldyBPYnNlcnZhYmxlPEJvYXJkPihcbiAgICAgIChvYnNlcnZlcjogYW55KSA9PiB0aGlzLl9ib2FyZE9ic2VydmVyID0gb2JzZXJ2ZXJcbiAgICApLnNoYXJlKCk7XG4gIH1cblxuICBpbml0KHN0YXRlU2VydmljZTogU3RhdGVTZXJ2aWNlSW50ZXJmYWNlLCBtb2RlbDogQm9hcmQgPSBudWxsKSB7XG4gICAgbGV0IGJvYXJkOiBCb2FyZCA9IG5ldyBCb2FyZChtb2RlbC5yb3dDb3VudCwgbW9kZWwuY29sQ291bnQsIG1vZGVsLmlzU29sdmVkLCBtb2RlbC5zZXF1ZW5jZSwgbW9kZWwuZXhwZWN0ZWRTZXF1ZW5jZSk7XG5cbiAgICBpZiAoc3RhdGVTZXJ2aWNlICYmIHN0YXRlU2VydmljZS5kYXRhYmFzZVNlcnZpY2UpIHtcbiAgICAgIHRoaXMuZGF0YWJhc2UgPSBzdGF0ZVNlcnZpY2UuZGF0YWJhc2VTZXJ2aWNlO1xuICAgIH1cbiAgICBpZiAobW9kZWwpIHtcbiAgICAgIGJvYXJkLnNxdWFyZXMgPSB0aGlzLnRyYW5zZm9ybShtb2RlbCk7XG4gICAgICB0aGlzLmJvYXJkID0gYm9hcmQ7XG4gICAgfVxuICB9XG5cbiAgc2VxdWVuY2UobW9kZWw6IEJvYXJkLCBleHBlY3Q6IGJvb2xlYW4gPSBmYWxzZSk6IG51bWJlcltdIHtcbiAgICBsZXQgbWluOiBudW1iZXIgPSAxLFxuICAgICAgcm93czogbnVtYmVyID0gbW9kZWwgPyBtb2RlbC5yb3dDb3VudCA6IG51bGwsXG4gICAgICBjb2xzOiBudW1iZXIgPSBtb2RlbCA/IG1vZGVsLmNvbENvdW50IDogbnVsbCxcbiAgICAgIG1heDogbnVtYmVyID0gcm93cyAmJiBjb2xzID8gcm93cyAqIGNvbHMgOiAwLFxuICAgICAgc2VxOiBudW1iZXJbXSA9IFtdO1xuXG4gICAgaWYgKG1heCA+IDApIHtcbiAgICAgIGlmICghZXhwZWN0KSB7XG4gICAgICAgIHNlcSA9IFV0aWxzLmdlbmVyYXRlU2VxdWVuY2UobWluLCBtYXgsIG1heCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzZXEgPSBVdGlscy5nZW5lcmF0ZVNlcXVlbnRpYWxTZXF1ZW5jZShtaW4sIG1heCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHNlcTtcblxuICB9XG5cbiAgdHJhbnNmb3JtKG1vZGVsOiBCb2FyZCk6IFNxdWFyZVtdIHtcbiAgICBsZXQgcm93OiBudW1iZXIgPSAxLFxuICAgICAgaTogbnVtYmVyID0gMSxcbiAgICAgIHBvczogbnVtYmVyID0gMCxcbiAgICAgIHJvd3M6IG51bWJlciA9IG1vZGVsLnJvd0NvdW50LFxuICAgICAgY29sczogbnVtYmVyID0gbW9kZWwuY29sQ291bnQsXG4gICAgICBpc1NvbHZlZDogYm9vbGVhbiA9IG1vZGVsLmlzU29sdmVkLFxuICAgICAgc2VxOiBudW1iZXJbXSA9IG1vZGVsLnNlcXVlbmNlLFxuICAgICAgZXhwZWN0ZWRTZXE6IG51bWJlcltdID0gbW9kZWwuZXhwZWN0ZWRTZXF1ZW5jZSxcbiAgICAgIHN1YlNlcTogbnVtYmVyW10gPSBbXSxcbiAgICAgIGV4cGVjdGVkU3ViU2VxOiBudW1iZXJbXSA9IFtdLFxuICAgICAgc3RvcmU6IFJvd1tdID0gW107XG5cbiAgICBmb3IgKDsgcm93IDw9IHJvd3M7IHJvdysrKSB7XG4gICAgICBpZiAoaXNTb2x2ZWQpIHtcbiAgICAgICAgc3ViU2VxID0gVXRpbHMucGFyc2VTdWJTZXF1ZW5jZShleHBlY3RlZFNlcSwgcG9zLCBjb2xzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN1YlNlcSA9IFV0aWxzLnBhcnNlU3ViU2VxdWVuY2Uoc2VxLCBwb3MsIGNvbHMpO1xuICAgICAgfVxuICAgICAgZXhwZWN0ZWRTdWJTZXEgPSBVdGlscy5wYXJzZVN1YlNlcXVlbmNlKGV4cGVjdGVkU2VxLCBwb3MsIGNvbHMpO1xuXG4gICAgICBzdG9yZS5wdXNoKDxSb3c+e1xuICAgICAgICBpbmRleDogaSAtIDEsXG4gICAgICAgIGlzTGFzdDogcm93ID09PSByb3dzID8gdHJ1ZSA6IGZhbHNlLFxuICAgICAgICBzZXE6IHN1YlNlcSxcbiAgICAgICAgZXhwZWN0ZWRTZXE6IGV4cGVjdGVkU3ViU2VxXG4gICAgICB9KTtcbiAgICAgIGkrKztcbiAgICAgIHBvcyArPSBjb2xzO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnRyYW5zZm9ybVN0b3JlKHN0b3JlKTtcbiAgfVxuXG4gIHRyYW5zZm9ybVN0b3JlKHN0b3JlOiBSb3dbXSk6IFNxdWFyZVtdIHtcbiAgICBsZXQgc3F1YXJlczogU3F1YXJlW10gPSBbXTtcbiAgICBzdG9yZS5mb3JFYWNoKChyb3c6IFJvdykgPT4ge1xuICAgICAgaWYgKHJvdy5zZXEgJiYgcm93LmV4cGVjdGVkU2VxICYmIHJvdy5zZXEubGVuZ3RoID09PSByb3cuZXhwZWN0ZWRTZXEubGVuZ3RoKSB7XG4gICAgICAgIHJvdy5zZXEubWFwKChudW0sIGkpID0+IHtcbiAgICAgICAgICBsZXQgY29sQ2xhc3M6IHN0cmluZyA9IFV0aWxzLm1hcENvbENsYXNzKG51bSksXG4gICAgICAgICAgICBzcXVhcmVWYWx1ZTogbnVtYmVyID0gaSA8IChyb3cuc2VxLmxlbmd0aCAtIDEpIHx8IChpIDwgcm93LnNlcS5sZW5ndGggJiYgIXJvdy5pc0xhc3QpID8gbnVtIDogbnVsbCxcbiAgICAgICAgICAgIHNxdWFyZUlzRW1wdHk6IGJvb2xlYW4gPSBzcXVhcmVWYWx1ZSA/IGZhbHNlIDogdHJ1ZSxcbiAgICAgICAgICAgIHNxdWFyZUNsYXNzOiBzdHJpbmcgPSBzcXVhcmVWYWx1ZSA/ICdidG4gJyArIGNvbENsYXNzIDogJ2J0biBlbXB0eScsXG4gICAgICAgICAgICBzcXVhcmVFeHBlY3RlZFZhbHVlOiBudW1iZXIgPSByb3cuZXhwZWN0ZWRTZXFbaV0sXG4gICAgICAgICAgICBzcXVhcmVJZDogc3RyaW5nID0gJ3Jvdy0nICsgcm93LmluZGV4ICsgJy1zcXVhcmUtJyArIHNxdWFyZUV4cGVjdGVkVmFsdWUsXG4gICAgICAgICAgICBzcXVhcmVSb3c6IG51bWJlciA9IHJvdy5pbmRleCxcbiAgICAgICAgICAgIHNxdWFyZUNvbDogbnVtYmVyID0gaSxcbiAgICAgICAgICAgIHNxdWFyZU9wdGlvbnM6IFNxdWFyZSA9IHRoaXMuaXNTcXVhcmVQZXJzaXN0ZWQoc3F1YXJlSWQpID9cbiAgICAgICAgICAgICAgdGhpcy5yZXN0b3JlU3F1YXJlT3B0aW9ucyhzcXVhcmVJZCkgOlxuICAgICAgICAgICAgICA8U3F1YXJlPntcbiAgICAgICAgICAgICAgICBpZDogc3F1YXJlSWQsXG4gICAgICAgICAgICAgICAgaXNFbXB0eTogc3F1YXJlSXNFbXB0eSxcbiAgICAgICAgICAgICAgICByb3c6IHNxdWFyZVJvdyxcbiAgICAgICAgICAgICAgICBjb2w6IHNxdWFyZUNvbCxcbiAgICAgICAgICAgICAgICB2YWx1ZTogU3RyaW5nKHNxdWFyZVZhbHVlKSxcbiAgICAgICAgICAgICAgICBleHBlY3RlZFZhbHVlOiBTdHJpbmcoc3F1YXJlRXhwZWN0ZWRWYWx1ZSksXG4gICAgICAgICAgICAgICAgY3NzQ2xhc3M6IHNxdWFyZUNsYXNzXG4gICAgICAgICAgICAgIH07XG5cbiAgICAgICAgICB0aGlzLnBlcnNpc3Qoc3F1YXJlT3B0aW9ucyk7XG4gICAgICAgICAgc3F1YXJlcy5wdXNoKHNxdWFyZU9wdGlvbnMpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gc3F1YXJlcztcbiAgfVxuXG4gIGlzU3F1YXJlUGVyc2lzdGVkKGlkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBsZXQgZGF0YWJhc2VTZXJ2aWNlOiBEYXRhYmFzZVNlcnZpY2VJbnRlcmZhY2UgPSB0aGlzLmRhdGFiYXNlO1xuICAgIGlmIChkYXRhYmFzZVNlcnZpY2UpIHtcbiAgICAgIHJldHVybiBkYXRhYmFzZVNlcnZpY2UuZXhpc3RzKGlkKTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcmVzdG9yZVNxdWFyZU9wdGlvbnMoaWQ6IHN0cmluZyk6IFNxdWFyZSB7XG4gICAgbGV0IGRhdGFiYXNlU2VydmljZTogRGF0YWJhc2VTZXJ2aWNlSW50ZXJmYWNlID0gdGhpcy5kYXRhYmFzZSxcbiAgICAgIHNxdWFyZVN0YXRlOiBTcXVhcmUgPSBudWxsO1xuICAgIGlmIChkYXRhYmFzZVNlcnZpY2UpIHtcbiAgICAgIHNxdWFyZVN0YXRlID0gZGF0YWJhc2VTZXJ2aWNlLnB1bGwoaWQpO1xuICAgIH1cbiAgICByZXR1cm4gc3F1YXJlU3RhdGU7XG4gIH1cblxuICB1blBlcnNpc3QoKTogdm9pZCB7XG4gICAgbGV0IGRhdGFiYXNlU2VydmljZTogRGF0YWJhc2VTZXJ2aWNlSW50ZXJmYWNlID0gdGhpcy5kYXRhYmFzZTtcblxuICAgIGlmIChkYXRhYmFzZVNlcnZpY2UpIHtcbiAgICAgIGRhdGFiYXNlU2VydmljZS56ZXJvKCdyb3cnKTtcbiAgICB9XG4gIH1cblxuICBwZXJzaXN0KG9wdGlvbnM6IFNxdWFyZSk6IHZvaWQge1xuICAgIGxldCBkYXRhYmFzZVNlcnZpY2U6IERhdGFiYXNlU2VydmljZUludGVyZmFjZSA9IHRoaXMuZGF0YWJhc2U7XG5cbiAgICBpZiAoZGF0YWJhc2VTZXJ2aWNlKSB7XG4gICAgICBkYXRhYmFzZVNlcnZpY2UucHVzaChvcHRpb25zLmlkLCBvcHRpb25zKTtcbiAgICB9XG4gIH1cblxuXG59XG4iXX0=