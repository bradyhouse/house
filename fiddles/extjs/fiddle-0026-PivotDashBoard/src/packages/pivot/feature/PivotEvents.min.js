Ext.define("Ext.pivot.feature.PivotEvents",{alternateClassName:["Mz.pivot.feature.PivotEvents"],extend:"Ext.grid.feature.Feature",alias:"feature.pivotevents",requires:["Ext.pivot.feature.PivotStore"],eventPrefix:"pivotcell",eventSelector:"."+Ext.baseCSSPrefix+"grid-cell",summaryDataCls:Ext.baseCSSPrefix+"pivot-summary-data",summaryDataSelector:"."+Ext.baseCSSPrefix+"pivot-summary-data",cellSelector:"."+Ext.baseCSSPrefix+"grid-cell",groupHeaderCls:Ext.baseCSSPrefix+"pivot-grid-group-header",groupHeaderCollapsibleCls:Ext.baseCSSPrefix+"pivot-grid-group-header-collapsible",summaryRowCls:Ext.baseCSSPrefix+"pivot-grid-group-total",summaryRowSelector:"."+Ext.baseCSSPrefix+"pivot-grid-group-total",grandSummaryRowCls:Ext.baseCSSPrefix+"pivot-grid-grand-total",grandSummaryRowSelector:"."+Ext.baseCSSPrefix+"pivot-grid-grand-total",init:function(b){var d=this,a=d.view,c;d.initEventsListeners();d.summaryRowSelector="."+d.summaryRowCls;d.grandSummaryRowSelector="."+d.grandSummaryRowCls;d.callParent(arguments);c=d.lockingPartner;if(c&&c.dataSource){d.dataSource=c.dataSource}else{d.dataSource=new Ext.pivot.feature.PivotStore({store:d.grid.store,pivotFeature:d})}},destroy:function(){var a=this;a.destroyEventsListeners();Ext.destroy(a.dataSource);a.view=a.grid=a.gridMaster=a.matrix=a.dataSource=null;a.callParent(arguments)},initEventsListeners:function(){var a=this;a.eventsViewListeners=a.view.on(Ext.apply({scope:a,destroyable:true},a.getViewListeners()||{}));a.gridListeners=a.grid.on(Ext.apply({scope:a,destroyable:true},a.getGridListeners()||{}))},getViewListeners:function(){var b=this,a={afterrender:b.onViewAfterRender};a[b.eventPrefix+"click"]=b.onCellEvent;a[b.eventPrefix+"dblclick"]=b.onCellEvent;a[b.eventPrefix+"contextmenu"]=b.onCellEvent;return a},getGridListeners:Ext.emptyFn,destroyEventsListeners:function(){Ext.destroyMembers(this,"eventsViewListeners","gridListeners");this.eventsViewListeners=this.gridListeners=null},onViewAfterRender:function(){var a=this;a.gridMaster=a.view.up("pivotgrid");a.matrix=a.gridMaster.getMatrix();a.dataSource.matrix=a.matrix},getRowId:function(a){return this.view.id+"-record-"+a.internalId},getRecord:function(a){return this.view.getRecord(a)},onCellEvent:function(l,a,j){var k=this,o=Ext.fly(a).findParent(k.summaryDataSelector)||Ext.fly(a).findParent(k.summaryRowSelector),f=k.getRecord(o),c={grid:k.gridMaster,view:k.view,cellEl:a},n,i,g,b,m,d,h;if(!o||!f){return false}d=k.dataSource.storeInfo[f.internalId].leftKey;o=Ext.fly(o);if(o.hasCls(k.grandSummaryRowCls)){g="pivottotal"}else{if(o.hasCls(k.summaryRowCls)){g="pivotgroup"}else{if(o.hasCls(k.summaryDataCls)){g="pivotitem"}}}n=Ext.getDom(a).getAttribute("data-columnid");b=k.getColumnHeaderById(n);Ext.apply(c,{columnId:n,column:b,leftKey:d});if(Ext.fly(a).hasCls(k.groupHeaderCls)){}else{if(b){g+="cell";m=k.getTopAxisGroupByDataIndex(b.dataIndex);if(m){h=m.col;Ext.apply(c,{topKey:h,dimensionId:m.agg})}}}i=k.gridMaster.fireEvent(g+j.type,c,j);if(i!==false&&j.type=="click"&&Ext.fly(a).hasCls(k.groupHeaderCollapsibleCls)){k.dataSource.doExpandCollapse(d,f);if(!k.view.bufferedRenderer&&Ext.fly(k.getRowId(f))){Ext.fly(k.getRowId(f)).scrollIntoView(k.view.el,false,false)}}return false},getColumnHeaderById:function(c){var b=this.view.getGridColumns(),a;for(a=0;a<b.length;a++){if(b[a].id===c){return b[a]}}},getTopAxisGroupByDataIndex:function(c){var b=this.gridMaster.matrix.getColumns(),a;for(a=0;a<b.length;a++){if(b[a].name===c){return b[a]}}}});