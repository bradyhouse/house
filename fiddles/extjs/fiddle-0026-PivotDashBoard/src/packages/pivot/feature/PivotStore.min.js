Ext.define("Ext.pivot.feature.PivotStore",{constructor:function(a){Ext.apply(this,a);this.bindStore(a.store)},destroy:function(){var a=this;Ext.destroy(a.storeListeners);a.store=a.matrix=a.pivotFeature=null;a.storeInfo=a.storeListeners=a.store=null;a.callParent(arguments)},bindStore:function(a){var b=this;if(b.store){Ext.destroy(b.storeListeners);b.store=null}if(a){b.storeListeners=a.on({pivotstoreremodel:b.processStore,scope:b,destroyable:true});b.store=a}},processStore:function(){if(!this.matrix){return}var c=this,b=c["processGroup"+Ext.String.capitalize(c.matrix.viewLayoutType)],a=c.matrix.getColumns(),d;c.store.model.replaceFields(a,true);c.store.removeAll(true);c.store.suspendEvents(false);c.storeInfo={};if(!Ext.isFunction(b)){b=c.processGroupOutline}d=Ext.Function.bind(b,c);if(c.matrix.rowGrandTotalsPosition=="first"){c.processGrandTotal()}Ext.Array.each(c.matrix.leftAxis.getTree(),function(g,e,f){c.store.add(d({group:g,previousExpanded:(e>0?f[e-1].expanded:false)}))},c);if(c.matrix.rowGrandTotalsPosition=="last"){c.processGrandTotal()}c.store.resumeEvents();c.store.fireEvent("refresh",c.store)},processGroup:function(a){var c=this,b=c["processGroup"+Ext.String.capitalize(c.matrix.viewLayoutType)],d;if(!Ext.isFunction(b)){b=c.processGroupOutline}d=Ext.Function.bind(b,c);return d(a)},createGridStoreRecord:function(b){var c=this,d=c.matrix.preparePivotStoreRecordData(b||{}),a;d.id="";a=new c.store.model(d);if(Ext.isEmpty(b)){Ext.Object.each(d,function(e){if(e!="id"){a.set(e,null)}});a.commit()}a.isPlaceholder=true;return a},processGrandTotal:function(){var a=this,b=false,c={key:a.matrix.grandTotalKey};Ext.Array.forEach(a.matrix.totals||[],function(f){var d=f.record,e=a.matrix.leftAxis.dimensions.getCount();if(!(d instanceof Ext.data.Model)){return}a.storeInfo[d.internalId]={leftKey:c.key,rowStyle:"",rowClasses:[a.pivotFeature.gridMaster.clsGrandTotal,a.pivotFeature.summaryDataCls],rendererParams:{}};a.matrix.leftAxis.dimensions.each(function(i,g){var h;if(a.matrix.viewLayoutType=="compact"||g===0){if(a.matrix.viewLayoutType=="compact"){h=a.matrix.compactViewKey;e=1}else{h=i.getId()}d.set(h,f.title);d.commit(false,[h]);a.storeInfo[d.internalId].rendererParams[h]={fn:"groupOutlineRenderer",group:c,colspan:e,hidden:false,subtotalRow:true};b=true}else{a.storeInfo[d.internalId].rendererParams[i.getId()]={fn:"groupOutlineRenderer",group:c,colspan:0,hidden:b,subtotalRow:true};e--}a.storeInfo[d.internalId].rendererParams.topaxis={fn:"topAxisRenderer"}});a.store.add(d)})},processGroupOutline:function(a){var c=this,d=a.group,b=[];if(d.record){c.processRecordOutline({results:b,group:d})}else{c.processGroupOutlineWithChildren({results:b,group:d,previousExpanded:a.previousExpanded})}return b},processGroupOutlineWithChildren:function(c){var f=this,g=c.group,b=c.previousExpanded,e=false,a,d;if(!g.expanded||(g.expanded&&f.matrix.rowSubTotalsPosition=="first")){e=true;a=f.createGridStoreRecord(g)}else{if(f.matrix.rowSubTotalsPosition=="last"||f.matrix.rowSubTotalsPosition=="none"){a=f.createGridStoreRecord();a.set(g.dimension.getId(),g.name)}}a.commit();f.processGroupHeaderRecordOutline({results:c.results,group:g,record:a,previousExpanded:b,hasSummaryData:e});if(g.expanded){if(g.children){for(d=0;d<g.children.length;d++){if(g.children[d]["children"]){f.processGroupOutlineWithChildren({results:c.results,group:g.children[d]})}else{f.processRecordOutline({results:c.results,group:g.children[d]})}}}if(f.matrix.rowSubTotalsPosition=="last"){a=f.createGridStoreRecord(g);a.set(g.dimension.getId(),g.getTextTotal());a.commit();f.processGroupHeaderRecordOutline({results:c.results,group:g,record:a,previousExpanded:b,subtotalRow:true,hasSummaryData:true})}}},processGroupHeaderRecordOutline:function(a){var f=this,g=a.group,d=a.record,b=a.previousExpanded,h=a.subtotalRow,e=a.hasSummaryData,c=f.matrix.leftAxis.dimensions.getCount(),j=false;f.storeInfo[d.internalId]={leftKey:g.key,rowStyle:"",rowClasses:[f.pivotFeature.gridMaster.clsGroupTotal,e?f.pivotFeature.summaryDataCls:""],rendererParams:{}};f.matrix.leftAxis.dimensions.each(function(k,i){if(k.getId()==g.dimension.getId()){f.storeInfo[d.internalId].rendererParams[k.getId()]={fn:"groupOutlineRenderer",group:g,colspan:c,hidden:false,previousExpanded:b,subtotalRow:h};j=true}else{f.storeInfo[d.internalId].rendererParams[k.getId()]={fn:"groupOutlineRenderer",group:g,colspan:0,hidden:j,previousExpanded:b,subtotalRow:h};c--}});f.storeInfo[d.internalId].rendererParams.topaxis={fn:(e?"topAxisRenderer":"topAxisNoRenderer")};a.results.push(d)},processRecordOutline:function(b){var c=this,e=b.group,d=false,a=e.record;c.storeInfo[a.internalId]={leftKey:e.key,rowStyle:"",rowClasses:[c.pivotFeature.rowCls,c.pivotFeature.summaryDataCls],rendererParams:{}};c.matrix.leftAxis.dimensions.each(function(g,f){if(g.getId()==e.dimension.getId()){d=true}c.storeInfo[a.internalId].rendererParams[g.getId()]={fn:"recordOutlineRenderer",group:e,hidden:!d}});c.storeInfo[a.internalId].rendererParams.topaxis={fn:"topAxisRenderer"};b.results.push(a)},processGroupCompact:function(b){var d=this,e=b.group,a=b.previousExpanded,c=[];if(e.record){d.processRecordCompact({results:c,group:e})}else{d.processGroupCompactWithChildren({results:c,group:e,previousExpanded:a})}return c},processGroupCompactWithChildren:function(c){var f=this,g=c.group,b=c.previousExpanded,e=false,a,d;if(!g.expanded||(g.expanded&&f.matrix.rowSubTotalsPosition=="first")){e=true;a=f.createGridStoreRecord(g)}else{if(f.matrix.rowSubTotalsPosition=="last"||f.matrix.rowSubTotalsPosition=="none"){a=f.createGridStoreRecord();a.set(f.matrix.compactViewKey,g.name)}}a.commit();f.processGroupHeaderRecordCompact({results:c.results,group:g,record:a,previousExpanded:b,hasSummaryData:e});if(g.expanded){if(g.children){for(d=0;d<g.children.length;d++){if(g.children[d]["children"]){f.processGroupCompactWithChildren({results:c.results,group:g.children[d]})}else{f.processRecordCompact({results:c.results,group:g.children[d]})}}}if(f.matrix.rowSubTotalsPosition=="last"){a=f.createGridStoreRecord(g);a.set(f.matrix.compactViewKey,g.getTextTotal());a.commit();f.processGroupHeaderRecordCompact({results:c.results,group:g,record:a,previousExpanded:b,subtotalRow:true,hasSummaryData:true})}}},processGroupHeaderRecordCompact:function(a){var f=this,g=a.group,d=a.record,b=a.previousExpanded,h=a.subtotalRow,e=a.hasSummaryData,c=f.matrix.leftAxis.dimensions.getCount(),j=false;f.storeInfo[d.internalId]={leftKey:g.key,rowStyle:"",rowClasses:[f.pivotFeature.gridMaster.clsGroupTotal,e?f.pivotFeature.summaryDataCls:""],rendererParams:{}};f.storeInfo[d.internalId].rendererParams[f.matrix.compactViewKey]={fn:"groupCompactRenderer",group:g,colspan:0,previousExpanded:b,subtotalRow:h};f.storeInfo[d.internalId].rendererParams.topaxis={fn:(e?"topAxisRenderer":"topAxisNoRenderer")};a.results.push(d)},processRecordCompact:function(b){var c=this,e=b.group,d=false,a=c.createGridStoreRecord(e);c.storeInfo[a.internalId]={leftKey:e.key,rowStyle:"",rowClasses:[c.pivotFeature.rowCls,c.pivotFeature.summaryDataCls],rendererParams:{}};c.storeInfo[a.internalId].rendererParams[c.matrix.compactViewKey]={fn:"recordCompactRenderer",group:e};c.storeInfo[a.internalId].rendererParams.topaxis={fn:"topAxisRenderer"};b.results.push(a)},doExpandCollapse:function(c,a){var d=this,b=d.pivotFeature.gridMaster,e;e=d.matrix.leftAxis.findTreeElement("key",c);if(!e){return}d.doExpandCollapseInternal(e,a);b.fireEvent((e.node.expanded?"pivotgroupexpand":"pivotgroupcollapse"),b,"row",e.node)},doExpandCollapseInternal:function(f,b){var e=this,c,g,d,a;g=e.processGroup({group:f.node,previousExpanded:false});f.node.expanded=!f.node.expanded;c=e.processGroup({group:f.node,previousExpanded:false});if(c.length&&(d=e.store.indexOf(b))!==-1){e.store.suspendEvents();if(f.node.expanded){e.store.remove(e.store.getAt(d));e.store.insert(d,c);g=[b]}else{a=g.length;g=e.store.getRange(d,d+a-1);e.store.remove(g);e.store.insert(d,c)}e.removeStoreInfoData(g);e.store.resumeEvents();e.store.fireEvent("replace",e.store,d,g,c)}},removeStoreInfoData:function(a){Ext.Array.each(a,function(b){if(this.storeInfo[b.internalId]){delete this.storeInfo[b.internalId]}},this)}});