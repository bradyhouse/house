Ext.define("Ext.pivot.plugin.configurator.DropZone",{extend:"Ext.dd.DropZone",proxyOffsets:[-4,-9],configPanelCls:Ext.baseCSSPrefix+"pivot-grid-config-container-body",configColumnCls:Ext.baseCSSPrefix+"pivot-grid-config-column",constructor:function(a){this.panel=a;this.ddGroup=this.getDDGroup();this.callParent([a.id])},disable:function(){this.disabled=true},enable:function(){this.disabled=false},getDDGroup:function(){return"configurator-"+this.panel.up("gridpanel").id},getTargetFromEvent:function(a){return a.getTarget("."+this.configColumnCls)||a.getTarget("."+this.configPanelCls)},getTopIndicator:function(){if(!this.topIndicator){this.self.prototype.topIndicator=Ext.DomHelper.append(Ext.getBody(),{cls:"col-move-top "+Ext.baseCSSPrefix+"col-move-top",html:"&#160;"},true);this.self.prototype.indicatorXOffset=Math.floor((this.topIndicator.dom.offsetWidth+1)/2)}return this.topIndicator},getBottomIndicator:function(){if(!this.bottomIndicator){this.self.prototype.bottomIndicator=Ext.DomHelper.append(Ext.getBody(),{cls:"col-move-bottom "+Ext.baseCSSPrefix+"col-move-bottom",html:"&#160;"},true)}return this.bottomIndicator},getLocation:function(f,b){var a=f.getXY()[0],d=Ext.getCmp(b.id),c,g;if(d instanceof Ext.pivot.plugin.configurator.Container){if(d.items.getCount()>0){c=Ext.fly(d.items.last().el).getRegion()}else{c=new Ext.util.Region(0,1000000,0,0)}}else{c=Ext.fly(b).getRegion()}if((c.right-a)<=(c.right-c.left)/2){g="after"}else{g="before"}return{pos:g,header:Ext.getCmp(b.id),node:b}},positionIndicator:function(y,o,u){var x=this,p=y.header,f=x.getLocation(u,o),j=f.header,d=f.pos,c,t,l,r,s,a,b,k,m,w,v,n,h,q,g;if(j===x.lastTargetHeader&&d===x.lastDropPos){return}c=p.nextSibling("gridcolumn:not([hidden])");t=p.previousSibling("gridcolumn:not([hidden])");x.lastTargetHeader=j;x.lastDropPos=d;y.dropLocation=f;if((p!==j)&&((d==="before"&&c!==j)||(d==="after"&&t!==j))&&!j.isDescendantOf(p)){n=Ext.dd.DragDropManager.getRelated(x);h=n.length;q=0;for(;q<h;q++){g=n[q];if(g!==x&&g.invalidateDrop){g.invalidateDrop()}}x.valid=true;l=x.getTopIndicator();r=x.getBottomIndicator();if(d==="before"){s="bc-tl";a="tc-bl"}else{s="bc-tr";a="tc-br"}if(j instanceof Ext.pivot.plugin.configurator.Container&&j.items.getCount()>0){b=l.getAlignToXY(j.items.last().el,s);k=r.getAlignToXY(j.items.last().el,a)}else{b=l.getAlignToXY(j.el,s);k=r.getAlignToXY(j.el,a)}m=x.panel.el;w=m.getX()-x.indicatorXOffset;v=m.getX()+m.getWidth();b[0]=Ext.Number.constrain(b[0],w,v);k[0]=Ext.Number.constrain(k[0],w,v);l.setXY(b);r.setXY(k);l.show();r.show()}else{x.invalidateDrop()}},invalidateDrop:function(){this.valid=false;this.hideIndicators()},onNodeOver:function(c,g,f,d){var h=this,j=d.header,a,k,b,i;a=true;if(d.header.el.dom===c){a=false}if(a){h.positionIndicator(d,c,f)}else{h.valid=false}return h.valid?h.dropAllowed:h.dropNotAllowed},hideIndicators:function(){var a=this;a.getTopIndicator().hide();a.getBottomIndicator().hide();a.lastTargetHeader=a.lastDropPos=null},onNodeOut:function(){this.hideIndicators()},onNodeDrop:function(b,h,g,d){var j=this,c=d.header,f=d.dropLocation,a,k,i;if(j.valid&&f){if(h.id!=j.panel.id){k=j.panel.getColumnPosition(f.header,f.pos);a=c.serialize();if(!j.panel.isAgg){h.panel.remove(c)}j.panel.addColumn(a.dimension,k,true)}else{j.panel.moveColumn(c.id,f.header instanceof Ext.pivot.plugin.configurator.Container?f.header.items.last().id:f.header.id,f.pos)}}}});