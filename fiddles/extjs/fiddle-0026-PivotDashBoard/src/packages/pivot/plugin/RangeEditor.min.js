Ext.define("Ext.pivot.plugin.RangeEditor",{alternateClassName:["Mz.pivot.plugin.RangeEditor"],alias:["plugin.pivotrangeeditor","plugin.mzrangeeditor"],extend:"Ext.AbstractPlugin",requires:["Ext.pivot.Grid","Ext.window.Window","Ext.form.field.Text","Ext.form.field.Number","Ext.form.field.ComboBox","Ext.form.field.Display","Ext.button.Button","Ext.data.Store"],mixins:{observable:"Ext.util.Observable"},width:null,height:null,textWindowTitle:"Range editor",textFieldValue:"Value",textFieldEdit:"Field",textFieldType:"Type",textButtonOk:"Ok",textButtonCancel:"Cancel",textTypePercentage:"Percentage",textTypeIncrement:"Increment",textTypeOverwrite:"Overwrite",textTypeUniformly:"Uniformly",onBeforeRecordsUpdate:Ext.emptyFn,onAfterRecordsUpdate:Ext.emptyFn,lockableScope:"top",init:function(a){var b=this;if(!a.isPivotGrid){Ext.raise("This plugin is only compatible with Ext.pivot.Grid")}b.pivot=a;b.pivotListeners=b.pivot.on({pivotitemcelldblclick:b.runPlugin,pivotgroupcelldblclick:b.runPlugin,pivottotalcelldblclick:b.runPlugin,scope:b,destroyable:true});b.callParent(arguments)},destroy:function(){var a=this;Ext.destroyMembers(a,"view","pivotListeners");a.pivot=a.view=a.pivotListeners=a.currentRecord=a.currentCol=a.currentResult=null;a.callParent(arguments)},runPlugin:function(g,f,c){var d=this,a=d.pivot.getMatrix(),b;if(d.disabled){return}if(g.topKey){d.initEditorWindow();d.currentResult=a.results.get(g.leftKey,g.topKey);if(d.currentResult){d.currentCol=g.column;b=d.currentCol.dimension.getId();d.view.down("form").getForm().setValues({field:d.currentCol.dimension.header||d.currentCol.text||d.currentCol.dimension.dataIndex,value:d.currentResult.getValue(b),type:"uniformly"});d.view.show()}}},updateRecords:function(){var g=this,b=g.currentResult,f=g.currentCol,a=f.dimension.getId(),e=f.dimension.dataIndex,d=g.view.down("form").getForm().getValues(),c,h=0;c=b.records;if(g.onBeforeRecordsUpdate(g.pivot,f,c,d.value,b.getValue(a))===false){return}g.view.getEl().mask();d.value=parseFloat(d.value);Ext.defer(function(){Ext.Array.each(c,function(k){var j=k.get(e),l,i;switch(d.type){case"percentage":i=Math.floor(j*d.value/100);break;case"increment":i=j+d.value;break;case"overwrite":i=d.value;break;case"uniformly":l=(1/c.length*d.value)+h;i=Math.floor(l);h+=(l-i);break}if(j!=i){k.set(e,i)}});g.onAfterRecordsUpdate(g.pivot,f,c,d.value,b.getValue(a));g.view.getEl().unmask();g.view.close()},10)},initEditorWindow:function(){var a=this;if(!a.view){a.view=Ext.create("Ext.window.Window",{title:a.textWindowTitle,width:a.width,height:a.height,layout:"fit",modal:true,closeAction:"hide",items:[{xtype:"form",padding:5,border:false,defaults:{anchor:"100%"},items:[{fieldLabel:a.textFieldEdit,xtype:"displayfield",name:"field"},{fieldLabel:a.textFieldType,xtype:"combo",name:"type",queryMode:"local",valueField:"id",displayField:"text",editable:false,store:Ext.create("Ext.data.Store",{fields:["id","text"],data:[{id:"percentage",text:a.textTypePercentage},{id:"increment",text:a.textTypeIncrement},{id:"overwrite",text:a.textTypeOverwrite},{id:"uniformly",text:a.textTypeUniformly}]})},{fieldLabel:a.textFieldValue,xtype:"numberfield",name:"value"}]}],buttons:[{text:a.textButtonOk,handler:a.updateRecords,scope:a},{text:a.textButtonCancel,handler:function(){this.view.close()},scope:a}]})}}});