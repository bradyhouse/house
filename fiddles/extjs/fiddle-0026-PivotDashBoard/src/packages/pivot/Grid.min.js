Ext.define("Ext.pivot.Grid",{extend:"Ext.grid.Panel",alternateClassName:["Mz.pivot.Grid","Mz.pivot.Table"],xtype:["pivotgrid","mzpivotgrid"],requires:["Ext.pivot.matrix.Local","Ext.pivot.matrix.Remote","Ext.pivot.feature.PivotView","Ext.util.DelayedTask","Ext.data.ArrayStore"],subGridXType:"gridpanel",matrixConfig:null,enableLoadMask:true,enableLocking:false,enableColumnSort:true,columnLines:true,viewLayoutType:"outline",rowSubTotalsPosition:"first",rowGrandTotalsPosition:"last",colSubTotalsPosition:"last",colGrandTotalsPosition:"last",textTotalTpl:"Total ({name})",textGrandTotalTpl:"Grand total",leftAxis:null,topAxis:null,aggregate:null,clsGroupTotal:Ext.baseCSSPrefix+"pivot-grid-group-total",clsGrandTotal:Ext.baseCSSPrefix+"pivot-grid-grand-total",startRowGroupsCollapsed:true,startColGroupsCollapsed:true,showZeroAsBlank:false,stateEvents:["pivotgroupexpand","pivotgroupcollapse","pivotdone"],isPivotGrid:true,initComponent:function(){var a=this;a.columns=[];a.preInitialize();a.callParent(arguments);a.postInitialize()},preInitialize:function(){var a=this;a.features=[{id:"group",ftype:"pivotview",summaryRowCls:a.clsGroupTotal,grandSummaryRowCls:a.clsGrandTotal}];a.addCls(Ext.baseCSSPrefix+"pivot-grid");if(a.store){a.originalStore=a.store}a.store=Ext.create("Ext.data.ArrayStore",{fields:[]});a.enableColumnMove=false;a.delayedTask=new Ext.util.DelayedTask(a.refreshView,a)},postInitialize:function(){var c=this,a={},b={headerclick:c.onHeaderClick,scope:c,destroyable:true};if(c.enableLocking){c.lockedHeaderCtListeners=c.getView().lockedView.getHeaderCt().on(b);c.headerCtListeners=c.getView().normalView.getHeaderCt().on(b)}else{c.headerCtListeners=c.getView().getHeaderCt().on(b)}Ext.apply(a,{leftAxis:c.leftAxis,topAxis:c.topAxis,aggregate:c.aggregate,showZeroAsBlank:c.showZeroAsBlank,textTotalTpl:c.textTotalTpl,textGrandTotalTpl:c.textGrandTotalTpl,viewLayoutType:c.viewLayoutType,rowSubTotalsPosition:c.rowSubTotalsPosition,rowGrandTotalsPosition:c.rowGrandTotalsPosition,colSubTotalsPosition:c.colSubTotalsPosition,colGrandTotalsPosition:c.colGrandTotalsPosition});Ext.applyIf(a,c.matrixConfig||{});Ext.applyIf(a,{type:"local"});if(a.type=="local"&&c.originalStore){Ext.applyIf(a,{store:c.originalStore})}c.matrix=Ext.Factory.pivotmatrix(a);c.matrixListeners=c.matrix.on({cleardata:c.onMatrixClearData,start:c.onMatrixProcessStart,progress:c.onMatrixProcessProgress,done:c.onMatrixDataReady,beforeupdate:c.onMatrixBeforeUpdate,afterupdate:c.onMatrixAfterUpdate,scope:c,destroyable:true});c.matrixRelayedListeners=c.relayEvents(c.matrix,["start","progress","done","modelbuilt","columnsbuilt","recordbuilt","buildtotals","storebuilt","beforerequest","requestexception"],"pivot")},destroy:function(){var a=this;a.delayedTask.cancel();Ext.destroy(a.matrixRelayedListeners,a.matrixListeners,a.headerCtListeners,a.lockedHeaderCtListeners);Ext.destroy(a.matrix,a.delayedTask,a.originalStore);a.matrixRelayedListeners=a.matrixListeners=a.headerCtListeners=a.lockedHeaderCtListeners=null;a.matrix=a.delayedTask=a.originalStore=null;a.callParent(arguments);Ext.destroy(a.store);a.store=null},afterRender:function(){this.reconfigurePivot();this.callParent(arguments)},refreshView:function(){var b=this,a;if(b.scheduledReconfigure===true){b.scheduledReconfigure=false;a=b.getMatrix().getColumnHeaders();b.preparePivotColumns(a);b.restorePivotColumnsState(a);b.reconfigure(undefined,a)}b.store.fireEvent("pivotstoreremodel",b)},onMatrixClearData:function(){var a=this;a.store.removeAll(true);if(!a.expandedItemsState){a.lastColumnsState=null}a.sortedColumn=null},onMatrixProcessStart:function(){if(this.enableLoadMask){this.setLoading(true)}},onMatrixProcessProgress:function(a,b,e){var d=this,c=((b||0.1)*100)/(e||0.1),f;if(d.loadMask){if(d.loadMask.msgTextEl){f=d.loadMask.msgTextEl}else{if(d.loadMask.msgEl){f=d.loadMask.msgEl}}if(f){f.update(Ext.util.Format.number(c,"0")+"%")}}},onMatrixBeforeUpdate:function(){this.store.suspendEvents()},onMatrixAfterUpdate:function(){var a=this;a.store.resumeEvents();a.store.fireEvent("pivotstoreremodel")},onMatrixDataReady:function(){var b=this,c=b.matrix.getColumnHeaders(),a=false;if(b.enableLoadMask){b.setLoading(false)}if(b.expandedItemsState){b.matrix.leftAxis.items.each(function(d){if(Ext.Array.indexOf(b.expandedItemsState.rows,d.key)>=0){d.expanded=true;a=true}});b.matrix.topAxis.items.each(function(d){if(Ext.Array.indexOf(b.expandedItemsState.cols,d.key)>=0){d.expanded=true;a=true}});if(a){c=b.matrix.getColumnHeaders();delete b.expandedItemsState}}else{b.doExpandCollapseTree(b.matrix.leftAxis.getTree(),!b.startRowGroupsCollapsed);b.doExpandCollapseTree(b.matrix.topAxis.getTree(),!b.startColGroupsCollapsed);c=b.matrix.getColumnHeaders()}b.preparePivotColumns(c);b.restorePivotColumnsState(c);b.reconfigure(undefined,c);if(!Ext.isEmpty(b.sortedColumn)){b.matrix.leftAxis.sortTreeByField(b.sortedColumn.dataIndex,b.sortedColumn.direction)}b.store.fireEvent("pivotstoreremodel",b);if(!Ext.isEmpty(b.sortedColumn)){b.updateColumnSortState(b.sortedColumn.dataIndex,b.sortedColumn.direction)}},preparePivotColumns:function(b){var f=this,e={menuDisabled:true,sortable:false,lockable:false},d=b.length,a,c;for(a=0;a<d;a++){c=b[a];c.cls=c.cls||"";Ext.apply(c,e);if(c.leftAxis){c.locked=f.enableLocking}if(c.subTotal){c.cls=c.tdCls=f.clsGroupTotal}if(c.grandTotal){c.cls=c.tdCls=f.clsGrandTotal}if(!c.xexpanded){c.cls+=" "+Ext.baseCSSPrefix+"grid-row-collapsed"}if(c.xcollapsible){c.text=Ext.String.format('<span class="'+Ext.baseCSSPrefix+'grid-row-expander" style="padding-left: 13px">{0}</span>',c.text)}if(Ext.isEmpty(c.columns)){if(c.dimension){c.renderer=c.dimension?c.dimension.renderer:false;c.align=c.dimension.align;if(c.dimension.flex>0){c.flex=c.flex||c.dimension.flex}else{c.width=c.width||c.dimension.width}}}else{f.preparePivotColumns(c.columns)}}},reconfigurePivot:function(a){var d=this,c=Ext.clone(d.getStateProperties()),b;c.push("startRowGroupsCollapsed","startColGroupsCollapsed","showZeroAsBlank");a=a||{};for(b=0;b<c.length;b++){if(!a.hasOwnProperty(c[b])){if(d[c[b]]){a[c[b]]=d[c[b]]}}else{d[c[b]]=a[c[b]]}}d.getMatrix().reconfigure(a)},getMatrix:function(){return this.matrix},doExpandCollapseTree:function(a,b){var c;for(c=0;c<a.length;c++){a[c].expanded=b;if(a[c].children){this.doExpandCollapseTree(a[c].children,b)}}},doExpandCollapse:function(c,b,f,a){var e=this,d;if(!e.matrix){return}d=(c=="row"?e.matrix.leftAxis:e.matrix.topAxis)["findTreeElement"]("key",b);if(!d){return}f=Ext.isDefined(f)?f:!d.node.expanded;if(a===true){e.doExpandCollapseTree([d.node],f)}else{d.node.expanded=f}if(c=="col"){e.scheduledReconfigure=true}e.refreshView();e.fireEvent((d.node.expanded?"pivotgroupexpand":"pivotgroupcollapse"),e,c,d.node)},expandRow:function(b,a){this.doExpandCollapse("row",b,true,a)},collapseRow:function(b,a){this.doExpandCollapse("row",b,false,a)},expandCol:function(b,a){this.doExpandCollapse("col",b,true,a)},collapseCol:function(b,a){this.doExpandCollapse("col",b,false,a)},expandAll:function(){var a=this;a.expandAllColumns();a.expandAllRows()},expandAllRows:function(){var a=this;if(!a.getMatrix()){return}a.doExpandCollapseTree(a.getMatrix().leftAxis.getTree(),true);a.delayedTask.delay(10)},expandAllColumns:function(){var a=this;if(!a.getMatrix()){return}a.doExpandCollapseTree(a.getMatrix().topAxis.getTree(),true);a.scheduledReconfigure=true;a.delayedTask.delay(10)},collapseAll:function(){var a=this;a.collapseAllRows();a.collapseAllColumns()},collapseAllRows:function(){var a=this;if(!a.getMatrix()){return}a.doExpandCollapseTree(a.getMatrix().leftAxis.getTree(),false);a.delayedTask.delay(10)},collapseAllColumns:function(){var a=this;if(!a.getMatrix()){return}a.doExpandCollapseTree(a.getMatrix().topAxis.getTree(),false);a.scheduledReconfigure=true;a.delayedTask.delay(10)},setStore:function(a){this.reconfigurePivot({store:a})},getStore:function(){var b=this,a=b.getMatrix();return((a instanceof Ext.pivot.matrix.Local)?a.store:b.originalStore)||b.store},getPivotStore:function(){return this.store},getTopAxisItem:function(e){var f=this,a=f.getMatrix(),d=a.getColumns(),c,b;if(!e){return null}for(b=0;b<d.length;b++){if(d[b].name===e.dataIndex){c=d[b].col;break}}return Ext.isEmpty(c)?null:a.topAxis.items.getByKey(c)},getLeftAxisItem:function(b){var d=this,a=d.getView(),e,c;if(!b){return null}a=a.normalView||a;c=a.getFeature("group");if(!c){return null}e=c.dataSource.storeInfo[b.internalId];return e?d.getMatrix().leftAxis.items.getByKey(e.leftKey):null},onHeaderClick:function(c,f,h){var g=this,b,d,a=(f.sortState?(f.sortState=="ASC"?"DESC":"ASC"):"ASC");if(!g.enableColumnSort){return}if(!f.xexpandable){if(h){h.stopEvent()}if((f.leftAxis||f.topAxis)&&!Ext.isEmpty(f.dataIndex)){if(g.getMatrix().leftAxis.sortTreeByField(f.dataIndex,a)){g.refreshView();g.updateColumnSortState(f,a)}}return false}g.doExpandCollapse("col",f.key);if(h){h.stopEvent()}},updateColumnSortState:function(b,a){if(Ext.isString(b)){b=this.down('[dataIndex="'+b+'"]')}if(!b){return}b.setSortState(new Ext.util.Sorter({direction:a,property:"dummy"}));b.sortState=a;this.sortedColumn={dataIndex:b.dataIndex,direction:a}},getStateProperties:function(){return["viewLayoutType","rowSubTotalsPosition","rowGrandTotalsPosition","colSubTotalsPosition","colGrandTotalsPosition","aggregate","leftAxis","topAxis","enableColumnSort","sortedColumn"]},applyState:function(d){var c=this,b=c.getStateProperties(),a;for(a=0;a<b.length;a++){if(d[b[a]]){c[b[a]]=d[b[a]]}}if(d.expandedItems){c.expandedItemsState=d.expandedItems}c.lastColumnsState=d.pivotcolumns||{};if(c.rendered){c.reconfigurePivot()}},getState:function(){var c=this,d={},b=c.getStateProperties(),a;for(a=0;a<b.length;a++){d[b[a]]=c[b[a]]}d.expandedItems={cols:[],rows:[]};c.matrix.leftAxis.items.each(function(e){if(e.expanded){d.expandedItems["rows"].push(e.key)}});c.matrix.topAxis.items.each(function(e){if(e.expanded){d.expandedItems["cols"].push(e.key)}});c.matrix.leftAxis.dimensions.each(function(f,e){d.leftAxis[e]["id"]=f.getId()});d.pivotcolumns=c.getPivotColumnsState();return d},getPivotColumnsState:function(){var b=this,a,c;if(!b.lastColumnsState){c=b.getDataIndexColumns(b.getMatrix().getColumnHeaders());b.lastColumnsState={};for(a=0;a<c.length;a++){if(c[a].dataIndex){b.lastColumnsState[c[a].dataIndex]={width:c[a].width,flex:c[a].flex||0}}}}c=b.getView().getGridColumns();for(a=0;a<c.length;a++){if(c[a].dataIndex){b.lastColumnsState[c[a].dataIndex]={width:c[a].rendered?c[a].getWidth():c[a].width,flex:c[a].flex||0}}}return b.lastColumnsState},getDataIndexColumns:function(b){var c=[],a;for(a=0;a<b.length;a++){if(b[a].dataIndex){c.push(b[a].dataIndex)}else{if(Ext.isArray(b[a].columns)){c=Ext.Array.merge(c,this.getDataIndexColumns(b[a].columns))}}}return c},restorePivotColumnsState:function(a){this.parsePivotColumnsState(this.getPivotColumnsState(),a)},parsePivotColumnsState:function(d,b){var c,a;if(!b){return}for(a=0;a<b.length;a++){c=d[b[a].dataIndex];if(c){if(c.flex){b[a].flex=c.flex}else{if(c.width){b[a].width=c.width}}}this.parsePivotColumnsState(d,b[a].columns)}}});