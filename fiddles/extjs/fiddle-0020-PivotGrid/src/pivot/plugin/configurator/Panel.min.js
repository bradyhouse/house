Ext.define("Ext.pivot.plugin.configurator.Panel",{extend:"Ext.panel.Panel",requires:["Ext.pivot.plugin.configurator.Container"],alias:"widget.pivotconfigpanel",dock:"right",weight:50,grid:null,fields:[],refreshDelay:1000,defaultMinHeight:70,defaultMinWidth:250,header:false,title:"Configurator",collapsible:true,collapseMode:"placeholder",panelAllFieldsText:"Drop Unused Fields Here",panelAllFieldsTitle:"All fields",panelTopFieldsText:"Drop Column Fields Here",panelTopFieldsTitle:"Column labels",panelLeftFieldsText:"Drop Row Fields Here",panelLeftFieldsTitle:"Row labels",panelAggFieldsText:"Drop Agg Fields Here",panelAggFieldsTitle:"Values",headerContainerCls:Ext.baseCSSPrefix+"pivot-grid-config-container-header",initComponent:function(){var b=this,a={configchange:b.onConfigChanged,sortchange:b.onSortChanged,filterchange:b.onFilterChanged,scope:b,destroyable:true};Ext.apply(b,Ext.Array.indexOf(["top","bottom"],b.dock)>=0?b.getHorizontalConfig():b.getVerticalConfig());b.callParent(arguments);b.fieldsCt=b.down("#fieldsCt");b.fieldsTopCt=b.down("#fieldsTopCt");b.fieldsLeftCt=b.down("#fieldsLeftCt");b.fieldsAggCt=b.down("#fieldsAggCt");b.fieldsCtListeners=b.fieldsCt.on(a);b.fieldsLeftCtListeners=b.fieldsLeftCt.on(a);b.fieldsTopCtListeners=b.fieldsTopCt.on(a);b.fieldsAggCtListeners=b.fieldsAggCt.on(a);b.fieldsExtracted=false;b.gridListeners=b.grid.on({pivotdone:b.initPivotFields,scope:b,destroyable:true});b.task=new Ext.util.DelayedTask(function(){b.grid.reconfigurePivot({topAxis:b.getFieldsFromContainer(b.fieldsTopCt),leftAxis:b.getFieldsFromContainer(b.fieldsLeftCt),aggregate:b.getFieldsFromContainer(b.fieldsAggCt)})})},destroy:function(){var a=this;delete (a.grid);Ext.destroy(a.relayers,a.fieldsCtListeners,a.fieldsLeftCtListeners,a.fieldsTopCtListeners,a.fieldsAggCtListeners,a.gridListeners);a.callParent()},enable:function(){var a=this;if(a.fieldsCt){a.fieldsCt.enable();a.fieldsTopCt.enable();a.fieldsLeftCt.enable();a.fieldsAggCt.enable();a.initPivotFields()}a.show()},disable:function(){var a=this;if(a.fieldsCt){a.fieldsCt.disable();a.fieldsTopCt.disable();a.fieldsLeftCt.disable();a.fieldsAggCt.disable()}a.hide()},getPanelConfigHeader:function(a){return Ext.apply({xtype:"header",baseCls:Ext.baseCSSPrefix+"panel-header",cls:this.headerContainerCls,border:1,width:100},a||{})},getHorizontalConfig:function(){var a=this;return{minHeight:a.defaultMinHeight,headerPosition:a.dock=="top"?"bottom":"top",collapseDirection:a.dock,defaults:{xtype:"container",layout:{type:"hbox",align:"stretchmax"},minHeight:a.defaultMinHeight/3},items:[{items:[a.getPanelConfigHeader({title:a.panelAllFieldsTitle,tools:a.collapsible?[{type:a.dock=="top"?"up":"down",handler:a.collapseMe,scope:a}]:[]}),{itemId:"fieldsCt",xtype:"pivotconfigcontainer",isCustomizable:false,dragDropText:a.panelAllFieldsText,position:a.dock,flex:1}]},{items:[a.getPanelConfigHeader({title:a.panelAggFieldsTitle}),{itemId:"fieldsAggCt",xtype:"pivotconfigcontainer",isCustomizable:true,isAgg:true,dragDropText:a.panelAggFieldsText,position:a.dock,flex:1}]},{defaults:{xtype:"pivotconfigcontainer",minHeight:a.defaultMinHeight/3,position:a.dock},items:[a.getPanelConfigHeader({title:a.panelLeftFieldsTitle}),{itemId:"fieldsLeftCt",pivotField:"leftAxis",isCustomizable:true,dragDropText:a.panelLeftFieldsText,flex:1},a.getPanelConfigHeader({title:a.panelTopFieldsTitle}),{itemId:"fieldsTopCt",pivotField:"topAxis",isCustomizable:true,dragDropText:a.panelTopFieldsText,flex:1}]}]}},getVerticalConfig:function(){var a=this;return{layout:{type:"hbox",align:"stretch"},minWidth:a.defaultMinWidth,headerPosition:a.dock=="right"?"left":"right",collapseDirection:a.dock,defaults:{flex:1},items:[{itemId:"fieldsCt",xtype:"pivotconfigcontainer",position:a.dock,title:a.panelAllFieldsTitle,isCustomizable:false,dragDropText:a.panelAllFieldsText,autoScroll:true,header:{cls:a.headerContainerCls},tools:a.collapsible?[{type:a.dock,handler:a.collapseMe,scope:a}]:[]},{xtype:"container",defaults:{xtype:"pivotconfigcontainer",flex:1,autoScroll:true,position:a.dock,header:{cls:a.headerContainerCls}},layout:{type:"vbox",align:"stretch"},items:[{itemId:"fieldsAggCt",title:a.panelAggFieldsTitle,isCustomizable:true,isAgg:true,dragDropText:a.panelAggFieldsText},{itemId:"fieldsLeftCt",title:a.panelLeftFieldsTitle,pivotField:"leftAxis",isCustomizable:true,dragDropText:a.panelLeftFieldsText},{itemId:"fieldsTopCt",title:a.panelTopFieldsTitle,pivotField:"topAxis",isCustomizable:true,dragDropText:a.panelTopFieldsText}]}]}},onConfigChanged:function(){var d=this,b=[],c=[],a=[];if(d.disabled){return}if(d.grid.fireEvent("configchange",d,{topAxis:d.getFieldsFromContainer(d.fieldsTopCt),leftAxis:d.getFieldsFromContainer(d.fieldsLeftCt),aggregate:d.getFieldsFromContainer(d.fieldsAggCt)})!==false){d.task.delay(d.refreshDelay)}},collapseMe:function(){this.collapse(this.dock)},getFieldsFromContainer:function(b,c){var a=[];b.items.each(function(d){a.push(d.dimension)});return a},onSortChanged:function(b,d){var c=this,a;if(c.disabled){return}a=c.grid[b.ownerCt.pivotField];Ext.each(a,function(e){if(e.dataIndex==b.dataIndex){e.direction=d;return false}});c.task.delay(c.refreshDelay)},onFilterChanged:function(c,b){var d=this,a;if(d.disabled){return}d.task.delay(d.refreshDelay)},initPivotFields:function(){var e=this,c=e.grid.getStore(),d=c?c.model:null,g,f,b,a;if(d!=e.lastModel){Ext.destroy(e.lastFields);delete (e.lastFields);e.lastModel=d}if(!e.lastFields){e.lastFields=e.fetchAllFieldConfigurations()}a=e.lastFields.clone();e.fieldsCt.removeAll();e.fieldsTopCt.removeAll();e.fieldsLeftCt.removeAll();e.fieldsAggCt.removeAll();g=e.getConfigFields(e.grid.topAxis);f=e.getConfigFields(e.grid.leftAxis);b=e.getConfigFields(e.grid.aggregate);Ext.each(Ext.Array.merge(g,f),function(j){var h,k=false;if(j.filter&&j.filter.dimensionId){for(h=0;h<b.length;h++){if(b[h].id==j.filter.dimensionId){k=true;break}}if(!k){delete j.filter}}a.removeAtKey(j.header);e.mergeFieldConfig(j)});Ext.each(b,e.mergeFieldConfig,e);Ext.suspendLayouts();e.addFieldsToConfigurator(a.getRange(),e.fieldsCt);e.addFieldsToConfigurator(g,e.fieldsTopCt);e.addFieldsToConfigurator(f,e.fieldsLeftCt);e.addFieldsToConfigurator(b,e.fieldsAggCt);e.fieldsTopCt.aggregateDimensions=b;e.fieldsLeftCt.aggregateDimensions=b;Ext.resumeLayouts(true)},mergeFieldConfig:function(b){var a=this.lastFields.getByKey(b.header),c;if(a){c=a.id;Ext.apply(a,b);a.id=c}},fetchAllFieldConfigurations:function(){var c=this,b=c.grid.getStore(),a=b?b.model.getFields():[],e=[],d;d=Ext.create("Ext.util.MixedCollection");d.getKey=function(f){return f.header};if(c.fields.length>0){e=c.fields}else{Ext.each(a,function(f){e.push({header:Ext.String.capitalize(f.name),dataIndex:f.name,direction:f.sortDir})})}Ext.each(e,function(f){f.id=f.id||Ext.id()});d.addAll(e);return d},addFieldsToConfigurator:function(a,b){Ext.each(a,function(e,d,c){b.addColumn(e,-1)})},getConfigFields:function(c){var b=this,a=[];Ext.each(c,function(e){var d=Ext.clone(e);d.id=d.id||Ext.id();if(!b.lastFields.getByKey(d.header)){b.lastFields.add(d)}a.push(d)});return a},placeholderCollapse:function(f,a){var d=this,c=d.ownerCt,h=f||d.collapseDirection,b=Ext.panel.Panel.floatCls,g=d.getPlaceholder(h),e;d.isCollapsingOrExpanding=1;d.setHiddenState(true);d.collapsed=h;if(g.rendered){if(g.el.dom.parentNode!==d.el.dom.parentNode){d.el.dom.parentNode.insertBefore(g.el.dom,d.el.dom)}g.hidden=false;g.setHiddenState(false);g.el.show();c.updateLayout()}else{if(d.dock){g.dock=d.dock;c.addDocked(g)}else{c.insert(c.items.indexOf(d),g)}}if(d.rendered){if(Ext.ComponentManager.getActiveComponent()===d.collapseTool){d.focusPlaceholderExpandTool=true}d.el.setVisibilityMode(d.placeholderCollapseHideMode);if(a){d.el.addCls(b);g.el.hide();e=d.convertCollapseDir(h);d.el.slideOut(e,{preserveScroll:true,duration:Ext.Number.from(a,Ext.fx.Anim.prototype.duration),listeners:{scope:d,afteranimate:function(){var i=this;i.el.removeCls(b);i.placeholder.el.show().setStyle("display","none").slideIn(e,{easing:"linear",duration:100,listeners:{afteranimate:i.doPlaceholderCollapse,scope:i}})}}})}else{d.el.hide();d.doPlaceholderCollapse()}}else{d.isCollapsingOrExpanding=0;if(!d.preventCollapseFire){d.fireEvent("collapse",d)}}return d},placeholderExpand:function(c){var e=this,g=e.collapsed,h=e.placeholder.expandTool,d=Ext.panel.Panel.floatCls,b=e.ownerLayout?e.ownerLayout.centerRegion:null,f,a;if(Ext.Component.layoutSuspendCount){c=false}if(e.floatedFromCollapse){a=e.getPosition(true);e.slideOutFloatedPanelBegin();e.slideOutFloatedPanelEnd();e.floated=false}if(Ext.ComponentManager.getActiveComponent()===h){e.focusHeaderCollapseTool=true;h._ariaRole=h.ariaEl.dom.getAttribute("role");h._ariaLabel=h.ariaEl.dom.getAttribute("aria-label");h.ariaEl.dom.setAttribute("role","presentation");h.ariaEl.dom.removeAttribute("aria-label")}if(c){Ext.suspendLayouts();e.placeholder.hide();e.el.show();e.collapsed=false;e.setHiddenState(false);if(b&&!a){b.hidden=true}Ext.resumeLayouts(true);if(b){b.hidden=false}e.el.addCls(d);e.isCollapsingOrExpanding=2;if(a){f=e.getXY();e.setLocalXY(a[0],a[1]);e.setXY([f[0],f[1]],{duration:Ext.Number.from(c,Ext.fx.Anim.prototype.duration),listeners:{scope:e,afteranimate:function(){var i=this;i.el.removeCls(d);i.isCollapsingOrExpanding=0;i.fireEvent("expand",i)}}})}else{e.el.hide();e.placeholder.el.show();e.placeholder.hidden=false;e.setHiddenState(false);e.el.slideIn(e.convertCollapseDir(g),{preserveScroll:true,duration:Ext.Number.from(c,Ext.fx.Anim.prototype.duration),listeners:{afteranimate:e.doPlaceholderExpand,scope:e}})}}else{e.floated=e.collapsed=false;e.doPlaceholderExpand(true)}return e}});