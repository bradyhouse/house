Ext.define("Ext.pivot.plugin.configurator.Column",{extend:"Ext.Component",requires:["Ext.menu.Menu","Ext.pivot.plugin.configurator.FilterLabelWindow","Ext.pivot.plugin.configurator.FilterValueWindow","Ext.pivot.plugin.configurator.FilterTopWindow"],alias:"widget.pivotconfigcolumn",childEls:["textCol","filterCol","sortCol"],renderTpl:'<div id="{id}-configCol" class="'+Ext.baseCSSPrefix+'pivot-grid-config-column-inner"><tpl if="isCustomizable"><span id={id}-customCol class="'+Ext.baseCSSPrefix+"pivot-grid-config-column-btn-customize "+Ext.baseCSSPrefix+"border-box "+Ext.baseCSSPrefix+"pivot-grid-config-column-btn "+Ext.baseCSSPrefix+'pivot-grid-config-column-btn-image"></span></tpl><span id={id}-sortCol data-ref="sortCol" class="'+Ext.baseCSSPrefix+"border-box "+Ext.baseCSSPrefix+'pivot-grid-config-column-btn"></span><span id={id}-filterCol data-ref="filterCol" class="'+Ext.baseCSSPrefix+"border-box "+Ext.baseCSSPrefix+'pivot-grid-config-column-btn"></span><span id="{id}-textCol" data-ref="textCol" data-qtip="{header}{aggregator}" class="'+Ext.baseCSSPrefix+"pivot-grid-config-column-text "+Ext.baseCSSPrefix+"column-header-text "+Ext.baseCSSPrefix+'border-box">{header}{aggregator}</span></div>',header:"&#160;",isCustomizable:false,dimension:null,isAgg:false,sumText:"Sum",avgText:"Avg",countText:"Count",minText:"Min",maxText:"Max",groupSumPercentageText:"Group sum percentage",groupCountPercentageText:"Group count percentage",varText:"Var",varPText:"Varp",stdDevText:"StdDev",stdDevPText:"StdDevp",sortAscText:"Sort A to Z",sortDescText:"Sort Z to A",sortClearText:"Disable sorting",clearFilterText:'Clear filter from "{0}"',labelFiltersText:"Label filters",valueFiltersText:"Value filters",equalsText:"Equals...",doesNotEqualText:"Does not equal...",beginsWithText:"Begins with...",doesNotBeginWithText:"Does not begin with...",endsWithText:"Ends with...",doesNotEndWithText:"Does not end with...",containsText:"Contains...",doesNotContainText:"Does not contain...",greaterThanText:"Greater than...",greaterThanOrEqualToText:"Greater than or equal to...",lessThanText:"Less than...",lessThanOrEqualToText:"Less than or equal to...",betweenText:"Between...",notBetweenText:"Not between...",top10Text:"Top 10...",equalsLText:"equals",doesNotEqualLText:"does not equal",beginsWithLText:"begins with",doesNotBeginWithLText:"does not begin with",endsWithLText:"ends with",doesNotEndWithLText:"does not end with",containsLText:"contains",doesNotContainLText:"does not contain",greaterThanLText:"is greater than",greaterThanOrEqualToLText:"is greater than or equal to",lessThanLText:"is less than",lessThanOrEqualToLText:"is less than or equal to",betweenLText:"is between",notBetweenLText:"is not between",top10LText:"Top 10...",topOrderTopText:"Top",topOrderBottomText:"Bottom",topTypeItemsText:"Items",topTypePercentText:"Percent",topTypeSumText:"Sum",baseCls:Ext.baseCSSPrefix+"pivot-grid-config-column",btnIconCls:Ext.baseCSSPrefix+"pivot-grid-config-column-btn-image",setFilterIconCls:Ext.baseCSSPrefix+"pivot-grid-config-column-btn-filter-set",clearFilterIconCls:Ext.baseCSSPrefix+"pivot-grid-config-column-btn-filter-clear",ascSortIconCls:Ext.baseCSSPrefix+"pivot-grid-config-column-btn-sort-asc",descSortIconCls:Ext.baseCSSPrefix+"pivot-grid-config-column-btn-sort-desc",clearSortIconCls:Ext.baseCSSPrefix+"pivot-grid-config-column-btn-sort-clear",destroy:function(){var a=this;Ext.destroyMembers(a,"relayers","menu");a.dimension=a.relayers=a.menu=null;a.callParent(arguments)},initRenderData:function(){var a=this;return Ext.apply(a.callParent(arguments),{header:a.dimension.header,aggregator:a.isAgg?" ("+a.dimension.aggregator+")":"",dimension:a.dimension,isCustomizable:a.isCustomizable})},afterRender:function(){var a=this;a.callParent();if(a.isCustomizable){if(!a.isAgg&&(!Ext.isDefined(a.dimension.sortable)||a.dimension.sortable)){a.addSortCls(a.dimension.direction)}if(a.dimension.filter){a.addFilterCls()}a.mon(a.getTargetEl(),{scope:a,click:a.handleColClick})}},handleColClick:function(c,a){var b=this;if(b.isAgg){b.showAggMenu();c.stopEvent()}else{b.showColMenu()}},handleMenuClick:function(b,c){var a=this,d;a.dimension.aggregator=b.aggregator;if(a.textCol){d=a.textCol.setHtml?"setHtml":"setHTML";a.textCol[d](a.header+" ("+a.dimension.aggregator+")")}a.ownerCt.updateLayout();a.fireEvent("configchange")},addSortCls:function(b){var a=this;if(!a.sortCol){return}if(b==="ASC"||!b){a.sortCol.addCls(a.ascSortIconCls);a.sortCol.removeCls(a.descSortIconCls)}else{a.sortCol.addCls(a.descSortIconCls);a.sortCol.removeCls(a.ascSortIconCls)}a.sortCol.addCls(a.btnIconCls)},removeSortCls:function(b){var a=this;if(!a.sortCol){return}if(b==="ASC"){a.sortCol.removeCls(a.ascSortIconCls)}else{a.sortCol.removeCls(a.descSortIconCls)}a.sortCol.removeCls(a.btnIconCls)},addFilterCls:function(){var a=this;if(a.filterCol&&!a.filterCol.hasCls(a.setFilterIconCls)){a.filterCol.addCls(a.setFilterIconCls);a.filterCol.addCls(a.btnIconCls)}},removeFilterCls:function(){var a=this;if(a.filterCol){a.filterCol.removeCls(a.setFilterIconCls);a.filterCol.removeCls(a.btnIconCls)}},serialize:function(){var a=this;return Ext.applyIf({idColumn:a.id},a.initialConfig)},showAggMenu:function(){var a=this,b=a.dimension.aggregator;Ext.destroy(a.menu);a.menu=Ext.create("Ext.menu.Menu",{floating:true,defaults:{handler:a.handleMenuClick,scope:a,xtype:"menucheckitem",group:"aggregator"},items:[{text:a.sumText,aggregator:"sum",checked:b=="sum"},{text:a.avgText,aggregator:"avg",checked:b=="avg"},{text:a.countText,aggregator:"count",checked:b=="count"},{text:a.maxText,aggregator:"max",checked:b=="max"},{text:a.minText,aggregator:"min",checked:b=="min"},{text:a.groupSumPercentageText,aggregator:"groupSumPercentage",checked:b=="groupSumPercentage"},{text:a.groupCountPercentageText,aggregator:"groupCountPercentage",checked:b=="groupCountPercentage"},{text:a.stdDevText,aggregator:"stdDev",checked:b=="stdDev"},{text:a.stdDevPText,aggregator:"stdDevP",checked:b=="stdDevP"},{text:a.varText,aggregator:"variance",checked:b=="variance"},{text:a.varPText,aggregator:"varianceP",checked:b=="varianceP"}]});a.menu.showBy(a)},showColMenu:function(){var e=this,b=[],g,f,a,c,d=e.dimension.filter;Ext.destroy(e.menu);b.push({text:e.sortAscText,direction:"ASC",iconCls:e.ascSortIconCls,handler:e.sortMe},{text:e.sortDescText,direction:"DESC",iconCls:e.descSortIconCls,handler:e.sortMe},{text:e.sortClearText,direction:"",disabled:e.dimension.sortable===false,iconCls:e.clearSortIconCls,handler:e.sortMe},{xtype:"menuseparator"});a=[{text:e.equalsText,operator:"="},{text:e.doesNotEqualText,operator:"!="},{xtype:"menuseparator"},{text:e.greaterThanText,operator:">"},{text:e.greaterThanOrEqualToText,operator:">="},{text:e.lessThanText,operator:"<"},{text:e.lessThanOrEqualToText,operator:"<="},{xtype:"menuseparator"},{text:e.betweenText,operator:"between"},{text:e.notBetweenText,operator:"not between"}];g=Ext.clone(a);Ext.Array.insert(g,3,[{text:e.beginsWithText,operator:"begins"},{text:e.doesNotBeginWithText,operator:"not begins"},{text:e.endsWithText,operator:"ends"},{text:e.doesNotEndWithText,operator:"not ends"},{xtype:"menuseparator"},{text:e.containsText,operator:"contains"},{text:e.doesNotContainText,operator:"not contains"},{xtype:"menuseparator"}]);for(c=0;c<g.length;c++){g[c]["checked"]=(d&&d.type=="label"&&d.operator==g[c].operator)}f=Ext.clone(a);f.push({xtype:"menuseparator"},{text:e.top10Text,operator:"top10"});for(c=0;c<f.length;c++){f[c]["checked"]=(d&&d.type=="value"&&d.operator==f[c].operator)}b.push({text:Ext.String.format(e.clearFilterText,e.header),iconCls:e.clearFilterIconCls,disabled:!d,handler:e.onRemoveFilter},{text:e.labelFiltersText,menu:{defaults:{handler:e.onShowFilter,scope:e,xtype:"menucheckitem",group:"filterlabel",type:"label"},items:g}},{text:e.valueFiltersText,menu:{defaults:{handler:e.onShowFilter,scope:e,xtype:"menucheckitem",group:"filtervalue",type:"value"},items:f}});e.menu=Ext.create("Ext.menu.Menu",{floating:true,defaults:{scope:e},items:b});e.menu.showBy(e)},sortMe:function(a){var b=this;if(Ext.isEmpty(a.direction)){b.dimension.sortable=false;b.removeSortCls(b.dimension.direction)}else{b.dimension.sortable=true;b.addSortCls(a.direction);b.dimension.direction=a.direction}b.fireEvent("sortchange",b,a.direction)},onShowFilter:function(b){var h=this,g,f,c={},e,d,a=h.dimension.filter,i={type:b.type,operator:b.operator,value:(a?a.value:""),from:(a?(Ext.isArray(a.value)?a.value[0]:""):""),to:(a?(Ext.isArray(a.value)?a.value[1]:""):""),caseSensitive:(a?a.caseSensitive:false),topSort:(a?a.topSort:false)};d=[];Ext.each(h.ownerCt.aggregateDimensions,function(j){d.push([j.header,j.id])});if(b.type=="label"||(b.type=="value"&&b.operator!="top10")){e=[[h.equalsLText,"="],[h.doesNotEqualLText,"!="],[h.greaterThanLText,">"],[h.greaterThanOrEqualToLText,">="],[h.lessThanLText,"<"],[h.lessThanOrEqualToLText,"<="],[h.betweenLText,"between"],[h.notBetweenLText,"not between"]];if(b.type=="label"){Ext.Array.insert(e,3,[[h.beginsWithLText,"begins"],[h.doesNotBeginWithLText,"not begins"],[h.endsWithLText,"ends"],[h.doesNotEndWithLText,"not ends"],[h.containsLText,"contains"],[h.doesNotContainLText,"not contains"]]);f="Ext.pivot.plugin.configurator.FilterLabelWindow"}else{f="Ext.pivot.plugin.configurator.FilterValueWindow";Ext.apply(i,{dimensionId:(a?a.dimensionId:"")});c.storeAgg=Ext.create("Ext.data.ArrayStore",{fields:["text","value"],data:d})}c.store=Ext.create("Ext.data.ArrayStore",{fields:["text","value"],data:e})}else{f="Ext.pivot.plugin.configurator.FilterTopWindow";e=[];Ext.apply(c,{storeTopOrder:Ext.create("Ext.data.ArrayStore",{fields:["text","value"],data:[[h.topOrderTopText,"top"],[h.topOrderBottomText,"bottom"]]}),storeTopType:Ext.create("Ext.data.ArrayStore",{fields:["text","value"],data:[[h.topTypeItemsText,"items"],[h.topTypePercentText,"percent"],[h.topTypeSumText,"sum"]]}),storeAgg:Ext.create("Ext.data.ArrayStore",{fields:["text","value"],data:d})});Ext.apply(i,{operator:"top10",dimensionId:(a?a.dimensionId:""),topType:(a?a.topType:"items"),topOrder:(a?a.topOrder:"top")})}g=Ext.create(f,Ext.apply(c||{},{title:h.header,listeners:{filter:h.onApplyFilter,scope:h}}));g.down("form").getForm().setValues(i);g.show()},onApplyFilter:function(c,a){var b=this;a.caseSensitive=(a.caseSensitive==="on");a.topSort=(a.topSort==="on");c.close();b.addFilterCls();b.dimension.filter=a;b.fireEvent("filterchange",b,a)},onRemoveFilter:function(){var a=this;a.removeFilterCls();a.dimension.filter=null;a.fireEvent("filterchange",a,null)}});