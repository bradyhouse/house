Ext.define("Ext.pivot.plugin.Exporter",{alternateClassName:["Mz.pivot.plugin.ExcelExport"],alias:["plugin.pivotexporter","plugin.mzexcelexport"],extend:"Ext.AbstractPlugin",requires:["Ext.exporter.Excel"],lockableScope:"top",init:function(a){var b=this;if(!a.isPivotGrid){Ext.raise("This plugin is only compatible with Ext.pivot.Grid")}a.saveDocumentAs=Ext.bind(b.saveDocumentAs,b);a.getDocumentData=Ext.bind(b.getDocumentData,b);b.pivot=a;return b.callParent(arguments)},destroy:function(){var a=this;a.pivot.saveDocumentAs=a.pivot.getDocumentData=a.pivot=a.matrix=null;return a.callParent(arguments)},saveDocumentAs:function(a){var b;if(this.disabled){return}b=this.getExporter.apply(this,arguments);b.saveAs();Ext.destroy(b)},getDocumentData:function(b){var c,a;if(this.disabled){return}c=this.getExporter.apply(this,arguments);a=c.getContent();Ext.destroy(c);return a},getExporter:function(a){var b=this;a=a||{};b.matrix=b.pivot.getMatrix();b.onlyExpandedNodes=a.onlyExpandedNodes;delete (a.onlyExpandedNodes);return Ext.Factory.exporter(Ext.apply({type:"excel",data:b.prepareData()},a))},prepareData:function(){var f=this,c=f.matrix,g,e,h,b,d,a;if(!f.onlyExpandedNodes){f.setColumnsExpanded(c.topAxis.getTree(),true)}e=Ext.clone(c.getColumnHeaders());h=f.getColumnHeaders(e);a=f.getDataIndexColumns(e);if(!f.onlyExpandedNodes){f.setColumnsExpanded(c.topAxis.getTree())}g=f.extractGroups(c.leftAxis.getTree(),a);Ext.apply(g,{summary:[],text:""});g.summary.push(c.textGrandTotalTpl);b=c.preparePivotStoreRecordData({key:c.grandTotalKey});for(d=1;d<a.length;d++){g.summary.push(b[a[d]]||"")}return{columns:h,groups:[g]}},setColumnsExpanded:function(b,a){for(var c=0;c<b.length;c++){if(Ext.isDefined(a)){b[c].backupExpanded=b[c].expanded;b[c].expanded=a}else{b[c].expanded=b[c].backupExpanded;b[c].backupExpanded=null}if(b[c].children){this.setColumnsExpanded(b[c].children,a)}}},getColumnHeaders:function(b){var d=[],a,c;for(a=0;a<b.length;a++){c={text:b[a].text};if(b[a].columns){c.columns=this.getColumnHeaders(b[a].columns)}d.push(c)}return d},getDataIndexColumns:function(b){var c=[],a;for(a=0;a<b.length;a++){if(b[a].dataIndex){c.push(b[a].dataIndex)}else{if(Ext.isArray(b[a].columns)){c=Ext.Array.merge(c,this.getDataIndexColumns(b[a].columns))}}}return c},extractGroups:function(f,a){var g=this,h={},c,b,e,k,l,d;for(c=0;c<f.length;c++){k=f[c];if(k.record){h.rows=h.rows||[];l=[];for(b=0;b<a.length;b++){l.push(k.record.get(a[b])||"")}h.rows.push(l)}else{if(k.children){h.groups=h.groups||[];l={};e=g.onlyExpandedNodes?k.expanded:true;if(e){l=g.extractGroups(k.children,a)}Ext.apply(l,{summary:[],text:k.name});l.summary.push(k.getTextTotal());d=g.matrix.preparePivotStoreRecordData(k);for(b=1;b<a.length;b++){l.summary.push(d[a[b]]||"")}h.groups.push(l)}}}return h}});