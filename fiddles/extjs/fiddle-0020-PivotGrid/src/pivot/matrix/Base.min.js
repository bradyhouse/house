Ext.define("Ext.pivot.matrix.Base",{alternateClassName:["Mz.aggregate.matrix.Abstract"],extend:"Ext.util.Observable",alias:"pivotmatrix.base",mixins:["Ext.mixin.Factoryable"],requires:["Ext.util.DelayedTask","Ext.data.ArrayStore","Ext.XTemplate","Ext.pivot.Aggregators","Ext.pivot.MixedCollection","Ext.pivot.axis.Base","Ext.pivot.dimension.Item","Ext.pivot.result.Collection"],resultType:"base",leftAxisType:"base",topAxisType:"base",textRowLabels:"Row labels",textTotalTpl:"Total ({name})",textGrandTotalTpl:"Grand total",keysSeparator:"#_#",grandTotalKey:"grandtotal",compactViewKey:"_compactview_",viewLayoutType:"outline",rowSubTotalsPosition:"first",rowGrandTotalsPosition:"first",colSubTotalsPosition:"first",colGrandTotalsPosition:"first",showZeroAsBlank:false,leftAxis:null,topAxis:null,aggregate:null,results:null,pivotStore:null,isDestroyed:false,constructor:function(b){var a=this.callParent(arguments);this.initialize(true,b);return a},destroy:function(){var a=this;a.delayedTask.cancel();a.delayedTask=null;if(Ext.isFunction(a.onDestroy)){a.onDestroy()}Ext.destroy(a.results,a.leftAxis,a.topAxis,a.aggregate,a.pivotStore);a.results=a.leftAxis=a.topAxis=a.aggregate=a.pivotStore=null;if(Ext.isArray(a.columns)){a.columns.length=0}if(Ext.isArray(a.model)){a.model.length=0}if(Ext.isArray(a.totals)){a.totals.length=0}a.columns=a.model=a.totals=a.keysMap=null;a.isDestroyed=true;a.callParent(arguments)},getKey:function(b){var a=this;a.keysMap=a.keysMap||{};if(!Ext.isDefined(a.keysMap[b])){a.keysMap[b]=Ext.id()}return a.keysMap[b]},naturalSort:(function(){var d=/(^([+\-]?(?:\d*)(?:\.\d*)?(?:[eE][+\-]?\d+)?)?$|^0x[\da-fA-F]+$|\d+)/g,f=/^\s+|\s+$/g,c=/\s+/g,b=/(^([\w ]+,?[\w ]+)?[\w ]+,?[\w ]+\d+:\d+(:\d+)?[\w ]?|^\d{1,4}[\/\-]\d{1,4}[\/\-]\d{1,4}|^\w+, \w+ \d+, \d{4})/,e=/^0x[0-9a-f]+$/i,a=/^0/,g=function(i,h){i=i||"";return(!i.match(a)||h==1)&&parseFloat(i)||i.replace(c," ").replace(f,"")||0};return function(q,o){var r=String(q instanceof Date?q.getTime():(q||"")).replace(f,""),n=String(o instanceof Date?o.getTime():(o||"")).replace(f,""),t=r.replace(d,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),l=n.replace(d,"\0$1\0").replace(/\0$/,"").replace(/^\0/,"").split("\0"),j=parseInt(r.match(e),16)||(t.length!==1&&Date.parse(r)),u=parseInt(n.match(e),16)||j&&n.match(b)&&Date.parse(n)||null,s,m;if(u){if(j<u){return -1}else{if(j>u){return 1}}}for(var p=0,i=t.length,k=l.length,h=Math.max(i,k);p<h;p++){s=g(t[p],i);m=g(l[p],k);if(isNaN(s)!==isNaN(m)){return(isNaN(s))?1:-1}else{if(typeof s!==typeof m){s+="";m+=""}}if(s<m){return -1}if(s>m){return 1}}return 0}}()),initialize:function(e,a){var d=this,c=["viewLayoutType","rowSubTotalsPosition","rowGrandTotalsPosition","colSubTotalsPosition","colGrandTotalsPosition","showZeroAsBlank"],b;d.initResults();d.initAggregates(a.aggregate||[]);d.initAxis(a.leftAxis||[],a.topAxis||[]);for(b=0;b<c.length;b++){if(a.hasOwnProperty(c[b])){d[c[b]]=a[c[b]]}}d.totals=[];d.keysMap=null;if(e){d.pivotStore=Ext.create("Ext.data.ArrayStore",{autoDestroy:false,fields:[]});d.delayedTask=new Ext.util.DelayedTask(d.startProcess,d);if(Ext.isFunction(d.onInitialize)){d.onInitialize()}}},onInitialize:Ext.emptyFn,onDestroy:Ext.emptyFn,reconfigure:function(a){var b=this,a=Ext.clone(a||{});b.initialize(false,a);b.clearData();if(Ext.isFunction(b.onReconfigure)){b.onReconfigure(a)}b.delayedTask.delay(5)},onReconfigure:Ext.emptyFn,initResults:function(){Ext.destroy(this.results);this.results=Ext.create("Ext.pivot.result.Collection",{resultType:this.resultType,matrix:this})},initAggregates:function(d){var c=this,a,b;Ext.destroy(c.aggregate);c.aggregate=Ext.create("Ext.pivot.MixedCollection");c.aggregate.getKey=function(e){return e.getId()};if(Ext.isEmpty(d)){return}d=Ext.Array.from(d);for(a=0;a<d.length;a++){b=d[a];Ext.applyIf(b,{isAggregate:true,align:"right",showZeroAsBlank:c.showZeroAsBlank});c.aggregate.add(Ext.create("Ext.pivot.dimension.Item",b))}},initAxis:function(c,a){var b=this;c=Ext.Array.from(c||[]);a=Ext.Array.from(a||[]);Ext.destroy(b.leftAxis);b.leftAxis=Ext.Factory.pivotaxis({type:b.leftAxisType,matrix:b,dimensions:c,isLeftAxis:true});Ext.destroy(b.topAxis);b.topAxis=Ext.Factory.pivotaxis({type:b.topAxisType,matrix:b,dimensions:a,isLeftAxis:false})},clearData:function(){var a=this;a.fireEvent("cleardata",a);a.leftAxis.clear();a.topAxis.clear();a.results.clear();if(Ext.isArray(a.columns)){a.columns.length=0}if(Ext.isArray(a.model)){a.model.length=0}a.totals=[];a.keysMap=null;if(a.pivotStore){a.pivotStore.removeAll(true)}},startProcess:Ext.emptyFn,endProcess:function(){var a=this;a.leftAxis.getTree();a.topAxis.getTree();a.buildModelAndColumns();a.buildPivotStore();if(Ext.isFunction(a.onBuildStore)){a.onBuildStore(a.pivotStore)}a.fireEvent("storebuilt",a,a.pivotStore);a.fireEvent("done")},onBuildModel:Ext.emptyFn,onBuildColumns:Ext.emptyFn,onBuildRecord:Ext.emptyFn,onBuildTotals:Ext.emptyFn,onBuildStore:Ext.emptyFn,buildModelAndColumns:function(){var a=this;a.model=[{name:"id",type:"string"}];a.buildColumnHeaders(false)},buildColumnHeaders:function(a){var b=this;b.internalCounter=0;b.columns=[];if(b.viewLayoutType=="compact"){b.generateCompactLeftAxis(a)}else{b.leftAxis.dimensions.each(function(c){this.parseLeftAxisDimension(c,a)},b)}if(b.colGrandTotalsPosition=="first"){b.columns.push(b.parseAggregateForColumn(null,{text:b.textGrandTotalTpl,grandTotal:true},a))}Ext.Array.each(b.topAxis.getTree(),function(c){this.parseTopAxisItem(c,a)},b);if(b.colGrandTotalsPosition=="last"){b.columns.push(b.parseAggregateForColumn(null,{text:b.textGrandTotalTpl,grandTotal:true},a))}if(!a){if(Ext.isFunction(b.onBuildModel)){b.onBuildModel(b.model)}b.fireEvent("modelbuilt",b,b.model)}if(Ext.isFunction(b.onBuildColumns)){b.onBuildColumns(b.columns)}b.fireEvent("columnsbuilt",b,b.columns)},parseLeftAxisDimension:function(b,a){if(!a){this.model.push({name:b.getId(),type:"string"})}this.columns.push({dataIndex:b.getId(),text:b.header,dimension:b,leftAxis:true})},generateCompactLeftAxis:function(a){var b=this;if(!a){b.model.push({name:b.compactViewKey,type:"string"})}b.columns.push({dataIndex:b.compactViewKey,text:b.textRowLabels,leftAxis:true,width:200})},parseTopAxisItem:function(f,a){var e=this,c=[],b=[],h,d,g=false;if(!f.children){c=e.parseAggregateForColumn(f,null,a);if(f.level===0){e.columns.push(c)}else{return c}}else{if(e.colSubTotalsPosition=="first"){d=e.addColSummary(f,a,true);if(d){b.push(d)}}Ext.Array.each(f.children,function(j){var i=e.parseTopAxisItem(j,a);if(Ext.isArray(i)){c=Ext.Array.merge(c,i)}else{c.push(i)}});if(f.expanded||!a){h={text:f.name,columns:c,key:f.key,xcollapsible:f.expanded,xexpanded:f.expanded,xexpandable:true};if(f.level===0){e.columns.push(h)}b.push(h)}if(e.colSubTotalsPosition=="last"){d=e.addColSummary(f,a,true);if(d){b.push(d)}}if(e.colSubTotalsPosition=="none"){d=e.addColSummary(f,a,false);if(d){b.push(d)}}return b}},addColSummary:function(d,a,f){var c=this,b,e=false;b=c.parseAggregateForColumn(d,{text:d.expanded?d.getTextTotal():d.name,subTotal:true},a);if(f){e=true}else{e=!d.expanded}if(e){if(d.level===0){c.columns.push(b)}Ext.apply(b,{key:d.key,xcollapsible:!d.expanded,xexpanded:d.expanded,xexpandable:!d.expanded});return b}},parseAggregateForColumn:function(f,b,a){var e=this,c=[],d={};e.aggregate.each(function(g){e.internalCounter++;if(!a){e.model.push({name:"c"+e.internalCounter,type:"auto",defaultValue:undefined,useNull:true,col:f?f.key:e.grandTotalKey,agg:g.getId()})}c.push({dataIndex:"c"+e.internalCounter,text:g.header,topAxis:true,subTotal:(b?b.subTotal===true:false),grandTotal:(b?b.grandTotal===true:false),dimension:g})});if(c.length==0&&e.aggregate.getCount()==0){e.internalCounter++;d=Ext.apply({text:f?f.name:"",dataIndex:"c"+e.internalCounter},b||{})}else{if(c.length==1){d=Ext.applyIf({text:f?f.name:""},c[0]);Ext.apply(d,b||{});if(b&&b.grandTotal&&e.aggregate.getCount()==1){d.text=e.aggregate.getAt(0).header||b.text}}else{d=Ext.apply({text:f?f.name:"",columns:c},b||{})}}return d},buildPivotStore:function(){var a=this;if(Ext.isFunction(a.pivotStore.model.setFields)){a.pivotStore.model.setFields(a.model)}else{a.pivotStore.model.replaceFields(a.model,true)}a.pivotStore.removeAll(true);Ext.Array.each(a.leftAxis.getTree(),a.addRecordToPivotStore,a);a.addGrandTotalsToPivotStore()},addGrandTotalsToPivotStore:function(){var b=this,a=[];a.push({title:b.textGrandTotalTpl,values:b.preparePivotStoreRecordData({key:b.grandTotalKey})});if(Ext.isFunction(b.onBuildTotals)){b.onBuildTotals(a)}b.fireEvent("buildtotals",b,a);Ext.Array.forEach(a,function(c){if(Ext.isObject(c)&&Ext.isObject(c.values)){b.totals.push({title:c.title||"",record:b.pivotStore.add(c.values)[0]})}})},addRecordToPivotStore:function(c){var b=this,a;if(!c.children){a=b.pivotStore.add(b.preparePivotStoreRecordData(c));c.record=a[0];if(Ext.isFunction(b.onBuildRecord)){b.onBuildRecord(a[0])}b.fireEvent("recordbuilt",b,a[0])}else{Ext.Array.each(c.children,function(d){b.addRecordToPivotStore(d)})}},preparePivotStoreRecordData:function(c){var a=this,b={};b.id=c.key;Ext.apply(b,c.data||{});Ext.Array.each(a.model,function(e){var d;if(e.col&&e.agg){d=a.results.get(c.key,e.col);if(d){b[e.name]=d.getValue(e.agg)}}});if(a.viewLayoutType=="compact"){b[a.compactViewKey]=c.name}return b},getColumns:function(){return this.model},getColumnHeaders:function(){var a=this;if(!a.model){a.buildModelAndColumns()}else{a.buildColumnHeaders(true)}return a.columns},isGroupRow:function(a){var b=this.leftAxis.findTreeElement("key",a);if(!b){return false}return(b.node.children&&b.nodel.children.length==0)?0:b.level},isGroupCol:function(a){var b=this.topAxis.findTreeElement("key",a);if(!b){return false}return(b.node.children&&b.node.children.length==0)?0:b.level},deprecated:{"6.0":{properties:{mztype:"type",mztypeLeftAxis:"leftAxisType",mztypeTopAxis:"topAxisType"}}}});